/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
import{communicate as e}from"./communicate.js";import{util as t}from"./util.js";import{analytics as o,events as n}from"../common/analytics.js";import{SETTINGS as a}from"./settings.js";import{dcLocalStorage as s,dcSessionStorage as i}from"../common/local-storage.js";import{floodgate as r}from"./floodgate.js";import{privateApi as l}from"./private-api.js";import{common as c}from"./common.js";import{userSubscription as m}from"./user-subscription.js";import{userDetailsAcrobat as d}from"./acrobatUserDetails.js";import{ADD_WEBPAGE_TO_PROJECT_CONTEXT_MENU_TP_CTX as u,downloadBannerExcludeList as p,LOCAL_FTE_WINDOW as g,ONE_DAY_IN_MS as I}from"../common/constant.js";import{CACHE_PURGE_SCHEME as h,EXPRESS as f}from"./constant.js";import{versionChecks as E}from"./handleVersionChecks.js";import{sendPingEventHandler as w,registerUninstallUrl as _}from"../common/util.js";import{loggingApi as T}from"../common/loggingApi.js";import{offscreenActions as N}from"./offscreen-actions.js";import{viewerModuleUtils as L}from"./viewer-module-utils.js";import{launchExpress as C,toggleExpressTouchpoints as A}from"./express.js";import{indexedDBScript as O}from"../common/indexDB.js";import{floodgateMigration as S}from"./floodgateMigration.js";import{setExperimentCodeForAnalytics as F}from"../common/experimentUtils.js";import{toggleAddWebpageToProjectContextMenu as v,handleAddWebpageToProjectContextMenu as b}from"./add-webpage-to-project.js";var D,P,R=new Promise((function(e){P=e})),M={},y=()=>e.getModule("acro-web2pdf"),U=()=>e.getModule("acro-gstate"),x=["http://*/*","https://*/*"];const B="Error in Local File Prompt";async function W(){!async function(){const[e,t]=await Promise.all([chrome.tabs.query({url:"https://mail.google.com/*"}),chrome.tabs.query({url:"https://drive.google.com/*"})]);e?.length>0&&o.event("DCBrowserExt:ExtensionUpdate:Gmail:Open"),t?.length>0&&o.event("DCBrowserExt:ExtensionUpdate:GDrive:Open")}();for(const e of chrome.runtime.getManifest().content_scripts){const t=await chrome.tabs.query({url:e.matches});for(const o of t)(o.url.includes("mail.google.com")||o.url.includes("drive.google.com"))&&(e.css&&chrome.scripting.insertCSS({files:e.css,target:{tabId:o.id}}),chrome.scripting.executeScript({files:e.js,target:{tabId:o.id,allFrames:e.all_frames}}))}}async function V(e){try{if(chrome.sidePanel?.setOptions({enabled:!1}),!s.getItem("installUuid")){const e=t.generateUUID();s.setItem("installUuid",e)}e&&(e.reason===chrome.runtime.OnInstalledReason.UPDATE&&e.previousVersion!==chrome.runtime.getManifest().version?(t.verCmp(e.previousVersion,"15.1.3.30")<0&&await async function(){let e;try{const o=await chrome.tabs.query({});await Promise.allSettled(o.map((({id:e})=>chrome.scripting.executeScript({target:{tabId:e},files:["content_scripts/injectCopyLSIframe.js"]})))),await t.sleep(300),e=await chrome.runtime.sendMessage({main_op:"copy-ls"}),o.map((({id:e})=>chrome.tabs.sendMessage(e,{content_op:"remove-lsCopy"}).catch((()=>null))))}catch(e){}finally{"succeed"!==e?(s.setItem("retryOnNextPage",!0),o.event(o.e.LOCAL_STORAGE_MIGRATION_FAILED)):o.event(o.e.LOCAL_STORAGE_MIGRATION_SUCCESS)}}(),s.getItem("installVersion")||s.setItem("installVersion",e.previousVersion),s.setItem("installType",e.reason),s.getItem("thirdPartyCookieChecked")&&s.removeItem("thirdPartyCookieChecked"),s.getItem("tpcBlockAnalyticsEnable")&&s.removeItem("tpcBlockAnalyticsEnable")):e.reason===chrome.runtime.OnInstalledReason.INSTALL&&((()=>{const e=`https://chromewebstore.google.com/detail/*/${chrome.runtime.id}*`,t=`https://microsoftedge.microsoft.com/addons/detail/*/${chrome.runtime.id}*`;chrome.tabs.query({url:[e,t]},(e=>{if(chrome.runtime.lastError)D=null;else for(let t in e){const o=new URLSearchParams(new URL(e[t].url).search);if(o.has("mv")){D=encodeURIComponent(o.get("mv"));break}}}))})(),s.setItem("installVersion",chrome.runtime.getManifest().version),s.setItem("installType",e.reason)),s.getItem("offlineSupportDisable")||s.setItem("offlineSupportDisable",!0)),R.then((({env:t,msg:n})=>{const i=s.getItem("installSource");if(s.setItem("installSource",t.installType),_(),O.clearExpiredBlobBuffers()?.catch((e=>{T.error({message:"Failed to clear old file buffer entries on startup",error:e})})),O.clearFileHashOldEntries()?.catch((e=>{T.error({message:"Failed to clear old blob cache entries on startup",error:e})})),"true"===n.repromptDone&&o.event(o.e.EXTENSION_REPROMPT_TRACKING,{REASON:e.reason,TYPE:t.installType}),e.reason===chrome.runtime.OnInstalledReason.UPDATE&&e.previousVersion!==chrome.runtime.getManifest().version)W(),S.init(),o.event(o.e.EXTENSION_UPDATE,{installReason:e.reason,previousVersion:e.previousVersion||"none"}),Y(t,!0,i);else if(e.reason===chrome.runtime.OnInstalledReason.INSTALL||e.previousVersion===chrome.runtime.getManifest().version){switch(W(),o.event(o.e.EXTENSION_INSTALLED,{installReason:e.reason,previousVersion:e.previousVersion||"none"}),o.logEventOnce(o.e.EXTENSION_INSTALLED_NEW,{storageKey:"installAnalyticsLogged",installReason:e.reason,previousVersion:e.previousVersion||"none"}),t.installType){case"admin":o.event(o.e.EXTENSION_INSTALLED_ADMIN);break;case"development":o.event(o.e.EXTENSION_INSTALLED_DEVELOPMENT);break;case"other":o.event(o.e.EXTENSION_INSTALLED_OTHER);break;case"normal":l.isInstalledViaUpsell().then((e=>{if(e)o.event(o.e.EXTENSION_INSTALLED_UPSELL);else{o.event(o.e.EXTENSION_INSTALLED_DIRECT);let e="store_direct";D&&(e=decodeURIComponent(D)),o.event(o.e.EXTENSION_INSTALLED_SOURCE,{SOURCE:e})}}));break;case"sideload":o.event(o.e.EXTENSION_INSTALLED_SIDE_LOADED),n.installMonth&&n.installYear?o.event(o.e.EXTENSION_INSTALLED_SIDE_LOADED_MONTH_YEAR,{MONTH:n.installMonth,YEAR:n.installYear}):o.event(o.e.EXTENSION_INSTALLED_SIDE_LOADED_MONTH_YEAR,{MONTH:"None",YEAR:"None"}),a.IS_READER&&o.event(o.e.EXTENSION_INSTALLED_SIDE_LOADED_SOURCE,{SOURCE:n.source});break;default:o.event(o.e.EXTENSION_INSTALLED_DEFAULT)}Y(t)}}))}catch(e){}}function k(){try{if(navigator.onLine||!1===s.getItem("offlineSupportDisable")){const e=s.getItem("pdfViewer"),t=s.getItem("killSwitch"),n=s.getItem("cdnUrl");"false"===e&&"on"===t&&async function(e){const t=new AbortController,o=t.signal;let n=!1;setTimeout((()=>{n||t.abort()}),5e3);const a=await fetch(e,{signal:o});if(n=!0,200===a.status)return await a.text();return new Error(a.statusText)}(n).then((e=>{-1===e.toString().indexOf("<meta name='killSwitch' content='off'/>")&&-1===e.toString().indexOf('<meta name="killSwitch" content="off"/>')||(s.setItem("pdfViewer",!0),l.setViewerState("enabled"),s.setItem("killSwitch","off"),o.event(o.e.VIEWER_KILL_SWITCH_OFF_SUCCESS))})).catch((e=>{o.event(o.e.VIEWER_KILL_SWITCH_OFF_FAILED)}))}}catch(e){o.event(o.e.VIEWER_KILL_SWITCH_OFF_FAILED)}}function j(e){return t&&t.isChromeOnlyMessage(e)&&t.isEdge()&&(e+="Edge"),t&&t.getTranslation?t.getTranslation(e):chrome.i18n.getMessage(e)}function H(e){return(e.title||j("web2pdfUntitledFileName")).replace(/[<>?:|\*"\/\\'&\.]/g,"")}function G(e,o){if(!e&&!o)return!1;try{const t=e.pageUrl||o.url,n=new URL(t);if(n.protocol&&["http:","https:"].includes(n.protocol))return!0}catch(e){t.consoleError(e)}return!1}async function X(e,t){chrome.tabs.sendMessage(t.id,{type:"removeActionableCoachmark"}),s.setItem("touchpoint",e.touchpoint),o.event(`${o.e.OPEN_SIDE_PANEL_RECIEIVED}:${e.touchpoint||"Unspecified"}`);try{await(chrome.sidePanel?.open({tabId:t.id})),T.info({message:"Opening sidepanel success",touchpoint:e.touchpoint})}catch(t){T.error({message:"Opening sidepanel failed",error:t.toString(),touchpoint:e.touchpoint})}}function $(e,t){w(),"convertPageContextMenu"===e.menuItemId?function(e,t){G(e,t)&&(o.event(o.e.CONTEXT_MENU_CONVERT_PAGE),y().handleConversionRequest({tabId:t.id,caller:U().web2pdfCaller.MENU,action:U().web2pdfAction.CONVERT,context:U().web2pdfContext.PAGE,url:e.pageUrl||t.url,domtitle:H(t)}))}(e,t):"appendPageContextMenu"===e.menuItemId?function(e,t){G(e,t)&&(o.event(o.e.CONTEXT_MENU_APPEND_PAGE),y().handleConversionRequest({tabId:t.id,caller:U().web2pdfCaller.MENU,action:U().web2pdfAction.APPEND,context:U().web2pdfContext.PAGE,url:e.pageUrl||t.url,domtitle:H(t)}))}(e,t):"convertLinkTargetToPDFContextMenu"===e.menuItemId?function(e,t){G(e,t)&&(o.event(o.e.CONTEXT_MENU_CONVERT_LINK),y().handleConversionRequest({tabId:t.id,caller:U().web2pdfCaller.MENU,action:U().web2pdfAction.CONVERT,context:U().web2pdfContext.LINK,url:e.linkUrl,domtitle:H(t)}))}(e,t):"appendLinkTargetToExistingPDFContextMenu"===e.menuItemId?function(e,t){G(e,t)&&(o.event(o.e.CONTEXT_MENU_APPEND_LINK),y().handleConversionRequest({tabId:t.id,caller:U().web2pdfCaller.MENU,action:U().web2pdfAction.APPEND,context:U().web2pdfContext.LINK,url:e.linkUrl,domtitle:H(t)}))}(e,t):Object.values(f.VERBS).includes(e.menuItemId.replace("ContextMenu",""))||"expressMenu"===e.menuItemId?function(e,t){if(!G(e,t))return;const n=new URL(t.url).hostname;"expressMenu"===e.menuItemId?e.intent="editImage":e.intent=e?.menuItemId?.replace("ContextMenu",""),o.event(o.e.CONTEXT_MENU_EXPRESS_VERB,{domain:n,TARGET:e?.linkUrl?"Link":"Image",VERB:e?.intent}),s.setItem(f.CONTEXT_MENU_INTERACTION_DONE,"true"),e.touchpoint="ContextMenu",C(e,t)}(e,t):"addWebpageToProject"===e.menuItemId&&b(e,t,u)}function Y(e,n=!1,a=!1){"false"!==s.getItem("fte")&&(n&&s.getItem("pdfViewer")||(s.getItem("installTimestamp")||s.setItem("installTimestamp",Date.now()),setTimeout((()=>{chrome.storage.managed.get("OpenHelpx",(function(i){let r=!i||"false"!==i.OpenHelpx;o.event(r?o.e.VIEWER_FTE_OPEN_HELPX_ENABLED:o.e.VIEWER_FTE_OPEN_HELPX_DISABLED),n&&o.event(o.e.USE_ACROBAT_DEF_OWNERSHIP_ON_UPDATE),function(){try{s.getItem("pdfViewer")||(s.setItem("viewer-enabled-source","ownership-install"),s.setItem("pdfViewer","true"),l.setViewerState("enabled"),t.isEdge()?(m.initiateUserPolling(),o.event(o.e.USE_ACROBAT_IN_EDGE_AUTO_ENABLED)):o.event(o.e.USE_ACROBAT_IN_CHROME_AUTO_ENABLED))}catch(e){o.event(o.e.LOCAL_STORAGE_DISABLED)}}(),s.setItem("fte","false"),a&&(r=!1);const d=t.isEdge()&&("admin"===e.installType||"sideload"===e.installType);r&&!d&&async function(){let e=chrome.i18n.getMessage("@@ui_locale");["ca","da","en_GB","es","fi","hr","it","ko","nl","pt_BR","ru","sl","tr","zh_CN","cs","de","en_US","eu","fr","hu","ja","nb","pl","ro","sk","sv","uk","zh_TW"].includes(e)||(e="en_US");const o=t.isEdge()?"Edge":"Chrome";return`${c.getWelcomePdfUrlHost()}/dc-chrome-extension/mv/${e}/Acrobat-for-${o}.pdf`}().then((e=>t.createTab(e,(e=>{const t=(new Date).getTime();M={...e,timestamp:t},chrome.tabs.onUpdated.addListener((function t(n,a){e.id==n&&"complete"===a.status&&(o.event(o.e.WELCOME_PDF_LOADED),chrome.tabs.onUpdated.removeListener(t))}))}))))}))}),2e3)))}function q(){const e="true"===s.getItem("pdfViewer")?"enabled":"disabled";l.setViewerState(e)}function K(e){const t=e.UsageMeasurement,o=t&&"false"===t.newValue?"false":"true";s.setItem("ANALYTICS_OPT_IN_ADMIN",o)}function J(){const e=s.getItem("pdfViewer");let t="neverTaken";return"true"===e?t="enabled":"false"===e&&(t="disabled"),t}async function z(e){const t=s.getItem("localFileConfig");t?e&&!t?.localFilePermission&&function(e,t){Z(t?.promptCount>0?o.e.LOCAL_FILE_PROMPT_ACCESS_ALREADY_GRANTED:o.e.LOCAL_FILE_PROMPT_NO_SHOW_ACCESS_GRANTED);t.localFilePermission=e,s.setItem("localFileConfig",t)}(e,t):async function(e){const t=await ue(),n={promptCount:0,localFilePermission:e,eligibleDate:new Date(Date.now()).toISOString()};s.setItem("localFileConfig",n),function(e){if("localFileFte"===e)return;let t;switch(e){case"localFilePrompt":t="LFP";break;case"localFileBlockingPrompt":t="LFF";break;case"localFileFteControl":t="LFC";break;default:T.error({message:B+`setLocalFilePromptExperimentAnalyticsCode: Invalid localFileCohort ${e}`})}F(t)}(t),o.event(o.e.LOCAL_FILE_PROMPT_LANDING_IN_COHORT)}(e)}function Z(e){if(!e)return;const t=new Date,n=`${t.getUTCFullYear()}${(t.getUTCMonth()+1).toString().padStart(2,"0")}`;chrome.storage.local.get([e],(t=>{const a=t[e]?.lastSentYearMonth;(!a||n>a)&&(o.event(e),chrome.storage.local.set({[e]:{lastSentYearMonth:n}}))}))}const Q=async()=>{await r.hasFlag("dc-cv-show-animation-on-settings",h.NO_CALL)&&F("LFS")};async function ee(){try{const e=await chrome.extension.isAllowedFileSchemeAccess();await z(e),Q();const{tabId:t,url:a}=s.getItem("localFileFteData");s.removeItem("localFileFteData");const i=s.getWithTTL("LocalFileAccessTouchpointsFromViewer");s.removeItem("LocalFileAccessTouchpointsFromViewer");const r=s.getWithTTL("downloadBanner");s.removeItem("downloadBanner");const l=s.getItem("localFileConfig"),c=s.getWithTTL("LocalFileAccessBannerChallengerTouchpointsFromViewer");s.removeItem("LocalFileAccessBannerChallengerTouchpointsFromViewer");const m=s.getWithTTL("LocalFileAccessBannerControlTouchpointsFromViewer");if(s.removeItem("LocalFileAccessBannerControlTouchpointsFromViewer"),e){try{if(t||i||r||l){const{url:e}=t?await chrome.tabs.get(t):{};e===a&&(i?function(e,t){o.event(n.LOCAL_FILE_ACCESS_TOUCHPOINT_PERMISSION_GRANTED),e?o.event(n.LOCAL_FILE_ACCESS_BANNER_CHALLENGER_TOUCHPOINT_PERMISSION_GRANTED):t&&o.event(n.LOCAL_FILE_ACCESS_BANNER_CONTROL_TOUCHPOINT_PERMISSION_GRANTED)}(c,m):r?await async function(){o.event(n.DOWNLOAD_BANNER_PERMISSION_GRANTED);const e=s.getItem("lastOpenTabId");await chrome.scripting.executeScript({target:{tabId:e},files:["content_scripts/injectBannerIframe.js"]}),chrome.tabs.sendMessage(e,{panel_op:"load-downloadBanner",showToast:!0}),o.event(n.DOWNLOAD_BANNER_TOAST_SHOWN),setTimeout((()=>{chrome.tabs.sendMessage(e,{content_op:"dismissBanner"})}),5e3)}():o.event(n.LOCAL_FTE_PERMISSION_GRANTED),function(){const e=s.getItem("loadedTabsInfo");let t=e?.tabsInfo||[];if(t.length){const e=s.getItem("lastOpenTabId");s.removeItem("lastOpenTabId"),o.event(o.e.REOPENED_TABS_ON_LOCAL_FILE_ACCESS),t=t.sort(((e,t)=>e.index-t.index));const n=[];let a={},i={};t.forEach((e=>{const t=e.url||e.pendingUrl;t.includes("file:///")||n.push(chrome.tabs.create({url:t,index:e.index,active:!1,windowId:e.windowId}))})),Promise.allSettled(n).then((o=>{o.forEach(((o,n)=>{if(o.reason&&o.reason?.message?.includes("No window with id")){T.error({message:"Error in reopening tab",error:o.reason?.message});const e=t[n].windowId,s=t[n].url;a[e]=a[e]?[...a[e],s]:[s]}e&&o?.value?.id&&(i[o.value.id]=t[n].id,e===t[n].id&&setTimeout((()=>{chrome.tabs.highlight({tabs:o.value.index,windowId:o.value.windowId});const e=s.getItem("settingsWindow");e&&(chrome.tabs.remove(e?.id),s.removeItem("settingsWindow"),chrome.tabs.sendMessage(o.value.id,{content_op:"showLocalFileAccessToast"}))}),2e3))})),s.setItem("tabIdMap",i);for(const o in a)chrome.windows.create({url:a[o],focused:!1}).then((n=>{if(e){for(const a of n.tabs){const n=a.url||a.pendingUrl;i[a.id]=t.find((e=>e.url===n&&e.windowId===Number(o)))?.id,i[a.id]===e&&setTimeout((()=>{chrome.tabs.highlight({tabs:a.index,windowId:a.windowId});const e=s.getItem("settingsWindow");e&&(chrome.tabs.remove(e?.id),s.removeItem("settingsWindow"),chrome.tabs.sendMessage(a.id,{content_op:"showLocalFileAccessToast"}))}),2e3)}s.setItem("tabIdMap",i)}}))})),s.removeItem("loadedTabsInfo")}}())}}catch(e){}Z(n.LOCAL_FILE_PERMISSION_GRANTED),await async function(){const e=await chrome.tabs.query({url:"file:///*"});for(let t in e){const{id:o,url:n}=e[t];n.toLowerCase().endsWith(".pdf")&&chrome.tabs.reload(o)}}(),function(e,t){const o=s.getItem("settingsWindow");o&&!e&&(chrome.tabs.remove(o?.id),s.removeItem("settingsWindow"),setTimeout((()=>{t&&chrome.tabs.sendMessage(t,{content_op:"showLocalFileAccessToast"})}),2e3))}(i,t)}else s.removeItem("loadedTabsInfo")}catch(e){T.error({message:B+`checkLocalFileAccess: Error checking local file access permissions: ${e}`})}}async function te(n){L.setCommonItems(),(async()=>{s.getItem("appLocale")||s.setItem("appLocale",s.getItem("viewer-locale")||t.getFrictionlessLocale(chrome.i18n.getMessage("@@ui_locale")))})(),""!==s.getItem("acrobat-gsuite-touch-points")&&""===s.getItem("acrobat-touch-points-in-other-surfaces")&&(s.setItem("acrobat-touch-points-in-other-surfaces",s.getItem("acrobat-gsuite-touch-points")),s.removeItem("acrobat-gsuite-touch-points")),l.isMimeHandlerAvailable().then((e=>{e?i.getItem("startupComplete")||t.mimeReloadAllTabs():ee()})),setTimeout(q,1e4),function(){try{t.isEdge()&&s.setItem("IsRunningInEdge","true")}catch(e){}}(),async function(){if(!s.getItem("ANALYTICS_OPT_IN_ADMIN")){const e=await chrome.storage.managed.get("UsageMeasurement"),t=e&&"false"===e.UsageMeasurement?"false":"true";s.setItem("ANALYTICS_OPT_IN_ADMIN",t)}}(),async function(){const e=await chrome.storage.managed.get("DisableGenAI"),t=e&&"true"===e.DisableGenAI?"true":"false";s.setItem("DISABLE_GENAI_BY_ADMIN",t)}();const c="dc-cv-startup-new-analytics";r.hasFlag(c,h.NO_CALL).then((e=>{if(e){const e=r.getFeatureMeta(c);if(e)try{const t=JSON.parse(e);if(t.cachingTime){const e=parseInt(t.cachingTime,10);o.logEventOnce(o.e.EXTENSION_STARTUP_NEW,{storageKey:"startupNewEventLastLogged",timePeriod:e,ownershipStatus:J()})}}catch(e){}}}));const m=await E(),{repromptDone:u,pdfOwner:p,isAcrobatInstalled:g,isReaderInstalled:I}=m??{};r.hasFlag("dc-cv-adobe-yolo",h.NO_CALL).then((e=>{e&&a.ADOBE_YOLO_ENABLED&&!s.getWithTTL("adobe-yolo-freeze")&&d.updateUserDetails()})),P({env:n,msg:m}),i.getItem("startupComplete")||(k(),function(o){const n=0==o||1==o&&!1===e.NMHConnStatus||o==a.READER_VER||o==a.ERP_READER_VER;chrome.contextMenus.removeAll((function(){chrome.contextMenus.create({id:"addWebpageToProject",title:t.getTranslation("addWebpageToProjectContextMenuTitle"),contexts:["page"],documentUrlPatterns:x,visible:!1}),a.IS_READER||n||(chrome.contextMenus.create({id:"convertPageContextMenu",title:j("web2pdfConvertPageContextMenu"),contexts:["page"],documentUrlPatterns:x}),chrome.contextMenus.create({id:"appendPageContextMenu",title:j("web2pdfAppendPageContextMenu"),contexts:["page"],documentUrlPatterns:x}),A(s.getItem("express-touch-points"))),v()}))}(m.ver),"true"!==u&&!0!==u||o.logEventOnce(o.e.ENABLED_AFTER_READER_REPROMPT,{storageKey:"repromptAnalyticsLogged"}),setTimeout((()=>{s.getItem("firstTimeStartup")?s.setItem("firstTimeStartup","false"):s.setItem("firstTimeStartup","true"),o.event(o.e.EXTENSION_STARTUP,{ownershipStatus:J(),pdfOwner:p,isAcrobatInstalled:g,isReaderInstalled:I})}),5e3),i.setItem("startupComplete",!0),async function(){if("true"!==s.getItem("pdfViewer"))return!1;const e=Date.now();let t=6048e5;const o="dc-cv-offscreen-wp-grace-period";if(!await r.hasFlag(o,h.NO_CALL))return!0;const n=r.getFeatureMeta(o);if(n)try{const e=JSON.parse(n);e.gracePeriod&&(t=parseInt(e.gracePeriod,10))}catch(e){}const a=parseInt(s.getItem("lastPdfOpenTimestamp"),10);return a?e-a<=t:(s.setItem("lastPdfOpenTimestamp",e),!0)}().then((e=>{e&&N.setupWorkerOffscreen({startup:!0})})))}function oe(e){const{id:t,timestamp:n}=M,a=(new Date).getTime();e===t&&a-n<=15e3&&o.event(o.e.WELCOME_PDF_TAB_CLOSED);const i=s.getItem("signInExperimentShown");if(i){const{currTabId:t,timestamp:n}=JSON.parse(i),r=a-n,l="true"===s.getItem("signInExperimentSuppressed");e===t&&r<=15e3&&!l&&o.event(o.e.SIGN_IN_PROMPT_TAB_CLOSED),s.removeItem("signInExperimentShown"),s.removeItem("signInExperimentSuppressed")}}const ne=e=>{const{height:t,width:o}=g;return{height:t,width:o,top:Math.round(.5*(e.height-t)+e.top),left:Math.round(.5*(e.width-o)+e.left)}},ae=e=>{const t=Math.min(Math.round(.8*e.height),900),o=Math.min(Math.round(.9*e.width),1550);return{height:t,width:o,top:Math.round(.5*(e.height-t)+e.top),left:Math.round(.5*(e.width-o)+e.left)}},se=async({windowId:e})=>{const t=await chrome.windows.get(e);if("fullscreen"===t?.state||"locked-fullscreen"===t?.state)return;const{tabId:o,url:n}=s.getItem("localFileFteData"),[a]=await chrome.tabs.query({currentWindow:!0,active:!0}),i=s.getItem("localFteWindow");if(a&&a.id===o&&a.url===n){let{height:e,width:o,top:n,left:a}=ne(t);"localFilePrompt"===await ue()&&({height:e,width:o,top:n,left:a}=ae(t)),await chrome.windows.update(i?.id,{height:e,width:o,left:a,top:n,focused:!0})}},ie=async e=>{const t=await ue();switch(t){case"localFilePrompt":me(e);break;case"localFileBlockingPrompt":de(e);break;case"localFileFteControl":case"localFileFte":Ie(e,t);break;default:T.error({message:B+"openLocalFileFTEPrompts: No Valid local file prompt found"})}},re=e=>{const t=s.getItem("localFileConfig");return!t||!t.localFilePermission&&(e.promptLimit>t.promptCount&&t.eligibleDate<=new Date(Date.now()).toISOString())},le=(e,t=!1)=>{try{let o=s.getItem("localFileConfig");o?t||(o.promptCount=o.promptCount+1):o={promptCount:1},o.eligibleDate=(e=>{const t=Number(e);return isNaN(t)&&T.error({message:B+`_getLocalFilePromptCooldown: cooldownConfig.settingsCoolDown must be a valid number: ${e}`}),new Date(Date.now()+t*I).toISOString()})(e),s.setItem("localFileConfig",o)}catch(e){T.error({message:B+`updateLocalFilePromptCooldown: Error updating local file prompt cooldown: ${e}`})}},ce=async()=>{let e;try{e=await r.getFeatureMeta("dc-cv-local-file-permission-prompt"),e=JSON.parse(e)}catch(t){e={promptLimit:5,ignoreCoolDown:7,settingsCoolDown:7,dismissCoolDown:7}}return e},me=async e=>{try{const t=await chrome.windows.get(e.windowId);if(!await ge(t))return;const n=await ce();if(re(n)&&!pe){const{height:a,width:i,top:r,left:l}=ae(t);s.setItem("localFileFteData",{tabId:e.id,url:e.url}),pe=!0;const c=await chrome.windows.create({height:a,width:i,left:l,top:r,focused:e.active,type:"popup",url:chrome.runtime.getURL("browser/js/local-file/local-file-prompt.html")});s.setItem("localFteWindow",c),o.event(o.e.LOCAL_FILE_PERMISSION_PROMPT_SHOWN),he(c),le(n?.ignoreCoolDown)}}catch(e){T.error({message:B+`openLocalFilePrompt: Error handling local PDF prompt: ${e}`})}},de=async e=>{try{const t=await(async()=>{let e;try{e=await r.getFeatureMeta("dc-cv-local-file-permission-blocking-prompt"),e=JSON.parse(e)}catch(t){T.error({message:B+`_fetchLocalFileBlockingPromptCooldownConfig: Error fetching local file prompt cooldown config: ${t}`}),e={promptLimit:1,ignoreCoolDown:1,settingsCoolDown:1,dismissCoolDown:1}}return e})();re(t)&&(s.setItem("localFileFteData",{tabId:e.id,url:e.url}),o.event(o.e.LOCAL_FILE_BLOCKING_PAGE_SHOWN),le(t?.ignoreCoolDown),chrome.tabs.update(e.id,{url:chrome.runtime.getURL("browser/js/local-file/local-file-blocking-page.html")}))}catch(e){T.error({message:B+`openLocalFileBlockingPrompt: Error handling local PDF blocking: ${e}`})}},ue=async()=>{const[e,t,o,n]=await Promise.all([r.hasFlag("dc-cv-local-file-permission-prompt"),r.hasFlag("dc-cv-local-file-permission-blocking-prompt"),r.hasFlag("dc-cv-local-file-permission-control"),r.hasFlag("dc-cv-local-file-fte")]);return e?"localFilePrompt":t?"localFileBlockingPrompt":o?"localFileFteControl":n?"localFileFte":void 0};let pe=!1;const ge=async e=>!("fullscreen"===e?.state||"locked-fullscreen"===e?.state),Ie=async(e,n)=>{const a=await chrome.windows.get(e.windowId);if(!await ge(a))return;let i,l;if((e=>{("localFileFteControl"===e&&!s.getItem("localFileConfig")||s.getItem("rc")&&!s.getItem("localFteCounterResetNew"))&&(s.removeItem("localFteCount"),s.removeItem("localFteCooldown"),s.removeItem("localFteCounterReset"),s.setItem("localFteCounterResetNew",!0))})(n),"localFileFteControl"===n){const e=s.getItem("localFteDontShowAgain");l=await(async()=>{let e;try{e=await r.getFeatureMeta("dc-cv-local-file-fte"),e=JSON.parse(e)}catch(t){T.error({message:B+`_fetchLocalFileControlPromptCooldownConfig: Error fetching local file prompt cooldown config: ${t}`}),e={promptLimit:5,ignoreCoolDown:7,settingsCoolDown:7,dismissCoolDown:7}}return e})(),i=re(l)&&!e}else i=await(async()=>{const e=t.isEdge(),o=s.getWithTTL("localFteCooldown"),n=s.getItem("localFteCount")||0,a=s.getItem("localFteDontShowAgain"),i=await chrome.extension.isAllowedFileSchemeAccess();return!(e||i||a||o||n>=20)})();if(i&&!pe){const{height:t,width:i,top:r,left:c}=ne(a);s.setItem("localFileFteData",{tabId:e.id,url:e.url}),pe=!0;const m=await chrome.windows.create({height:t,width:i,left:c,top:r,focused:e.active,type:"popup",url:chrome.runtime.getURL("browser/js/local-fte.html")});o.event(o.e.LOCAL_FILE_FTE_SHOWN),"localFileFteControl"===n&&le(l?.ignoreCoolDown),s.setItem("localFteWindow",m),he(m)}},he=t=>{const o=t?.tabs?.[0]?.id;o&&setTimeout((()=>{chrome.tabs.setZoom(o,1)}),500),e.registerHandlers({closeLocalFte:()=>chrome.windows.remove(t.id)})},fe=async e=>{const t=s.getItem("localFteWindow");e===t?.id&&(pe=!1,s.removeItem("localFteWindow"),_e())},Ee=async e=>{const{tabId:t}=s.getItem("localFileFteData");if(t===e){const e=s.getItem("localFteWindow");chrome.windows.remove(e?.id)}},we=e=>{const t=s.getItem("isAllowedLocalFileAccess"),{filename:n,id:a}=e||{};if(n&&a){let e=s.getItem("downloadCount")||0;s.setItem("downloadCount",++e),t||chrome.downloads.search({id:a},(async t=>{const{mime:n,referrer:a,finalUrl:i}=t[0],l=(a||i).split("/")[2];"application/pdf"===n&&(l===chrome.runtime.id?chrome.tabs.query({active:!0,currentWindow:!0},(e=>{chrome.tabs.sendMessage(e[0].id,{main_op:"downloadFileSuccess"})})):!p.includes(l)&&e>=3&&(async()=>{if(!await r.hasFlag("dc-cv-download-banner",h.NO_CALL))return!1;s.getItem("downloadBannerFlag")||(s.setItem("downloadBannerFlag",!0),o.event(o.e.DOWNLOAD_BANNER_ENABLED));const e=s.getItem("downloadBannerData");if(e){const{count:t,lastShown:o,doNotShow:n}=e;if(n||t>=10)return!1;const a=t>=3?12096e5:864e5;if((new Date).getTime()-o<a)return!1}return!0})().then((e=>{e&&chrome.tabs.query({active:!0,currentWindow:!0},(e=>{e[0]?.id&&(chrome.tabs.sendMessage(e[0].id,{panel_op:"load-downloadBanner"}),o.event(o.e.DOWNLOAD_BANNER_SHOWN),(()=>{const e=s.getItem("downloadBannerData")||{};e.count=(e.count||0)+1,e.lastShown=(new Date).getTime(),s.setItem("downloadBannerData",e),e.count>=10&&o.event(o.e.DOWNLOAD_BANNER_MAX_LIMIT_SHOWN)})())}))})))}))}},_e=async()=>{try{const e=await ue(),t=s.getItem("settingsWindow");if("localFilePrompt"===e&&!t){const e=await ce();le(e?.dismissCoolDown,!0),o.event(o.e.LOCAL_FILE_PERMISSION_PROMPT_CLOSED)}}catch(e){T.error({message:B+`handleLocalFilePromptDismiss: Error updating dismiss cooldown ${e}`})}};e.registerHandlers({themeChange:_,reRegisterUninstallUrl:_,localeChange:e=>_({locale:e.locale}),updateLoadedTabsInfo:(e,t)=>{const o=s.getItem("loadedTabsInfo");let n=o?.tabsInfo||[];const a=t.tab;if(o.tabsInfo){const e=n.findIndex((e=>e.id==a.id));-1===e?n.push(a):n[e]={...a}}else n=[a];s.setItem("loadedTabsInfo",{tabsInfo:n})}});export{te as startup,V as registerActions,oe as onWelcomeTabRemoved,$ as contextMenuOnClickHandler,K as updateAnalyticsOptInAdmin,se as refocusLocalFteWindow,Ee as onLocalFileClosed,fe as onLocalFteWindowClosed,X as startQAWithWebpage,we as onDownloadChanged,ie as openLocalFileFTEPrompts};