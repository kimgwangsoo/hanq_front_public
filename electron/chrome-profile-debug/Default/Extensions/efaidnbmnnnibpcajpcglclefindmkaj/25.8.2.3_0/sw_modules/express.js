/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
import{analytics as e,events as t}from"../common/analytics.js";import{dcLocalStorage as s,dcSessionStorage as n}from"../common/local-storage.js";import{loggingApi as r}from"../common/loggingApi.js";import{CACHE_PURGE_SCHEME as a,EXPRESS as o,EXPRESS_CONTEXT_MENU_ENABLED_VERBS as c}from"./constant.js";import{floodgate as i}from"./floodgate.js";import{util as l}from"./util.js";import{viewerModuleUtils as p}from"./viewer-module-utils.js";import{common as E}from"./common.js";import{expressIndexedDBScript as m}from"../common/expressindexedDB.js";import{removeExperimentCodeForAnalytics as g,setExperimentCodeForAnalytics as d}from"../common/experimentUtils.js";import u from"./ExplicitBlocklist.js";let x=!1;const f={},S=10,v=720,I="expressMenu",b={"dc-cv-express-standalone":"EL","dc-cv-express-standalone-control":"ELC","dc-cv-express-whatsapp-hover":"EWH","dc-cv-express-whatsapp-hover-control":"EWHC","dc-cv-express-gmail-message-view":"EGM","dc-cv-express-gmail-message-view-control":"EGMC","dc-cv-express-whatsapp-fte":"EWF","dc-cv-express-whatsapp-fte-control":"EWFC","dc-cv-express-gmail-fte":"EGF","dc-cv-express-gmail-fte-control":"EGFC","dc-cv-express-gdrive-native-viewer":"EGD","dc-cv-express-gdrive-native-viewer-control":"EGDC","dc-cv-express-facebook-preview":"EFB","dc-cv-express-facebook-preview-control":"EFBC"},h="cleanUpExpressAssetMemoryMap",w="cleanUpExpressIndexedDB",_=864e5,R=6e5,O={beta:["memepcobodlebmohdlfnjiaalggfcpic","hgednelcgbmkdebjhejlmbgigmkcbemg"],release:["efaidnbmnnnibpcajpcglclefindmkaj","elhekieabhbkpmcefcoobjddigjcaadp"]},A={[o.VERBS.EFFECTS_IMAGE]:"add-effects",[o.VERBS.CROP_IMAGE]:"crop-image",[o.VERBS.REMOVE_BACKGROUND_IMAGE]:"remove-background",[o.VERBS.INSERT_OBJECT]:"insert-object",[o.VERBS.REMOVE_OBJECT]:"remove-object"};async function P(e){const t=Date.now(),s=await fetch(e);if(!s.ok)throw new Error(`Response not in 2xx range. Status: ${s.status}`);const n=await s.blob();return new Promise(((e,s)=>{const r=new FileReader;r.readAsDataURL(n),r.onloadend=()=>{const s=r.result,n=Date.now()-t;e({base64data:s,imageDownloadTime:n})},r.onerror=s}))}function T(e){const t=["en-US","en-GB"],s=l.getFrictionlessLocale(chrome.i18n.getMessage("@@ui_locale"));switch(e){case"dc-cv-express-whatsapp-hover":case"dc-cv-express-whatsapp-hover-control":case"dc-cv-express-gmail-message-view":case"dc-cv-express-gmail-message-view-control":return t.includes(s);default:return!0}}async function M(e){if(!await i.hasFlag(e))return!1;const t=i.getFeatureMeta(e);if(t)try{const e=JSON.parse(t);if(e.minExtVer&&l.verCmp(e.minExtVer,chrome.runtime.getManifest().version)>0)return!1}catch(e){}return!0}function L(e){return A[e]??"edit-image"}function C(e){return(n.getItem(o.EXPRESS_SESSIONS)||{})[e]}async function y(e,t){const s=Date.now(),r=new URL(t.url).hostname,a=e.srcUrl,c=t.id,i=e.intent,p=e.touchpoint,E=await async function(){return await M("dc-cv-express-standalone")?o.VARIANT.LOE:o.VARIANT.MODAL}(),m=l.uuid(),g=n.getItem(o.EXPRESS_SESSIONS)||{};return g[m]={pageDomain:r,imageURL:a,tabId:c,intent:i,touchpoint:p,variant:E,clickTimeStamp:s},n.setItem(o.EXPRESS_SESSIONS,g),m}async function N(e,t){const s=await y(e,t);await F(s)}function D(e){const t=n.getItem(o.EXPRESS_SESSIONS)||{};return Object.keys(t).find((s=>{const r=t[s];return r.tabId===e&&!r.fetchedFromContentScript&&r.variant===o.VARIANT.MODAL&&(t[s].fetchedFromContentScript=!0,n.setItem(o.EXPRESS_SESSIONS,t),!0)}))}async function F(a){const c=C(a);let i;const p=c?.pageDomain;try{if(i=c.intent,c.variant===o.VARIANT.LOE){const e=c.clickTimeStamp,t=e+_;m.storeExpressAssetInfoInIndexedDB(a,c.imageURL,t,e),chrome.alarms.get(w,(e=>{e||chrome.alarms.create(w,{periodInMinutes:v})})),f[a]={bufferPromise:P(c.imageURL),ttl:Date.now()+R,clickTimeStamp:e,domain:p},chrome.alarms.get(h,(e=>{e||chrome.alarms.create(h,{periodInMinutes:S})}));const n=new URL(E.getExpressURLs().webAppUrl);n.searchParams.append("expressSessionId",a),n.searchParams.append("referrer",o.REFERRER);const r=L(c.intent);n.searchParams.append("editAction",r),n.searchParams.append("extId",function(){const e=Object.keys(O).filter((e=>O[e].includes(chrome.runtime.id)));return e.length>0?e[0]:"release"}());const i=l.getFrictionlessLocale(chrome.i18n.getMessage("@@ui_locale"));n.searchParams.append("locale",i),"true"===s.getItem("adobeInternal")&&n.searchParams.append("setting-consoleLogLevel-performance","info"),chrome.tabs.create({url:n.href,active:!0})}else!function(e,t,s){let r=n.getItem(o.SESSIONS_WHERE_MODAL_LOADING)||[];r.push({tabId:e,touchpoint:t,domain:s}),n.setItem(o.SESSIONS_WHERE_MODAL_LOADING,r)}(c.tabId,c?.touchpoint,p),await chrome.scripting.executeScript({target:{tabId:c.tabId},files:["content_scripts/express-content-script.js"]})}catch(s){q(c?.tabId,c?.touchpoint,p),e.event(t.EXPRESS_EXECUTE_VERB_FAILED,{VERB:i,eventContext:s.toString(),expressTouchpoint:c?.touchpoint,domain:p}),r.error({message:"Error executing express verb",error:"Initiate execute verb from service worker: "+s.toString()})}}async function G(n){if(!f[n])return async function(s){let n,a,c;const i=C(s),l=await m.getExpressAssetInfoFromIndexedDB(s);if(!l)return r.error({message:"Error executing express verb",error:`Asset transfer to LOE failed: ${o.EXTERNAL_MESSAGING_ERROR_CODES.INVALID_REQUEST}`}),{status:o.RESPONSE_STATUS.FAILED,errorCode:o.EXTERNAL_MESSAGING_ERROR_CODES.INVALID_REQUEST};n=l.url,a=l.clickTimeStamp;try{c=(await P(n)).base64data}catch(s){return e.event(t.EXPRESS_EXECUTE_VERB_FAILED,{eventContext:s.toString(),domain:i?.pageDomain,expressTouchpoint:i?.touchpoint}),r.error({message:"Error executing express verb",error:`Asset transfer to LOE failed: ${s.toString()}`}),{status:o.RESPONSE_STATUS.FAILED,errorCode:o.EXTERNAL_MESSAGING_ERROR_CODES.IMAGE_FETCH_FAILED,clickTimeStamp:a}}return{status:o.RESPONSE_STATUS.SUCCESS,buffer:c,clickTimeStamp:a}}(n);{const a=C(n)?.touchpoint,c=f[n]?.domain,i=f[n].clickTimeStamp,l=Date.now()-i;try{const{base64data:e,imageDownloadTime:t}=await f[n].bufferPromise,a=Date.now()-i;"true"===s.getItem("adobeInternal")&&(console.log("Time required to receive request from express webapp "+l),console.log("Image Download Time "+t),console.log("Time required to handover to express "+a));const p={imageDownloadTime:t,timeRequiredToHandoverToExpress:a,expressCommunicationReceivedTime:l,imageSize:e.length};return r.info({message:o.PERF_METRIC_LOG_MESSAGE,...p}),{status:o.RESPONSE_STATUS.SUCCESS,buffer:e,clickTimeStamp:i,domain:c}}catch(s){e.event(t.EXPRESS_EXECUTE_VERB_FAILED,{eventContext:s.toString(),domain:c,expressTouchpoint:a}),r.error({message:"Error executing express verb",error:`Asset transfer to LOE failed: ${s.toString()}`});const n=o.EXTERNAL_MESSAGING_ERROR_CODES.IMAGE_FETCH_FAILED;return{status:o.RESPONSE_STATUS.FAILED,errorCode:n,clickTimeStamp:i,domain:c}}}}function B(e){chrome.scripting.executeScript({target:{tabId:e},func:()=>{!function(e){const t=document.querySelector(`#${e}`);t?.parentElement?.removeChild(t),document.body.style.overflow=overflowStyleBeforeExpressOpened,overflowStyleBeforeExpressOpened=void 0}("expressAcrobatExtension"),dialogToBeReopened&&(dialogToBeReopened.showModal(),dialogToBeReopened=void 0)}})}function k(){const e="true"===s.getItem("adobeInternal"),t=s.getItem("installSource");return e||"admin"!==t}async function V(){const e=k();for(const t of Object.keys(b)){const s=b[t];e&&await M(t)&&T(t)?d(s):g(s)}g("Exp_Mod"),g("Exp_Loe"),g("EC"),g("EWP"),g("EWPC"),g("EGN"),g("EGNC"),g("ECS"),g("ECSC"),g("EI2"),g("EI2C"),g("EGI"),g("EGIC"),g("EWSC"),g("EWS")}async function U(e){const t=["http://*/*","https://*/*"];if((await j(e)).enableExpressContextMenu){if(!x){x=!0;const e=W(I,l.getTranslation("expressEditImageParentContextMenu"),["image"],t);chrome.contextMenus.create({id:"poweredByAdobeExpress",parentId:e,title:l.getTranslation("expressEditImagePoweredByExpressContextMenu"),contexts:["image"],enabled:!1,documentUrlPatterns:t}),chrome.contextMenus.create({id:"separatorForExpressMenu",parentId:e,type:"separator",contexts:["image"],documentUrlPatterns:t}),c.forEach((s=>{const n=s+"ContextMenu";W(n,l.getTranslation(n),["image"],t,e)}))}const e=await i.hasFlag("dc-cv-enable-splunk-logging",a.NO_CALL);p.enableSplunk(e)}else!async function(){x&&(x=!1,chrome.contextMenus.remove("poweredByAdobeExpress"),chrome.contextMenus.remove("separatorForExpressMenu"),Object.keys(c).forEach((e=>{const t=c[e]+"ContextMenu";chrome.contextMenus.remove(t)})),chrome.contextMenus.remove(I))}()}async function j(e){let t={enableExpressContextMenu:!1,enableExpressOptionsPagePreference:!1,enableExpressTooltip:!1};const n=await i.hasFlag("dc-cv-express-context-menu")||await M("dc-cv-express-standalone"),r=await i.hasFlag("dc-cv-express-context-menu-tooltip");if(null!=e&&""!==e||null!=(e=s.getItem("express-touch-points"))&&""!==e||(e=!0),await V(),n&&k()&&(t.enableExpressOptionsPagePreference=!0,e&&"false"!==e)){t.enableExpressContextMenu=!0;const e="true"===s.getItem(o.CONTEXT_MENU_INTERACTION_DONE);t.enableExpressTooltip=!e&&r}return s.removeItem("express-context-menu-fg-enabled-analytics-logged"),s.removeItem("express-image-right-click-fg-enabled-analytics-logged"),t}function W(e,t,s,n,r){return chrome.contextMenus.create({id:e,parentId:r,title:t,contexts:s,documentUrlPatterns:n})}function X(){return["poweredByAdobeExpress","separatorForExpressMenu",...Object.keys(c).map((e=>c[e]+"ContextMenu")),I]}function H(s){const a=function(e){let t=[],s=n.getItem(o.SESSIONS_WHERE_MODAL_LOADING)||[];s=s.filter((s=>s.tabId!==e||(t.push(s),!1))),t.length>0&&n.setItem(o.SESSIONS_WHERE_MODAL_LOADING,s);return t}(s);a.forEach((s=>{const n="Tab closed before express modal opened";r.error({message:"Error executing express verb",error:n}),e.event(t.EXPRESS_TAB_CLOSED_BEFORE_EXPRESS_LOADED,{eventContext:n,expressTouchpoint:s.touchpoint,domain:s.domain})}))}function q(e,t,s){let r=n.getItem(o.SESSIONS_WHERE_MODAL_LOADING)||[];const a=r.findIndex((n=>n.tabId===e&&n.touchpoint===t&&n.domain===s));a>-1&&(r.splice(a,1),n.setItem(o.SESSIONS_WHERE_MODAL_LOADING,r))}async function $(){const e={enableWhatsappPreviewExpressMenu:!1,enableExpressOptionsPagePreference:!1},t=await i.hasFlag("dc-cv-express-whatsapp-preview");let n=s.getItem("express-touch-points");return n=""===n||n,await V(),t&&k()&&(e.enableExpressOptionsPagePreference=!0,n&&"false"!==n&&(e.enableWhatsappPreviewExpressMenu=!0)),s.removeItem("express-whatsapp-preview-fg-enabled-analytics-logged"),s.removeItem("express-whatsapp-preview-fg-control-enabled-analytics-logged"),e}async function J(){const n={enableWhatsappHoverExpressMenu:!1,enableExpressOptionsPagePreference:!1},r=l.getFrictionlessLocale(chrome.i18n.getMessage("@@ui_locale"));if(!["en-US","en-GB"].includes(r))return n;const a=await i.hasFlag("dc-cv-express-whatsapp-hover"),o=await i.hasFlag("dc-cv-express-whatsapp-hover-control");let c=s.getItem("express-touch-points");return c=""===c||c,await V(),a&&k()?(n.enableExpressOptionsPagePreference=!0,"true"!==s.getItem("express-whatsapp-hover-fg-enabled-analytics-logged")&&(s.setItem("express-whatsapp-hover-fg-enabled-analytics-logged","true"),e.event(t.EXPRESS_WHATSAPP_HOVER_MENU_FG_ENABLED)),c&&"false"!==c&&(n.enableWhatsappHoverExpressMenu=!0)):o&&k()&&"true"!==s.getItem("express-whatsapp-hover-fg-control-enabled-analytics-logged")&&(s.setItem("express-whatsapp-hover-fg-control-enabled-analytics-logged","true"),e.event(t.EXPRESS_WHATSAPP_HOVER_MENU_FG_CONTROL_ENABLED)),n}async function K(){const e={enableGmailNVExpressMenu:!1,enableExpressOptionsPagePreference:!1},t=await i.hasFlag("dc-cv-express-gmail-native-viewer");let n=s.getItem("express-touch-points");return n=""===n||n,await V(),t&&k()&&(e.enableExpressOptionsPagePreference=!0,n&&"false"!==n&&(e.enableGmailNVExpressMenu=!0)),s.removeItem("express-gmail-native-viewer-fg-enabled-analytics-logged"),s.removeItem("express-gmail-native-viewer-fg-control-enabled-analytics-logged"),e}async function Q(){const n={enableGmailMessageViewCTA:!1,enableExpressOptionsPagePreference:!1},r=l.getFrictionlessLocale(chrome.i18n.getMessage("@@ui_locale"));if(!["en-US","en-GB"].includes(r))return n;const a=await i.hasFlag("dc-cv-express-gmail-message-view"),o=await i.hasFlag("dc-cv-express-gmail-message-view-control");let c=s.getItem("express-touch-points");return c=""===c||c,await V(),a&&k()?("true"!==s.getItem("express-gmail-message-view-fg-enabled-analytics-logged")&&(s.setItem("express-gmail-message-view-fg-enabled-analytics-logged","true"),e.event(t.EXPRESS_GMAIL_MESSAGE_VIEW_FG_ENABLED)),n.enableExpressOptionsPagePreference=!0,c&&"false"!==c&&(n.enableGmailMessageViewCTA=!0)):o&&k()&&"true"!==s.getItem("express-gmail-message-view-fg-control-enabled-analytics-logged")&&(s.setItem("express-gmail-message-view-fg-control-enabled-analytics-logged","true"),e.event(t.EXPRESS_GMAIL_MESSAGE_VIEW_FG_CONTROL_ENABLED)),n}async function z(){const e={enableGoogleImagePreviewExpressMenu:!1,enableExpressOptionsPagePreference:!1},t=await i.hasFlag("dc-cv-express-google-image-preview");let n=s.getItem("express-touch-points");return n=""===n||n,await V(),t&&k()&&(e.enableExpressOptionsPagePreference=!0,n&&"false"!==n&&(e.enableGoogleImagePreviewExpressMenu=!0)),s.removeItem("express-google-image-preview-fg-enabled-analytics-logged"),s.removeItem("express-google-image-preview-fg-control-enabled-analytics-logged"),e}async function Y(){const n={enableGdriveNativeViewerExpressMenu:!1,enableExpressOptionsPagePreference:!1};let r=s.getItem("express-touch-points");r=""===r||r;const a=await i.hasFlag("dc-cv-express-gdrive-native-viewer"),o=await i.hasFlag("dc-cv-express-gdrive-native-viewer-control");return await V(),a&&k()?(n.enableExpressOptionsPagePreference=!0,"true"!==s.getItem("express-gdrive-native-viewer-fg-enabled-analytics-logged")&&(s.setItem("express-gdrive-native-viewer-fg-enabled-analytics-logged","true"),e.event(t.EXPRESS_GDRIVE_NATIVE_VIEWER_FG_ENABLED)),r&&"false"!==r&&(n.enableGdriveNativeViewerExpressMenu=!0)):o&&k()&&"true"!==s.getItem("express-gdrive-native-viewer-fg-control-enabled-analytics-logged")&&(s.setItem("express-gdrive-native-viewer-fg-control-enabled-analytics-logged","true"),e.event(t.EXPRESS_GDRIVE_NATIVE_VIEWER_FG_CONTROL_ENABLED)),n}async function Z(){const n={enableFacebookPreviewExpressMenu:!1,enableExpressOptionsPagePreference:!1};let r=s.getItem("express-touch-points");r=""===r||r;const a=await i.hasFlag("dc-cv-express-facebook-preview"),o=await i.hasFlag("dc-cv-express-facebook-preview-control");return await V(),a&&k()?(n.enableExpressOptionsPagePreference=!0,r&&"false"!==r&&(n.enableFacebookPreviewExpressMenu=!0),"true"!==s.getItem("express-facebook-fg-enabled-analytics-logged")&&(s.setItem("express-facebook-fg-enabled-analytics-logged","true"),e.event(t.EXPRESS_FACEBOOK_PREVIEW_FG_ENABLED))):o&&k()&&"true"!==s.getItem("express-facebook-fg-control-enabled-analytics-logged")&&(s.setItem("express-facebook-fg-control-enabled-analytics-logged","true"),e.event(t.EXPRESS_FACEBOOK_PREVIEW_FG_CONTROL_ENABLED)),n}async function ee(e){const t=await u.getExpressBlockList();return t.length>0&&t.some((t=>function(e){const t=e.trim();if(!t||t.startsWith("#"))return null;if("/"===t[0]){const e=t.lastIndexOf("/");if(e<=0)return;const s=t.slice(1,e),n=t.slice(e+1);return new RegExp(s,n)}}(t)?.test?.(e)))}chrome.alarms.onAlarm.addListener((function(e){e&&e.name===h&&(Object.keys(f).forEach((e=>{f[e]?.ttl<Date.now()&&delete f[e]})),0===Object.keys(f).length&&chrome.alarms.clear(h))})),chrome.alarms.onAlarm.addListener((function(e){e&&e.name===w&&m.removeExpressAssetInfoFromIndexedDB().then((()=>{m.getExpressAssetCount().then((e=>{0===e&&chrome.alarms.clear(w)}))}))}));export{F as executeExpressVerb,B as closeExpress,U as toggleExpressTouchpoints,j as isExpressContextMenuEnabled,G as getExpressAssetResponse,P as imageUrlToBase64,L as verbNameToIntent,q as removeSessionFromUnloadedExpressSessions,H as expressModalTabCloseListener,$ as isWhatsappPreviewExpressMenuEnabled,J as isWhatsappHoverExpressMenuEnabled,K as isGmailNativeViewerExpressMenuEnabled,z as isGoogleImagePreviewExpressMenuEnabled,Q as isGmailMessageViewExpressMenuEnabled,Y as isGdriveNativeViewerExpressMenuEnabled,Z as isFacebookPreviewExpressMenuEnabled,D as getModalSessionId,C as getExpressSession,N as launchExpress,ee as isExpressDomainBlocked,X as getExpressMenuIds};