/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
import{analytics as e}from"../common/analytics.js";import{dcLocalStorage as t}from"../common/local-storage.js";import{loggingApi as r}from"../common/loggingApi.js";import{common as a}from"./common.js";import o from"./ExplicitBlocklist.js";import{floodgate as n}from"./floodgate.js";import{createPerfTracker as s,PERF_MARKERS as c}from"./perf-tracker.js";import{cleanupUsedOrExpiredRequests as i,registerRequestId as m}from"./request-validator.js";import{util as d}from"./util.js";let l=!1;const g=new Map,u=function(){const e="abcdefghijklmnopqrstuvwxyz0123456789.-",t={};for(let r=0;r<38;r++)t[e[r]]="tubg6lxdq8jc1m9-vw.pfhskar0oi5zn372ye4"[r];return t}(),p=["documentcloud.adobe.com","acrobat.adobe.com","stage.acrobat.adobe.com","dev.acrobat.adobe.com"];async function f(e,t,a){try{const{collectionUrl:o,requestId:n}=e.data,s=new URL(o);chrome.tabs.query({url:`${s.origin}${s.pathname}*`,windowId:t?.tab?.windowId},(t=>{let s=!1;t?.length>0?chrome.tabs.update(t[0].id,{active:!0,url:o}):(s=!0,chrome.tabs.create({url:o})),a({success:!0,closeDialog:e.data.closeDialog}),r.info({message:"AddWebpageToProject Open project url "+(s?"in new tab":"in existing tab"),requestId:n})}));await async function(e){try{const t=await chrome.scripting.executeScript({target:{tabId:e},func:async()=>"function"==typeof window.extractWebpageHTML});return t?.[0]?.result}catch(e){return!1}}(t?.tab?.id)||await chrome.scripting.executeScript({target:{tabId:t?.tab?.id},files:["content_scripts/extract-webpage-html.js"]}),chrome.scripting.executeScript({target:{tabId:t?.tab?.id},func:async()=>await(window.extractWebpageHTML?.())})}catch(t){r.error({message:"Error in opening collection tab",error:t?.message,...e.data})}}async function h({url:e,domain:t}){if(!e&&!t)return!1;try{if(t||(t=new URL(e).hostname),p.includes(t))return!0;const[r=[],a=[]]=await Promise.all([o.getKWBlockList(),o.getExplicitBlocklist()]);return!![...r,...a].includes(function(e){return e.toLowerCase().split("").map((e=>u[e]||e)).join("")}(t))}catch(e){return r.error({message:"Error in checking for blocked domain",error:e?.message}),!1}}function b(){!function(){const e=Date.now();g.forEach(((t,r)=>{e-(t?.getStartTime?.()||0)>36e5&&g.delete(r)}))}(),i()}async function _(){await t.init();if(!await n.hasFlag("dc-cv-add-webpage-to-project"))return!1;const e="false"!==t.getItem("egaf"),a="true"===t.getItem("DISABLE_GENAI_BY_ADMIN"),o=t.getItem("appLocale")||chrome.i18n.getMessage("@@ui_locale"),s=n.getFeatureMeta("dc-cv-add-webpage-to-project");let c=["en-US","en-GB"];if(s)try{const e=JSON.parse(s);e.allowedLocales&&(c=e.allowedLocales)}catch(e){r.error({message:"Error parsing AddWebpageToProject flag metadata",error:e?.message})}const i=c.includes(o)||o.startsWith("en");return!(!e||a||!i)}async function E(){const e=await _();try{e?l||(chrome.contextMenus.update("addWebpageToProject",{visible:!0}),l=!0):l&&(chrome.contextMenus.update("addWebpageToProject",{visible:!1}),l=!1)}catch(e){r.error({message:"Error creating AddWebpageToProject context menu",error:e?.message})}}function w(e){if(document.getElementById("addWebpageToProjectExtnIframe"))return;const{env:t,tabId:r,locale:a,requestId:o,context:n}=e,s=(e,t={})=>{const r={main_op:"kw-perf-mark",data:{requestId:o,name:e,metadata:t,timestamp:Date.now()}};chrome.runtime.sendMessage(r)};s("AWPP_Extension_Iframe_Creation_Started");const c=window?.matchMedia?.("(prefers-color-scheme: dark)"),i=c?.matches,m=document.createElement("iframe"),d=chrome.runtime.getURL("resources/addWebpage/index.html"),l=new URL(d);l.searchParams.set("env",t),l.searchParams.set("tabId",r),l.searchParams.set("locale",a),l.searchParams.set("requestId",o),l.searchParams.set("context",n),l.searchParams.set("theme",i?"dark":"light"),m.src=l.toString(),m.id="addWebpageToProjectExtnIframe",m.allowFullscreen=!0,m.style.cssText="\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        border: none;\n        z-index: 10000;\n        background: rgba(0, 0, 0, 0.1);\n        color-scheme: light;\n    ",m.onload=()=>{s("AWPP_Extension_Iframe_Loaded")},m.onerror=()=>{s("AWPP_Extension_Iframe_Error"),p()},document.body.appendChild(m),s("AWPP_Extension_Iframe_Added_To_Document");const g=new URL(chrome.runtime.getURL("resources/addWebpage/index.html")).origin,u=e=>{if(e.origin!==g)return;const{main_op:t}=e.data;switch(t){case"closeAllIframes":p();break;case"openCollectionTab":chrome.runtime.sendMessage({main_op:"openCollectionTab",data:e.data},(e=>{e.closeDialog&&p()}));break;case"kw-perf-mark":const{main_op:t,...r}=e.data;chrome.runtime.sendMessage({main_op:t,data:r})}};c?.addEventListener?.("change",(e=>{s("AWPP_Extension_Iframe_Theme_Changed",{theme:e.matches?"dark":"light"})}));const p=()=>{const e=document.getElementById("addWebpageToProjectExtnIframe");e&&(s("AWPP_Extension_Iframe_Removed"),chrome.runtime.sendMessage({main_op:"emit-perf-data",data:{requestId:o}}),window.removeEventListener("message",u),e.style.display="none",setTimeout((()=>{document.body.removeChild(e)}),2e3))};window.addEventListener("message",u),window.addEventListener("beforeunload",(()=>{chrome.runtime.sendMessage({main_op:"emit-perf-data",data:{requestId:o}})}))}async function I(o,n,i){b();const d=`req_${Date.now()}_${Math.random().toString(36).substring(2,8)}`;m(d,i);const l=s({requestId:d});g.set(d,l),l.mark(c.AWPP_CONTEXT_MENU_CLICKED),e.event(e.e.CONTEXT_MENU_ADD_WEB_PAGE_TO_PROJECT,{CONTEXT:i});const u={env:a.getEnv(),locale:t.getItem("appLocale")||chrome.i18n.getMessage("@@ui_locale"),requestId:d,tabId:n.id,context:i};try{const e=await Promise.race([chrome.scripting.executeScript({target:{tabId:n.id},func:w,args:[u]}),new Promise(((e,t)=>{setTimeout((()=>{t(new Error("AddWebpageToProject Extension iframe script execution timeout"))}),1e4)}))]);if(!e||0===e.length)throw new Error("Script execution returned no results")}catch(e){let t=e?.message;chrome.runtime.lastError&&(t=chrome.runtime.lastError.message),l.mark(c.AWPP_EXTENSION_IFRAME_SCRIPT_EXECUTION_FAILED,{error:t}),r.error({message:"Error in executing AddWebpageToProject Extension iframe script",error:t,requestId:d})}finally{l.mark(c.AWPP_EXTENSION_IFRAME_SCRIPT_EXECUTION_COMPLETED)}}function P(e){I(0,{id:e.tabId,url:e.url},e.context)}chrome.runtime.onMessage.addListener(((e,t,a)=>{const o=e?.main_op;switch(o){case"openCollectionTab":f(e,t,a);break;case"kw-perf-mark":!function(e){const t=e?.data?.requestId,r=g.get(t);r&&r.mark(e.data.name,e.data.metadata)}(e);break;case"emit-perf-data":!function(e){const t=e?.data?.requestId,a=g.get(t);if(a){const e=a.getPerfTimings();r.info({message:"AddWebpageToProject_PerfTimings",perfTimings:e}),g.delete(t)}}(e)}return!0}));export{_ as isAddWebpageToProjectEnabled,E as toggleAddWebpageToProjectContextMenu,I as handleAddWebpageToProjectContextMenu,P as handleAddWebpageToProjectAction,h as checkForBlockedDomain};