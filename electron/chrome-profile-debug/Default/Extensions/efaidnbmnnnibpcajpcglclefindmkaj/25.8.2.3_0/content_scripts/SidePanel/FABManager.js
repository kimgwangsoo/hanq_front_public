/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
class FABManager{constructor(){if(FABManager.instance)return FABManager.instance;FABManager.instance=this,this.shadowRoot=null,this.hasShownSettingsMenu=!1,this.actionableCoachmark=new ActionableCoachmark,this.isFABHiddenForNow=!1,this.fabCustomisationTimeout=void 0,this.registerOpenCloseListeners(),this.registerFABEnabledDisabledListeners(),this.cursorXPosition=null,this.cursorYPosition=null,this.logFABShown(),this.genAIFabTopPosition=window.dcLocalStorage.getItem("genAIFabTopPosition"),this.enableFabDrag=window.dcLocalStorage.getItem("enableFabDrag"),this.enableFabAutoPositioning=window.dcLocalStorage.getItem("enableFabAutoPositioning"),this.isFABDragging=!1}async logFABShown(){await GenAIWebpageEligibilityService.shouldDisableTouchpoints()?this.sendAnalyticsEvent([["DCBrowserExt:SidePanel:FabIcon:Disabled"]]):(this.sendAnalyticsEvent([["DCBrowserExt:SidePanel:FabIcon:Enabled"]]),chrome.runtime.sendMessage({main_op:"log-info",log:{message:"FAB enabled"}}))}registerOpenCloseListeners(){chrome.runtime.onMessage.addListener((async e=>{switch(e.action){case"sidepanel_opened":this.removeFAB();break;case"sidepanel_closed":await GenAIWebpageEligibilityService.shouldShowTouchpoints()&&this.renderFAB()}}))}async registerFABEnabledDisabledListeners(){chrome.storage.onChanged.addListener((({enableGenAIFab:e},t)=>{"local"===t&&e&&("false"===e.newValue?this.removeFAB():this.renderFAB())}))}sendAnalyticsEvent=(e,t)=>{try{chrome.runtime.sendMessage({main_op:"analytics",analytics:e})}catch(e){}};isFABRendered(){return Boolean(this.shadowRoot)}removeFAB(){this.shadowRoot?.host?.remove(),this.shadowRoot=null,this.hasShownSettingsMenu=!1}makeFABTransparent(){const e=this.shadowRoot?.querySelector(".acrobat-button-container");e?.classList?.contains("acrobat-button-container-transparent")||e?.classList?.add("acrobat-button-container-transparent")}makeFABOpaque(){const e=this.shadowRoot?.querySelector(".acrobat-button-container");e?.classList?.contains("acrobat-button-container-transparent")&&e?.classList?.remove("acrobat-button-container-transparent")}collapseFAB(){const e=this.shadowRoot?.querySelector(".close-btn"),t=this.shadowRoot?.querySelector(".tooltip-text"),o=this.shadowRoot?.querySelector(".acrobat-button");e&&t&&o&&!this.hasShownSettingsMenu&&(e.classList.remove("showCloseButton"),t?.classList?.remove("show-tooltip"),o?.classList.remove("expand-acrobat-button"))}customiseFABOpacity(){let e,t;document.addEventListener("scroll",(()=>{this.makeFABTransparent(),t&&clearTimeout(t),t=setTimeout((()=>{this.cursorXPosition>.8*window.innerWidth&&this.makeFABOpaque(),t=void 0}),50)})),document.addEventListener("mousemove",(async t=>{if(this.cursorXPosition=t.clientX,this.cursorXPosition>.8*window.innerWidth){if(e)return;e=setTimeout((async()=>{await GenAIWebpageEligibilityService.shouldShowTouchpoints()&&!this.isFABDragging&&this.makeFABOpaque(),e=void 0}),200)}else e&&(clearTimeout(e),e=void 0)}))}customiseFABVisibility(){let e;const t=()=>{if(""!==this.genAIFabTopPosition)return document.removeEventListener("mousemove",o),void document.removeEventListener("scroll",t);this.isFABRendered()&&this.cursorYPosition<=.6*window.innerHeight&&this.removeFAB()},o=async t=>{if(this.cursorYPosition=t.clientY,!this.isFABRendered()&&this.cursorYPosition>.6*window.innerHeight){if(e)return;e=setTimeout((async()=>{await GenAIWebpageEligibilityService.shouldShowTouchpoints()&&this.renderFAB({fadeIn:!0}),e=void 0}),200)}else e&&(clearTimeout(e),e=void 0)};document.addEventListener("scroll",t),document.addEventListener("mousemove",o)}async shouldRenderFAB(){const e=chrome.runtime.sendMessage({type:"get_sidepanel_state"});return await initDcLocalStorage(),!(await e).isOpen&&(isEmbeddedPDFTouchPointRendered()?(chrome.runtime.sendMessage({main_op:"log-info",log:{message:"FAB not rendered due to embedded PDF",domain:new URL(window.location.href).hostname}}),!1):"true"===window.dcLocalStorage.getItem("enableGenAIFab"))}_computeCursorCoordinates(){const e=document.createElement("div");e.id="invisibleElem",e.style.background="transparent",e.style.height="100vh",e.style.width="100vw",e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.zIndex="1000",e.setAttribute("aria-hidden","true"),document.body.appendChild(e);const t=()=>{e.parentNode&&e.parentNode.removeChild(e)};e.addEventListener("mouseenter",(e=>{this.cursorXPosition=e.clientX,this.cursorYPosition=e.clientY,t()})),setTimeout((()=>{t()}),100)}generateUUID(){try{let e=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(t){let o=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===t?o:3&o|8).toString(16)}))}catch(e){return Math.random()}}rePositionFABIfOverlapping(e){const t=getClickableOverlappingElement(e);if(!t?.length)return;let o=Number.MAX_SAFE_INTEGER;if(t.forEach((e=>{const t=e.getBoundingClientRect();t.top<o&&(o=t.top)})),o===Number.MAX_SAFE_INTEGER)return;const s=e.getBoundingClientRect().height,i=o-s-36,n=this.shadowRoot?.querySelector(".acrobat-button-container");n&&(n.style.top=`${i}px`,n.style.bottom="auto")}enableFABDragging(){let e=0;const t=this.shadowRoot?.querySelector(".draggable-handle"),o=this.shadowRoot?.querySelector(".acrobat-button-container"),s=e=>{""!=e&&null!=e&&(o.style.top=`${e}px`,o.style.bottom="auto")};s(this.genAIFabTopPosition),o.addEventListener("mouseover",(()=>{t.classList.add("draggable-handle-visible")})),o.addEventListener("mouseout",(()=>{t.classList.remove("draggable-handle-visible")})),t.addEventListener("mousedown",(s=>{s.stopImmediatePropagation(),s.preventDefault(),this.hideSettingsMenu(),this.collapseFAB(),this.isFABDragging=!0,t.classList.add("draggable-handle-visible");const i=o.getBoundingClientRect();e=s.clientY-i.top}));document.addEventListener("mousemove",(t=>{if(!this.isFABDragging)return;let i=t.clientY-e;const n=o.offsetHeight,a=window.innerHeight-n-20;i=Math.max(20,Math.min(a,i)),this.genAIFabTopPosition=i,s(this.genAIFabTopPosition)})),document.addEventListener("mouseup",(()=>{this.isFABDragging&&(window.dcLocalStorage.setItem("genAIFabTopPosition",this.genAIFabTopPosition),t.classList.remove("draggable-handle-visible"),this.isFABDragging=!1,this.genAIFabTopPosition&&(this.sendAnalyticsEvent([["DCBrowserExt:SidePanel:FabIcon:Dragged"]]),chrome.runtime.sendMessage({main_op:"log-info",log:{message:"FAB dragged",fabTop:`${this.genAIFabTopPosition}px`}})))}))}async enableFABCustomisation({enableHoveredState:e=!1,hoveredStateTimeout:t=""}){const o=await chrome.runtime.sendMessage({main_op:"getFloodgateFlag",flag:"dc-sp-fab-behaviour-exp-opacity"}),s=o?"Opacity":"Visibility";window.dcLocalStorage.setItem("fabVariant",s);const i=o?()=>this.customiseFABOpacity():()=>this.customiseFABVisibility();this.fabCustomisationTimeout=setTimeout(i,e?t:200)}async renderFAB(e={}){const{fadeIn:t=!1,enableHoveredState:o=!1,hoveredStateTimeout:s=7e3}=e;if(this.isFABHiddenForNow||this.actionableCoachmark.isRendered())return;if(!await this.shouldRenderFAB())return;if(this.isFABRendered())return;const i=document.createElement("div");i.id="aiFabShadowRoot",i.style.display="block",t&&(i.style.opacity="0",i.style.transition="opacity 0.4s ease-out, transform 0.4s ease-out"),this.shadowRoot=i.attachShadow({mode:"open"}),fetch(chrome.runtime.getURL("resources/SidePanel/sidePanelButton.html")).then((e=>e.text())).then((async e=>{const n=document.createElement("template");n.innerHTML=e;const a=n.content;this.shadowRoot?.appendChild(a.cloneNode(!0));const r=this.shadowRoot?.querySelector(".close-btn"),d=this.shadowRoot?.querySelector(".acrobat-button"),l=this.shadowRoot?.querySelector(".tooltip-text"),c=this.shadowRoot?.querySelector(".tooltip-text span:first-child"),h=(e=1e3)=>{d?.classList.add("expand-acrobat-button"),r?.classList.add("showCloseButton"),l?.classList.add("show-tooltip"),setTimeout((()=>{r?.classList.remove("showCloseButton"),l?.classList.remove("show-tooltip"),d?.classList.remove("expand-acrobat-button")}),e)};this.enableFabDrag&&this.enableFABDragging(),this.enableFabAutoPositioning&&!this.genAIFabTopPosition?(d.style.visibility="hidden",requestAnimationFrame((()=>requestAnimationFrame((()=>setTimeout((()=>{this.rePositionFABIfOverlapping(d),d.style.visibility="visible",o&&h(s)}),500)))))):o&&h(s),this.shadowRoot?.querySelector(".acrobat-button-container").addEventListener("mousedown",(async()=>{if(this.hideSettingsMenu(),!await GenAIWebpageEligibilityService.shouldDisableTouchpoints()){this.sendAnalyticsEvent([["DCBrowserExt:SidePanel:FabIcon:Clicked"]]);const e=this.generateUUID();await initDcLocalStorage(),window.dcLocalStorage.setItem("sidePanelUUID",e),chrome.runtime.sendMessage({type:"open_side_panel",touchpoint:"FAB"}),chrome.runtime.sendMessage({main_op:"log-info",log:{message:"FAB clicked",url:window.location.href}}),setTimeout((()=>{this.sendAnalyticsEvent([["DCBrowserExt:DebugSidePanel:FabIcon:Clicked"]],{uuid:e}),chrome.runtime.sendMessage({main_op:"log-info",log:{message:"Debug FAB clicked",url:window.location.href,uuid:e}})}),500)}})),await GenAIWebpageEligibilityService.shouldDisableTouchpoints()&&(d.classList.add("disabled"),c.id="tooltipTextDisabled"),d.addEventListener("mouseover",(()=>{this.isFABDragging||d.classList.contains("expand-acrobat-button")||(d.classList.add("expand-acrobat-button"),r.classList.add("showCloseButton"))})),d.addEventListener("mouseenter",(()=>{this.isFABDragging||r.classList.contains("showCloseButton")||r.classList.add("showCloseButton")})),d.addEventListener("mouseleave",(()=>this.collapseFAB())),r.addEventListener("click",(e=>{e.preventDefault(),e.stopPropagation(),this.hasShownSettingsMenu?this.hideSettingsMenu():this.showSettingsMenu()})),r.addEventListener("mousedown",(e=>{e.stopImmediatePropagation(),e.preventDefault()})),util.translateElements(".translate",this.shadowRoot),this.actionableCoachmark.isRendered()||document.documentElement.appendChild(i),t&&requestAnimationFrame((()=>requestAnimationFrame((()=>i.style.opacity="1"))))})),this.fabCustomisationTimeout||(this.cursorXPosition&&this.cursorYPosition||this._computeCursorCoordinates(),this.enableFABCustomisation({enableHoveredState:o,hoveredStateTimeout:s}))}hideSettingsMenu(){const e=this.shadowRoot?.querySelector(".close-btn");e?.classList.remove("open");const t=this.shadowRoot?.querySelector(".fab-view-settings-dialog");if(t){const e=this.shadowRoot?.querySelector(".tooltip-text");e&&(e.style.display="block");const t=this.shadowRoot?.querySelector(".fab-view-settings-dialog");t?.classList?.remove("showDialog")}this.hasShownSettingsMenu=!1}async hideFabForDomain(e){await initDcLocalStorage();const t=window.dcLocalStorage.getItem("hideFabDomainList")||[];t.includes(e)||t.push(e),window.dcLocalStorage.setItem("hideFabDomainList",t),chrome.runtime.sendMessage({main_op:"log-info",log:{message:"FAB hidden for domain",domain:e}})}async neverDisplayFab(){await initDcLocalStorage(),window.dcLocalStorage.setItem("enableGenAIFab","false")}_updateSettingsMenuPositionFromFAB(){const e=this.shadowRoot?.querySelector(".fab-view-settings-dialog"),t=this.shadowRoot?.querySelector(".acrobat-button"),o=this.shadowRoot?.querySelector(".acrobat-button-container"),s=t.offsetHeight,i=e.offsetHeight;o.getBoundingClientRect().top<i+10?(e.style.bottom="auto",e.style.top=`${s}px`):(e.style.bottom=`${s}px`,e.style.top="auto")}showSettingsMenu(){const e=this.shadowRoot?.querySelector(".close-btn");e.classList.add("open"),fetch(chrome.runtime.getURL("resources/SidePanel/FABViewSettings.html")).then((e=>e.text())).then((e=>{const t=this.shadowRoot?.querySelector(".tooltip-text");t&&(t.style.display="none");const o=this.shadowRoot?.querySelector(".fab-view-settings-dialog");o.innerHTML=e,o.classList.add("showDialog"),this.hasShownSettingsMenu=!0,util.translateElements(".translate",this.shadowRoot),this._updateSettingsMenuPositionFromFAB();const s=new URL(window.location.href).hostname;["hideForNow","hideFabForDomain","neverDisplayFab","preferences"].forEach((e=>{this.shadowRoot?.getElementById(e)?.addEventListener("click",(async()=>{switch(e){case"hideForNow":this.isFABHiddenForNow=!0,this.removeFAB(),this.sendAnalyticsEvent([["DCBrowserExt:SidePanel:SettingsMenu:RemoveFab"]]);break;case"hideFabForDomain":this.hideFabForDomain(s),this.isFABHiddenForNow=!0,this.removeFAB(),this.sendAnalyticsEvent([["DCBrowserExt:SidePanel:SettingsMenu:RemoveFabForDomain"]]);break;case"neverDisplayFab":this.neverDisplayFab(),this.removeFAB(),this.sendAnalyticsEvent([["DCBrowserExt:SidePanel:SettingsMenu:NeverDisplay"]]);break;case"preferences":window.dcLocalStorage.setItem("optionsPageSource","FAB_MENU"),chrome.runtime.sendMessage({type:"open_options_page"}),this.sendAnalyticsEvent([["DCBrowserExt:SidePanel:SettingsMenu:PreferencesClicked"]])}}))}))}))}}