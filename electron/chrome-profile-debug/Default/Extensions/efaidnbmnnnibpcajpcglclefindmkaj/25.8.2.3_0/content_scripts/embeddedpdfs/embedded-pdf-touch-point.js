/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
const sendAnalytics=(e,t)=>{try{t={...t,domain:domain},chrome.runtime.sendMessage({main_op:"analytics",analytics:[[e,t]]})}catch(e){}};let domain="";if(window.self!==window.top){const e={},t="acrobat-embedded-pdf-touch-point",n="acrobat-embedded-pdf-touch-point-context-menu",o="acrobat-embedded-pdf-touch-point-drag-handle",d="acrobat-embedded-pdf-touch-point-drag-handle-visible",a=20;let s=!1,c=0,i=null;const r=e=>{const t=document.createElement("div");return t.classList.add("acrobat-embedded-pdf-touch-point-tooltip"),t.innerText=e?.touchPointText||"Open in Acrobat",t},m=e=>{const t=document.createElement("div");return t.classList.add("acrobat-embedded-pdf-touch-point-tooltip"),t.innerText=e?.contextMenuTooltipText||"Preferences",t},l=()=>{const e=document.createElement("img");return e.setAttribute("src",chrome.runtime.getURL("browser/images/acrobat_dc_trefoil_24_white.svg")),e.classList.add("acrobat-embedded-pdf-icon"),e},u=()=>{const e=document.createElement("img");return e.setAttribute("src",chrome.runtime.getURL("browser/images/SDC_ShowMenu_18_N_24Canvas.svg")),e.classList.add("acrobat-embedded-pdf-touch-point-context-menu-icon"),e},p=()=>{document.getElementsByClassName("acrobat-fte-tooltip-container")?.length>0&&document.getElementsByClassName("acrobat-fte-tooltip-container")[0]?.remove()},h=()=>{const e=document.createElement("div");return e.classList.add("acrobat-embedded-pdf-drag-shield"),e},b=(e,t)=>{if("Enter"===e.key||" "===e.key||"click"===e.type){sendAnalytics("DCBrowserExt:EmbeddedPDF:TouchPoint:Clicked"),chrome.storage.local.set({embeddedPDFTouchPointFTEState:{touchPointClicked:!0}});const e=new URL(t);e.searchParams.set("acrobatPromotionSource","embeddedPDF"),window.open(e.toString()),p()}},g=e=>{e.classList.remove("has-open-menu");const t=document.getElementsByClassName(n)?.length>0&&document.getElementsByClassName(n)[0];t&&t.remove()},E=(e,t)=>{const n=document.createElement("div");return n.textContent=e,n.classList.add("acrobat-embedded-pdf-touch-point-context-menu-item"),n.addEventListener("click",t),n},C=(e,n)=>E(e?.menuItemStrings?.hideIconForNow,(()=>{document.getElementsByClassName(t)?.length>0&&document.getElementsByClassName(t)[0].remove(),sendAnalytics("DCBrowserExt:EmbeddedPDF:HideNow:Clicked"),g(n)})),f=()=>{const e=document.createElement("hr");return e.classList.add("acrobat-embedded-pdf-touch-point-context-menu-item-separator"),e},w=(e,t)=>E(e?.menuItemStrings?.openPDFInAcrobat,(e=>{b(e,window.location.href),sendAnalytics("DCBrowserExt:EmbeddedPDF:OpenInAcrobat:Clicked"),g(t)})),y=(e,t)=>E(e?.menuItemStrings?.managePreferences,(async()=>{sendAnalytics("DCBrowserExt:EmbeddedPDF:ManagePreferences:Clicked"),await chrome.storage.local.set({optionsPageSource:"EMBEDDED_PDF_TOUCH_POINT"}),chrome.runtime.sendMessage({type:"open_options_page",highlightSection:["embedded-pdf-touchpoint-section"]}),g(t)})),v=(e,t)=>{const n=document.createElement("div");n.classList.add(o);const d=document.createElement("img");return d.setAttribute("src",chrome.runtime.getURL("browser/images/S_DragHandle_18_N.svg")),n.appendChild(d),n.addEventListener("mousedown",(o=>T(o,n,e,t))),n},D=e=>e.getBoundingClientRect().top<188?"bottom":"top",P=e=>{const t=document.createElement("div");t.classList.add(n);return"bottom"===D(e)&&(t.style.bottom="auto",t.style.top="34px"),t},L=(e,t,o,d)=>{if(e.getElementsByClassName(n)&&e.getElementsByClassName(n)[0])t.style.removeProperty("background"),sendAnalytics("DCBrowserExt:EmbeddedPDF:Menu:Closed"),g(d);else{sendAnalytics("DCBrowserExt:EmbeddedPDF:Menu:Clicked");const t=P(d),n=w(o,d),a=C(o,d),s=y(o,d),c=f();t.appendChild(n),t.appendChild(c),t.appendChild(a),t.appendChild(s),e.appendChild(t),d.classList.add("has-open-menu")}},F=e=>{const t=document.createElement("div");t.classList.add("acrobat-embedded-pdf-icon-container");const n=l();t.appendChild(n);const o=r(e);return t.appendChild(o),t.addEventListener("click",(e=>b(e,window.location.href))),t},x=(e,t)=>{const n=document.createElement("div");n.classList.add("acrobat-embedded-pdf-touch-point-context-menu-container");const o=u();n.appendChild(o);const d=m(e);return n.appendChild(d),o.addEventListener("click",(()=>L(n,o,e,t))),n},B=e=>{const n=document.createElement("div");n.classList.add("acrobat-embedded-pdf-touch-point-container-wrapper");const o=document.createElement("button");o.classList.add(t);const d=F(e);o.appendChild(d);const a=x(e,o);o.appendChild(a);const s=v(n,o);return o.appendChild(s),o.addEventListener("keydown",(e=>b(e,window.location.href))),n.appendChild(o),n},T=(e,t,n,o)=>{e.stopImmediatePropagation(),e.preventDefault(),s=!0,t.classList.add(d),g(o);const a=n.getBoundingClientRect();c=e.clientY-a.top;const i=h();A(i,n,t),document.documentElement.appendChild(i)},A=(e,t,n)=>{e?.addEventListener("mousemove",(e=>N(e,t))),i=()=>k(n,e),e?.addEventListener("mouseup",i),document.documentElement.addEventListener("mouseleave",i)},N=(e,t)=>{const n=_(e.clientY,t);t.style.top=`${n}px`,t.style.bottom="auto"},_=(e,t)=>{const n=e-c,o=window.innerHeight-t.offsetHeight-a;return Math.max(a,Math.min(o,n))},k=(e,t)=>{s&&(s=!1,e.classList.remove(d),t?.remove(),document.documentElement.removeEventListener("mouseleave",i),i=null)},S=async e=>{if(e?.enableEmbeddedPDFTouchPoint){const t=B(e);document.documentElement.appendChild(t),sendAnalytics("DCBrowserExt:EmbeddedPDF:TouchPoint:Shown");const n=t?.getBoundingClientRect(),o=window?.frameElement?.getBoundingClientRect();chrome.runtime.sendMessage({main_op:"embedded-pdf-touch-point-added",frameId:e?.frameId,position:{top:n.top+o?.top,left:n.left+o?.left,right:n.right,bottom:n.bottom}})}},M=async()=>{const e=await import(chrome.runtime.getURL("content_scripts/gsuite/fte-utils.js")),n=await chrome.runtime.sendMessage({main_op:"embedded-pdf-touch-point-config"}),o=document.getElementsByClassName(t),d=document.getElementsByClassName("acrobat-fte-tooltip");if(o?.length>0&&0===d?.length){const t=e.createFteTooltip(n?.fteToolTipStrings,"embeddedPDF");o[0].appendChild(t),sendAnalytics("DCBrowserExt:EmbeddedPDF:FTE:Shown");t.querySelector(".acrobat-fte-tooltip-button").addEventListener("click",(()=>{t?.remove(),sendAnalytics("DCBrowserExt:EmbeddedPDF:FTE:Closed")})),e?.updateFteToolTipCoolDown(n?.touchPointConfig?.tooltip,"embeddedPDFTouchPointFTEState"),t.addEventListener("mouseenter",(e=>{e.stopPropagation(),e.preventDefault()}),{capture:!0})}},R=async()=>{if(!e?.adobeCleanFontAdded){const t=chrome.runtime.getURL("browser/css/fonts/AdobeClean-Regular.otf"),n=new FontFace("AdobeClean-Regular",`url(${t})`);await n.load(),document.fonts.add(n),e.adobeCleanFontAdded=!0}},I=async()=>{const e=await chrome.runtime.sendMessage({main_op:"embedded-pdf-touch-point-config"});e?.touchPointConfig?.blockedDomains?.includes(domain)||(e?.enableEmbeddedPDFTouchPoint&&sendAnalytics("DCBrowserExt:EmbeddedPDF:TouchPoint:Enabled"),window.innerHeight<250||window.innerWidth<201?sendAnalytics("DCBrowserExt:EmbeddedPDF:TopNavNotPresent:WidthHeight"):(await R(),S(e)))};if(chrome.runtime.onMessage.addListener((e=>{"add-fte-for-embedded-pdf-touch-point"===e?.type&&M()})),document?.contentType?.includes("application/pdf")){const e=new URL(window.location.href),t=e?.hash?.includes("toolbar=0");domain=e.hostname;let n="Unknown";document.body?.childNodes?.length>0&&document.body.childNodes[0]?.getAttribute?.("src")?.startsWith("chrome-extension://dahenjhkoodjbpjheillcadbppiidmhp")?n="GoogleScholar":document.body?.childNodes?.length>0&&"about:blank"===document.body.childNodes[0]?.getAttribute?.("src")&&(n="NativeViewer"),sendAnalytics("DCBrowserExt:Viewer:Detected:EmbeddedPDF:IframeContentType",{eventContext:`${n}-${!t}`}),I()}}