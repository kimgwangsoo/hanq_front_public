/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
import{createAcrobatIconElement,createURLForAttachment,sendAnalyticsEvent}from"./util.js";import state from"./state.js";import{getFileDetails,getAnalyticsType,getFileDetailsElementInNativeViewer,getParentElementForNativeViewerPrompt,isOrphanContentScript}from"./native-viewer-touch-point-service.js";import{acrobatTouchPointClicked}from"../gsuite/fte-utils.js";const ACROBAT_NON_PDF_PROCESSED="acrobat-icon-added",GMAIL_CONVERT_TO_PDF_NATIVE_VIEWER="acrobat-native-viewer-prompt",GMAIL_CONVERT_TO_PDF_VERB_FTE_TOOLTIP_STORAGE_KEY="acrobat-gmail-convert-to-pdf-verb-fte-config",createNativeViewTouchpointTextElement=()=>{const e=document.createElement("span");return e.classList.add("acrobat-native-viewer-prompt-text"),e.textContent=state?.gmailConvertToPdfConfig?.acrobatTouchPointText,e},createNativeViewerTouchpoint=(e,t,o)=>{const i=document.createElement("a"),n=createAcrobatIconElement(),r=createNativeViewTouchpointTextElement();let a;return a=createURLForAttachment(e,"Gmail",t,"createpdf"),i.classList.add("acrobat-native-viewer-prompt"),i.setAttribute("href",a),i.setAttribute("target","_blank"),i.appendChild(n),i.appendChild(r),i.addEventListener("click",(()=>{const t=getAnalyticsType(e,o);sendAnalyticsEvent("DCBrowserExt:DirectVerb:CTA:Clicked",{source:`Gmail_${t}`,workflow:"ConvertToPdf"}),acrobatTouchPointClicked("acrobat-gmail-convert-to-pdf-verb-fte-config"),state.fteToolTip.eligibleFte.type="",state.fteToolTip.touchPointClicked=!0})),i},addTouchPointInNativeViewer=(e,t,o)=>{try{const{convertToPdfVisible:i}=state?.convertToPdfState;if(i)return;const n=document.getElementsByClassName("acrobat-native-viewer-prompt");if(n?.length>0)return;const r=createNativeViewerTouchpoint(e,t,o),a=getParentElementForNativeViewerPrompt();if(a&&a?.childNodes?.length>0){a.insertBefore(r,a.childNodes[0]),state.convertToPdfState.convertToPdfVisible=!0,state.convertToPdfState.convertToPdfAttachmentURL=e,state.convertToPdfState.convertToPdfAttachmentName=t,state.convertToPdfState.previousFileDetailsElement=getFileDetailsElementInNativeViewer();const i=getAnalyticsType(e,o);sendAnalyticsEvent("DCBrowserExt:DirectVerb:CTA:Shown",{source:`Gmail_${i}`,workflow:"ConvertToPdf"}),window.innerWidth>1200&&chrome.runtime.sendMessage({main_op:"reRenderShowOneChild"})}else removeNativeViewerTouchPoint()}catch(e){removeNativeViewerTouchPoint()}},processForNativeViewer=(e,t)=>{const o=getFileDetailsElementInNativeViewer();if(o&&!isOrphanContentScript()){const i=getFileDetails(o);if(state?.convertToPdfState?.convertToPdfVisible&&state?.convertToPdfState?.convertToPdfAttachmentURL===e?.url)return;if(e?.name&&i&&e?.name!==i.title)return;addTouchPointInNativeViewer(e?.url,i.title,t)}else removeNativeViewerTouchPoint()},handleCommonClickAction=(e,t,o)=>{("click"===e.type||"keydown"===e.type&&"Enter"===e.key)&&setTimeout((()=>processForNativeViewer(t,o)),800)},addCommonClickListener=(e,t,o,i=null)=>{if(!e)return;const n=e=>handleCommonClickAction(e,t,o),r=i&&i instanceof AbortSignal?{signal:i}:{};e.addEventListener("click",n,r),e.addEventListener("keydown",n,r)},markElementAsProcessed=e=>{e&&e.setAttribute("acrobat-icon-added","Y")},removeNativeViewerTouchPoint=()=>{if(!state.convertToPdfState?.convertToPdfVisible)return;const e=document.getElementsByClassName("acrobat-native-viewer-prompt");e?.length>0&&e[0].parentElement.removeChild(e[0]),state.convertToPdfState.convertToPdfVisible=!1},processForAlreadyShownNativeViewerTouchpoint=()=>{const{convertToPdfVisible:e,previousFileDetailsElement:t,convertToPdfAttachmentURL:o,convertToPdfAttachmentName:i}=state?.convertToPdfState;if(e){const e=getFileDetailsElementInNativeViewer();e?e!==t&&removeNativeViewerTouchPoint():(state.convertToPdfState.convertToPdfAttachmentURL=null,state.convertToPdfState.convertToPdfAttachmentName=null,removeNativeViewerTouchPoint())}else if(t&&!isOrphanContentScript()){const e=getFileDetailsElementInNativeViewer();e&&t===e&&addTouchPointInNativeViewer(o,i,"nativeViewer")}};export{ACROBAT_NON_PDF_PROCESSED,removeNativeViewerTouchPoint,processForAlreadyShownNativeViewerTouchpoint,markElementAsProcessed,addCommonClickListener};