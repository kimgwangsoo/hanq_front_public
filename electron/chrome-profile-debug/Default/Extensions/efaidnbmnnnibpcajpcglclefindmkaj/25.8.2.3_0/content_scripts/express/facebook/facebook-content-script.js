/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
class FacebookExpressIntegration{previewEntryPointId="facebook-preview-adobe-express-entry-point";previewedImageClassname=["x15mokao x1ga7v0g x16uus16 xbiv7yw x193iq5w x4fas0m x19kjcj4"];previewHeaderClassname=["x9f619 x1ja2u2z x78zum5 x2lah0s x1n2onr6 x13a6bvl x1qjc9v5 xozqiw3 x1q0g3np xpdmqnj x1g0dm76 xyamay9 x1ws5yxj xw01apr x4cne27 xifccgj"];marketPlaceContainerClassname=["x6s0dn4 x78zum5 x1iyjqo2 xl56j7k x6ikm8r x10wlt62 xh8yej3 x1ja2u2z"];marketPlaceImageClassname=["xz74otr x15mokao x1ga7v0g x16uus16 xbiv7yw"];marketPlacePreview=!1;marketPlaceButtonClassName="facebookMarketPlacePreview";touchpoint="facebookPreview";shownTouchpointOnce=!1;minifiedButton=!1;launchExpress=(e,t,n)=>{chrome.runtime.sendMessage({main_op:"launch-express",imgUrl:e,intent:n,touchpoint:t})};sendAnalyticsEvent=e=>{try{chrome.runtime.sendMessage({main_op:"analytics",analytics:e})}catch(e){}};sendErrorLog=(e,t)=>{chrome.runtime.sendMessage({main_op:"log-error",log:{message:e,error:t}})};async loadContentScripts(){const e=chrome.runtime.getURL("content_scripts/express/single-click-cta.js"),t=chrome.runtime.getURL("content_scripts/express/express-utils.js"),n=await Promise.all([import(e),import(t)]);this.ExpressCTAClass=n[0].default,this.expressUtils=n[1].default,this.expressCTA=new this.ExpressCTAClass}_getPreviewImageElementFromSelector=()=>this.expressUtils.getElementsFromClassNames(document,this.previewedImageClassname)[0];_getMarketPlaceImageElementFromSelector=()=>{const e=this.expressUtils.getElementsFromClassNames(document,this.marketPlaceContainerClassname)[0];if(!e)return null;const t=this.expressUtils.getElementsFromClassNames(e,this.marketPlaceImageClassname)[0];return t&&"IMG"===t.tagName?t:null};_getImageElement=()=>this.marketPlacePreview?this._getMarketPlaceImageElementFromSelector():this._getPreviewImageElementFromSelector(this.previewedImageClassname);_getPreviewImageAndHeaderElementFromSelector=()=>{let e=null;const t=this._getPreviewImageElementFromSelector(this.previewedImageClassname);if(!t)return{imageElement:t,headerElement:e};for(let n of this.previewHeaderClassname){const s=document.getElementsByClassName(n);if(s.length>0)for(let n of s)if(n?.parentElement?.parentElement?.contains(t)){e=n;break}}return{imageElement:t,headerElement:e}};_getMarketPlaceImageAndContainerElementFromSelector=()=>{const e=this.expressUtils.getElementsFromClassNames(document,this.marketPlaceContainerClassname)[0];if(!e)return{imageElement:null,marketPlaceContainer:null};const t=this._getMarketPlaceImageElementFromSelector();return t?{imageElement:t,marketPlaceContainer:e}:{imageElement:null,marketPlaceContainer:null}};addButtonClass=e=>{this.marketPlacePreview&&e.classList.add(this.marketPlaceButtonClassName)};addThumbnailAndImagePreviewerObserver=()=>{new MutationObserver((()=>{this.config.enableFacebookPreviewExpressMenu&&this.imagePreviewerObserverHandler()})).observe(document.body,{childList:!0,subtree:!0})};previewEntryPointClickHandler=e=>{if(!chrome?.runtime?.id)return void this.cleanup();const t=this._getImageElement();if(!t||"IMG"!==t.tagName)return void this.sendErrorLog("Error executing express in facebook","image element not found");const n=t.src;n?this.launchExpress(n,this.touchpoint,e):this.sendErrorLog("Error executing express in facebook","image URL not found")};toggleButtonSize=(e,t=document)=>{const n=t.getElementsByClassName("cc440d50ba-express-entrypoint-button-text")[0];if(!n)return;n.classList?.toggle("minified",e);const s=t.getElementsByClassName("cc440d50ba-express-entrypoint-button-icon")[0];s&&s.classList.toggle("minified",e)};imagePreviewerObserverHandler=()=>{if(!chrome?.runtime?.id)return void this.cleanup();if(document.getElementById(this.previewEntryPointId))return;let{imageElement:e,headerElement:t}=this._getPreviewImageAndHeaderElementFromSelector();t?this.marketPlacePreview=!1:(({imageElement:e,marketPlaceContainer:t}=this._getMarketPlaceImageAndContainerElementFromSelector()),this.marketPlacePreview=!0),t&&e&&"IMG"===e.tagName?(this.cleanupTooltip(),this.addPreviewEntryPoint(t,e,this.previewEntryPointId,this.previewEntryPointClickHandler),this.shownTouchpointOnce||(this.sendAnalyticsEvent([["DCBrowserExt:Express:Facebook:PreviewEntryPoint:Shown"]]),this.shownTouchpointOnce=!0)):this.cleanup()};buttonResizeHandler=()=>{const e=this._getImageElement(),t=document.getElementById(this.previewEntryPointId);if(!e||!t)return;const n=e.getBoundingClientRect(),s=t.getBoundingClientRect();0===s.width&&0===s.height||n.right>=s.left&&n.top<=s.bottom&&setTimeout((()=>{this.minifiedButton=!0,this.toggleButtonSize(this.minifiedButton)}),1e3)};tooltipDelayCallback=()=>this.minifiedButton?1500:400;addPreviewEntryPoint=async(e,t,n,s)=>{if(document.getElementById(n)||this.buttonRenderStarted)return;this.buttonRenderStarted=!0;const i=await this.expressCTA.renderMenuButton(s,this.touchpoint);if(i.id=n,this.addButtonClass(i),this.toggleButtonSize(this.minifiedButton,i),e.insertBefore(i,e.firstChild),this.tooltip=this.expressCTA.attachTooltip("bottom",this.tooltipDelayCallback),this.buttonRenderStarted=!1,t.addEventListener("load",(()=>{this.buttonResizeHandler()})),this.minifiedButton)return;const a=new MutationObserver((()=>{this.buttonResizeHandler(),this.minifiedButton&&a.disconnect()}));a.observe(e.parentElement.parentElement,{childList:!0,subtree:!0,attributes:!0});const r=new ResizeObserver((()=>{this.buttonResizeHandler(),this.minifiedButton&&r.disconnect()}));r.observe(e.parentElement.parentElement)};removePreviewEntryPoint=e=>{const t=document.getElementById(e);t&&t.remove()};cleanup=()=>{this.marketPlacePreview=!1,this.removePreviewEntryPoint(this.previewEntryPointId),this.cleanupTooltip()};cleanupTooltip=()=>{this.tooltip?.tooltip?.remove(),this.tooltip=null;const e=document.getElementsByClassName("cc440d50ba-tooltiptext");for(let t of e)t.remove()};init=async()=>{const e=await chrome.runtime.sendMessage({main_op:"facebook-express-init"});this.config=e,this.config.enableFacebookPreviewExpressMenu&&(this.previewedImageClassname=this.config.selectors?.previewedImageClassname||this.previewedImageClassname,this.previewHeaderClassname=this.config.selectors?.previewHeaderClassname||this.previewHeaderClassname,this.marketPlaceContainerClassname=this.config.selectors?.marketPlaceContainerClassname||this.marketPlaceContainerClassname,this.marketPlaceImageClassname=this.config.selectors?.marketPlaceImageClassname||this.marketPlaceImageClassname,await this.loadContentScripts(),this.addThumbnailAndImagePreviewerObserver())}}const facebookExpressIntegration=new FacebookExpressIntegration;facebookExpressIntegration.init();