<!DOCTYPE html>
<html>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script  src="//code.jquery.com/jquery-latest.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.1/jquery-ui.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>  
<link rel="stylesheet" href="//code.jquery.com/ui/1.13.1/themes/base/jquery-ui.css">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<script src="/socket.io/socket.io.js"></script>
<script src="https://fastly.jsdelivr.net/npm/sweetalert2@10"></script>
<!-- <script src="/sweetalert2/dist/sweetalert2.min.js"></script> -->
<!-- <script src="https://fastly.jsdelivr.net/npm/axios/dist/axios.min.js"></script> -->
<!-- <script src="/axios/dist/axios.js"></script> -->
<script src="/axios/dist/axios.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.js"></script>
<link href="/css/loading.css" rel="stylesheet" />
<!-- <script src="//cdn.rawgit.com/rainabba/jquery-table2excel/1.1.0/dist/jquery.table2excel.min.js"></script> -->
<script src="https://rawgit.com/unconditional/jquery-table2excel/master/src/jquery.table2excel.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.15.5/xlsx.full.min.js"></script>
<!-- FileSaver saveAs CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.min.js"></script>
<link rel="stylesheet" type="text/css" href="/css/guide.css">
<script src="/js/ajax_before_send.js"></script>
<head>
    <title><%= title %></title>
</head>
<script>
    function Mobile() {return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);}
</script>
<style>
    body{
        background: linear-gradient( to right, #ffffff, #ffffff);
    }

    .popbill_dom .flexc{
        display:flex;
        justify-content: center;
        align-items: center;
    }
    .popbill_dom .flext{
        display:flex;
        justify-content: center;
        align-items: flex-start;
    }
    .popbill_dom .flexs{
        display:flex;
        justify-content: flex-start;
        align-items: center;
    }
    .popbill_dom .flexe{
        display:flex;
        justify-content: flex-end;
        align-items: center;
    }
    .popbill_dom .flexcolc{
        display:flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }
    .popbill_dom .flexcols{
        display:flex;
        flex-direction: column;
        justify-content: center;
        align-items: flex-start;
    }
    .popbill_dom .flexcole{
        display:flex;
        flex-direction: column;
        justify-content: center;
        align-items: flex-end;
    }

    .popbill_dom .bb{
        border-bottom:1px solid #000;
    }
    .popbill_dom .br{
        border-right:1px solid #000;
    }
    .popbill_dom .bl{
        border-left:1px solid #000;
    }
    .popbill_dom .bd{
        border-bottom:1px solid #000;
    }
    .popbill_dom .bt{
        border-top:1px solid #000;
    }
    .popbill_dom .mbody{
        font-weight:bold;
        /*border:1px solid #000;*/
        width: 21cm;
        min-height: 29.7cm;
        /* padding: 1.5cm 1.5cm 2cm 1.5cm; */
    }
    .popbill_dom .a4table{
        width:100%;
        border-collapse: collapse;
        text-align: center;
    }

    .popbill_dom{
        position:absolute;
        top:-3500px;
        width: 210mm;
        height: 297mm;
        border: 1px solid black;
        background:#fff;
        z-index:9999999999;
        overflow-y: scroll;
    }

    /* .popbill_dom .tg  {border-collapse:collapse;border-spacing:0; width:100%;}
    .popbill_dom .tg td{border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;
    padding:5px 5px;word-break:normal;}
    .popbill_dom .tg th{border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;
    font-weight:normal;overflow:hidden;padding:8px 5px;word-break:normal;}
    .popbill_dom .tg .tg-lboi{text-align:left;vertical-align:middle}
    .popbill_dom .tg .tg-123x{font-size:100%;text-align:left;vertical-align:middle}
    .popbill_dom .tg .tg-9wq8{text-align:center;vertical-align:middle}
    .popbill_dom .tg .tg-baqh{text-align:center;vertical-align:top}
    .popbill_dom .tg .tg-0pky{text-align:left;vertical-align:top}
    .popbill_dom .tg .tg-0lax{text-align:left;vertical-align:top}
    .popbill_dom .tg .tg-lqy6{text-align:right;vertical-align:top}
    .popbill_dom .tg .tg-c3ow{text-align:center;vertical-align:middle}
    .popbill_dom .tg .tg-nrix{text-align:center;vertical-align:middle} */
    @font-face { 
        font-family: 'Material Icons'; 
        font-style: normal; 
        font-weight: 400; 
        src: url(path/to/MaterialIcons-Regular.eot); 
        /* For IE6-8 */ 
        src: 
        local('Material Icons'), 
        local('MaterialIcons-Regular'), 
    }
    .material-icons { 
        font-family: 'Material Icons'; 
        font-weight: normal; 
        font-style: normal; 
        font-size: 16px; /* Preferred icon size */ 
        display: inline-block; 
        line-height: 1; 
        text-transform: none; 
        letter-spacing: normal; 
        word-wrap: normal; 
        white-space: nowrap; 
        direction: ltr; /* Support for all WebKit browsers. */ 
        -webkit-font-smoothing: antialiased; /* Support for Safari and Chrome. */ 
        text-rendering: optimizeLegibility; /* Support for Firefox. */ 
        -moz-osx-font-smoothing: grayscale; /* Support for IE. */ 
        font-feature-settings: 'liga'; 
    }
    .title {
        display:flex;
        align-items: center;
        font-size:20px;
        font-weight: bold;
    }
    .title span{
        font-size:30px;
    }
    .search-form{
        display: flex;
        justify-content: center;
        padding:20px;
    }
    .search-form input:nth-child(1){
        width:250px;
        border:1px solid #000000;
        background:#ffffff;
        border-radius: 5px;
        height:40px;
    }
    .search-form input:nth-child(2),.search-form input:nth-child(3){
        background:#ffffff;
        border-radius: 5px;
        border:2px solid #000000;
        width:60px;
        margin-left: 5px;
        font-size:18px;
    }
    .search-form input:nth-child(2):hover,.search-form input:nth-child(3):hover{
        border:2px solid #CC414D;
        background:#fff;
        width:60px;
    }
    .maincontainer{
        display:flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width:100%;
        position: relative;
        padding-top:50px;
        padding-left:50px;
        padding-right:50px;
        padding-bottom: 100px;
    }
    /*.maincontainer::before{
        content : "";
        display: block;
        position: absolute;
        background-size: cover;
        top: 0;
        left: 0;
        background-image: url( "/img3" );
        width: 100%;
        height: 100%;
        opacity : 0.1;
        z-index: -1;
    }*/
    .topmenu{
        width:100%;
        font-size:15px;
    }
    .topmenu tr td{
        padding-bottom:15px;
    }
    .topmenu tr td:nth-child(1) span{
        width:100px;
        padding:10px;
        border:1px solid #000000;
        border-radius: 5px;
        background:#1a2136;
        font-weight:bold;
        cursor: pointer;
        color:#fff;
    }
    .footerbutton1{
        width:180px;
        padding:10px;
        border:1px solid #000000;
        border-radius: 5px;
        background:#ffffff;
        font-weight:bold;
        cursor: pointer;
    }
    .footerbutton1 span{
        font-size:15px;
    }
    .footerbutton1 span:nth-child(2){
        padding-left: 3%;
        font-size: 20px;
        color:#646464;
    }
    .topmenu tr td:nth-child(1) span:hover, .footerbutton1:hover{
        border:1px solid #CC414D;
        background:#fff;
        color:#000;
    }

    .topmenu tr td:nth-child(3) span{
        background:#ffffff;
        font-weight:bold;
        text-align: center;
        padding-right:15px;
    }
    .topmenu tr td:nth-child(3) .material-icons{
        font-size:25px;
    }
    .topmenu tr td:nth-child(3){
        display:flex;
        justify-content:flex-end;
        font-weight: bold;
    }
    .table{
        border-collapse: collapse;
        border:2px solid #000000;
    }
    .center td{
        text-align: center;
        font-weight:bold;
    }
    .table tr:nth-child(1){
        font-size:20px;
        background: #1a2136;
    }
    .table tr:nth-child(2){
        font-size:16px;
        background: #F2F2F2;
    }
    .pagingnum{
        border:1px solid #ffffff;
        padding:5px;
        border-radius: 4px;
        background:#ffffff;
    }
    .table tr:nth-child(1),.table tr:nth-child(2){
        border:2px solid #000000;
        font-weight: bold;
    }
    .table>tbody>tr>td{
        padding:6px;
        vertical-align: middle;
    }
    .footer{
        width:100%;
    }
    .flex{
        display: flex;
        justify-content: center;
        align-items: center;
    }
    .flexs{
        display: flex;
        justify-content: space-around;
        align-items: flex-start;
    }
    .flexstart{
        display: flex;
        justify-content: flex-start;
        align-items: center;
    }
    .flexbetween{
        display: flex;
        justify-content: space-around;
        align-items: center;
    }
    .flexcolumns{
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: flex-start;
    }

    /* Outer */
    .popup {
        width:100%;
        height:100%;
        display:none;
        position:fixed;
        top:0px;
        left:0px;
        background:rgba(0,0,0,0.3);
        z-index:9999;
    }

    /* Inner */
    .popup-inner {
        max-width:1700px;
        height:750px;
        width:100%;
        /*padding:40px;*/
        position:absolute;
        top:50%;
        left:50%;
        -webkit-transform:translate(-50%, -50%);
        transform:translate(-50%, -50%);
        box-shadow:0px 2px 6px rgba(0,0,0,1);
        border-radius:3px;
        background:#fff;
    }

    /* Close Button */
    .popup-close {
        width:30px;
        height:30px;
        padding-top:4px;
        display:inline-block;
        position:absolute;
        top:0px;
        right:0px;
        transition:ease 0.25s all;
        -webkit-transform:translate(50%, -50%);
        transform:translate(50%, -50%);
        border-radius:1000px;
        background:rgba(0,0,0,0.8);
        font-family:Arial, Sans-Serif;
        font-size:20px;
        text-align:center;
        line-height:100%;
        color:#fff;
    }

    .popup-close:hover {
        -webkit-transform:translate(50%, -50%) rotate(180deg);
        transform:translate(50%, -50%) rotate(180deg);
        background:rgba(0,0,0,1);
        text-decoration:none;
    }


        /* Outer */
    .popup2 {
        width:100%;
        height:100%;
        display:none;
        position:fixed;
        top:0px;
        left:0px;
        background:rgba(0,0,0,0.3);
        z-index:9999;
    }

    /* Inner */
    .popup2-inner {
        max-width:1700px;
        height:850px;
        width:100%;
        /*padding:40px;*/
        position:absolute;
        top:50%;
        left:50%;
        -webkit-transform:translate(-50%, -50%);
        transform:translate(-50%, -50%);
        box-shadow:0px 2px 6px rgba(0,0,0,1);
        border-radius:3px;
        background:#fff;
    }

    /* Close Button */
    .popup2-close {
        width:30px;
        height:30px;
        padding-top:4px;
        display:inline-block;
        position:absolute;
        top:0px;
        right:0px;
        transition:ease 0.25s all;
        -webkit-transform:translate(50%, -50%);
        transform:translate(50%, -50%);
        border-radius:1000px;
        background:rgba(0,0,0,0.8);
        font-family:Arial, Sans-Serif;
        font-size:20px;
        text-align:center;
        line-height:100%;
        color:#fff;
    }

    .popup2-close:hover {
        -webkit-transform:translate(50%, -50%) rotate(180deg);
        transform:translate(50%, -50%) rotate(180deg);
        background:rgba(0,0,0,1);
        text-decoration:none;
    }


    iframe{
        width:100%;
        height:100%;
    }

    .listcheckbox{
        width:40px;
        transform: scale(1.7);
        -ms-transform: scale(1.7); /* IE */
        -moz-transform: scale(1.7); /* FF */
        -webkit-transform: scale(1.7); /* Safari and Chrome */
        -o-transform: scale(1.7); /* Opera */
    }
    .red{
        color:#ff0000;
    }
    .green{
        color:#00923d;
    }
    .backred{
        background:#ff0000;
    }
    .backgreen{
        background:#00923d;
    }
    .msgpersonadd{
        height:50px;
        padding:10px;
        border:1px solid #122459;
        border-radius: 5px;
        background:#1a2136;
        color:#fff;
        cursor: pointer;
        margin-top:15px;
        margin-bottom:15px;
    }
    .msgpersonadd:hover{
        background:#fff;
        color:#000;
        border:1px solid #CC414D;
    }

    .msgpersonlist{
        position:relative;
    }

    .sendmsg_doc_make_cnt{
        position:absolute;

    }
    .msgpersonlistbox{
        width:350px;
        height:400px;
        border:1px solid #000;
        border-radius: 5px;
        background:#fff; 
        color:#000;
        overflow-y: scroll;
    }
    .sendmsg{
        font-size:20px;
    }

    .sendmsg span{
        font-size:30px;
        color:#002e13;
    }
    .msgnumber{
        margin-bottom:2px; 
        width:100%; 
        background:rgb(37, 37, 37); 
        color:rgb(255, 255, 255);
    }
    /* .swal2-styled.swal2-confirm,
    .swal2-styled.swal2-cancel {
        font-size: 2em;
    } */

    .swal2-popup {
    font-size: 1.3rem !important;
    }

    .msgselect{
        width:100%;
        height:50px;
    }

    .msgselect select{
        width:50%;
        height:50px;
        border-radius:5px;
    }

    .msgselect span:nth-child(1){
        width:100px;
    }
    .msgoption{
        width:20%;
    }

    .searchdetail{
        background: #ffffff;
        z-index: 999;
        width: 100%;
        display: flex;
        justify-content: center;
        position: absolute;
        width:550px;
        padding:20px;
        border:2px solid #003866;
        border-radius: 4px;
    }

    .searchdetail div table tr{
        display: flex;
    }
    .searchdetail div table tr td{
        padding:5px;
    }

    .searchdetail div table tr td:nth-child(1){
        width:100px;
    }

    .searchdetail div div{
        width:100%;
        margin-top:15px;
        padding:5px;
        border:1px solid #003866;
        background: #003866;
        border-radius: 5px;
        color:#ffffff;
        cursor: pointer;
    }
    .datepickerall{
        font-weight: bold;
        height:35px;
        width:11%;
        border-radius: 5px;
        text-align: center;
    }
    .datepickerall2 {
        font-weight: bold;
        height:35px;
        width:40%;
        border-radius: 5px;
        text-align: center;
    }
    .popup2-close{
        cursor: pointer;
    }
    .tablemenutop{
        width:100%;
        display:flex;
        justify-content: space-between;
        align-items: center;
    }
    .tablemenutop div{
        width:100%;
        display:flex;
        justify-content: center;
    }
    .tablemenutop ul{
        width:50%;
        display:flex;
        justify-content: center;
    }
    .topmenuright{
        color:#ffffff;
    }

    .topmenuright div span{
        font-size:16px;
        font-weight: bold;
        padding-right:10px;
    }
    .menu1 {
    display: block;
    position: relative;
    margin-bottom: 12px;
    cursor: pointer;
    font-size: 18px;
 
    }
    
    /* Hide the browser's default checkbox */
    .menu1 input {
    position: absolute;
    opacity: 0;
    cursor: pointer;
    height: 0;
    width: 0;
    }
    
    /* Create a custom checkbox */
    .checkmark {
    position: absolute;
    top: -7px;
    left: 0;
    height: 25px;
    width: 25px;
    background-color: #eee;
    }
    
    /* On mouse-over, add a grey background color */
    .menu1:hover input ~ .checkmark {
    background-color: #ccc;
    }
    
    /* When the checkbox is checked, add a "red" background */
    .menu1 input:checked ~ .checkmark {
    background-color: #e91b00e8;
    }
    
    /* Create the checkmark/indicator (hidden when not checked) */
    .checkmark:after {
    content: "";
    position: absolute;
    display: none;
    }
    
    /* Show the checkmark when checked */
    .menu1 input:checked ~ .checkmark:after {
    display: block;
    }
    
    /* Style the checkmark/indicator */
    .menu1 .checkmark:after {
    left: 9px;
    top: 5px;
    width: 6px;
    height: 11px;
    border: solid white;
    border-width: 0 3px 3px 0;
    -webkit-transform: rotate(45deg);
    -ms-transform: rotate(45deg);
    transform: rotate(45deg);
    } 
    @media (max-width: 1400px) {
        .popup-inner{
            max-width:92%;
            height:600px;
        }
        .popup2-inner {
          max-width: 92%;
          height: 600px;
        }

    }
    @media (max-width: 1600px) {
        .popup-inner{
            max-width:92%;
            height:700px;
        }
        .popup2-inner {
          max-width: 92%;
          height: 700px;
        }

    }
    @media (max-width: 600px) {
    body{
        font-size:10px;
    }
    .search-form input:nth-child(1) {
        width: 140px;
    }
    .topmenu{
        width:100%;
        font-size:10px;
        text-align: center;
    }
    .datepickerall {
        width:20%;
    }
    .table tr:nth-child(1){
        font-size: 15px;
    }
    .table tr:nth-child(2) {
        font-size: 10px;
    }
    .deliverytxtm{
        text-overflow: ellipsis;
        overflow: hidden;
        white-space: nowrap;
    }
    .maincontainer {
        padding-left: 20px;
        padding-right: 20px;
    }
    .tablemenutop {
        width: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    .table>tbody>tr>td {
        padding: 5px;
        vertical-align: middle;
    }
    .mname{
        width:15%;
    }
    .popup2-inner{
        max-width:350px;
        height:550px;
    }
    }
    .topline{
            position: fixed;
            top:0;
            width:100%;
            height:32px;
            background: #1a2136;
            z-index: 999;
    }

    .searchdetail{
        background: #ffffff;
        z-index: 999;
        width: 100%;
        display: flex;
        justify-content: center;
        position: absolute;
        width:550px;
        padding:20px;
        border:2px solid #003866;
        border-radius: 4px;
    }

    .searchdetail div table tr{
        display: flex;
    }
    .searchdetail div table tr td{
        padding:5px;
    }

    .searchdetail div table tr td:nth-child(1){
        width:100px;
    }

    .searchdetail div div{
        width:100%;
        margin-top:15px;
        padding:5px;
        border:1px solid #003866;
        background: #003866;
        border-radius: 5px;
        color:#ffffff;
        cursor: pointer;
    }
    .datepickerall{
        font-weight: bold;
        height:35px;
        width:11%;
        border-radius: 5px;
        text-align: center;
    }
    .datepickerall2 {
        font-weight: bold;
        height:35px;
        width:40%;
        border-radius: 5px;
        text-align: center;
    }
    .popup2-close{
        cursor: pointer;
    }
    .tablemenutop{
        width:100%;
        display:flex;
        justify-content: space-between;
        align-items: center;
    }
    .tablemenutop div{
        width:100%;
        display:flex;
        justify-content: center;
    }
    .tablemenutop ul{
        width:50%;
        display:flex;
        justify-content: center;
    }
    .topmenuright{
        color:#ffffff;
    }

    .topmenuright div span{
        font-size:16px;
        font-weight: bold;
        padding-right:10px;
    }
    .menu1 {
    display: block;
    position: relative;
    margin-bottom: 12px;
    cursor: pointer;
    font-size: 18px;
 
    }
    
    /* Hide the browser's default checkbox */
    .menu1 input {
    position: absolute;
    opacity: 0;
    cursor: pointer;
    height: 0;
    width: 0;
    }
    
    /* Create a custom checkbox */
    .checkmark {
    position: absolute;
    top: -7px;
    left: 0;
    height: 25px;
    width: 25px;
    background-color: #eee;
    }
    
    /* On mouse-over, add a grey background color */
    .menu1:hover input ~ .checkmark {
    background-color: #ccc;
    }
    
    /* When the checkbox is checked, add a "red" background */
    .menu1 input:checked ~ .checkmark {
    background-color: #e91b00e8;
    }
    
    /* Create the checkmark/indicator (hidden when not checked) */
    .checkmark:after {
    content: "";
    position: absolute;
    display: none;
    }
    
    /* Show the checkmark when checked */
    .menu1 input:checked ~ .checkmark:after {
    display: block;
    }
    
    /* Style the checkmark/indicator */
    .menu1 .checkmark:after {
    left: 9px;
    top: 5px;
    width: 6px;
    height: 11px;
    border: solid white;
    border-width: 0 3px 3px 0;
    -webkit-transform: rotate(45deg);
    -ms-transform: rotate(45deg);
    transform: rotate(45deg);
    } 
    @media (max-width: 1400px) {
        .popup-inner{
            max-width:92%;
            height:600px;
        }
        .popup2-inner {
          max-width: 92%;
          height: 600px;
        }

    }
    @media (max-width: 600px) {
    body{
        font-size:10px;
    }
    .search-form input:nth-child(1) {
        width: 140px;
    }
    .topmenu{
        width:100%;
        font-size:10px;
        text-align: center;
    }
    .datepickerall {
        width:20%;
    }
    .table tr:nth-child(1){
        font-size: 15px;
    }
    .table tr:nth-child(2) {
        font-size: 10px;
    }
    .deliverytxtm{
        text-overflow: ellipsis;
        overflow: hidden;
        white-space: nowrap;
    }
    .maincontainer {
        padding-left: 20px;
        padding-right: 20px;
    }
    .tablemenutop {
        width: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    .table>tbody>tr>td {
        padding: 5px;
        vertical-align: middle;
    }
    .mname{
        width:15%;
    }
    .popup2-inner{
        max-width:350px;
        height:550px;
    }
    }
    .topline{
            position: fixed;
            top:0;
            width:100%;
            height:32px;
            background: #1a2136;
            z-index: 999;
    }
    .pagination{
        cursor:pointer;
    }
    .filtercls{
        display:flex;
        justify-content: center;
        align-items: center;
        margin:1px;
        padding:3px;
        border:1px solid #000;
        border-radius: 5px;
        font-weight: bold;
    }

    .filterarr{
        display:flex;
        align-items: center;
        margin-bottom:5px;
    }
    .popbill_number_table{
        
    }

    .popbill_number_table tr td{
        text-align: center;
        padding-right:25px;
    }
    
    .popbill_msg_type{
        width:100%;
        cursor:pointer;
        padding:10px;
        margin-bottom:5px;
        border-radius: 5px;;
        box-shadow: 0 8px 9px -4px rgba(5, 20, 46, 0.3), 0 4px 18px 0 rgba(1, 13, 31, 0.2);
    }

    .popbill_msg_type:hover{
        opacity:0.8;
        box-shadow: 0 8px 9px -4px rgba(0, 0, 0, 0.3), 0 4px 18px 0 rgba(1, 13, 31, 0.2);

    }

    .popbill_msg_type_on{
        
        background: #1a2136;
        color:#fff;
    }

    .popbill_msg_type_off{
        background: #ffffff;
        color:rgb(0, 0, 0);
    }
    .popbill_msg_col{
        margin-bottom:20px;
    }
    .swal_msg_client_table{
        display:block;
        border-radius: 5px;
    }
    .swal_msg_client_table thead{
        border-radius: 5px;
    }
    .swal_msg_client_table thead tr th{
        font-size:20px;
        font-weight:bold;
        width: 150px;
        height:50px;
        text-align: center;
        background: #1a2136;
        color:#fff;
    }
    .swal_msg_client_table tbody{
        display: block;
        height: 500px;
        overflow: auto;
        width: 100%;
        border-radius:7px;
    }
    .swal_msg_client_table tbody tr {
        width: 100%;
        /* display: flex; */
        height:40px;
        justify-content: center;
        align-items: center;
        border-bottom: 1px solid #00000052;
        background: rgba(221, 221, 221, 0.274);
        font-size:15px;
    }

    .swal_msg_client_table tbody tr td {
      width: 150px; /* 원하는 너비로 조정하세요. */
    }

    .history_btn{
        font-weight:bold;
        cursor:pointer;
        padding:10px;
        margin-bottom:5px;
        border-radius: 5px;;
        box-shadow: 0 8px 9px -4px rgba(5, 20, 46, 0.3), 0 4px 18px 0 rgba(1, 13, 31, 0.2);
    }

    .history_btn:hover{
        opacity:0.8;
        box-shadow: 0 8px 9px -4px rgba(0, 0, 0, 0.3), 0 4px 18px 0 rgba(1, 13, 31, 0.2);

    }

    .msg_option{
        cursor:pointer;
        padding:10px;
        margin-bottom:5px;
        border-radius: 5px;;
        box-shadow: 0 8px 9px -4px rgba(5, 20, 46, 0.3), 0 4px 18px 0 rgba(1, 13, 31, 0.2);
    }

    .msg_option:hover{
        opacity:0.8;
        box-shadow: 0 8px 9px -4px rgba(0, 0, 0, 0.3), 0 4px 18px 0 rgba(1, 13, 31, 0.2);

    }

    .msg_option_on{
        background: #1a2136;
        color:#fff;
    }

    .msg_client{
        position:relative;
    }

    .sendmsg_make_doc_cnt{
        font-size:25px;
    }

    .reloading{
        display:none;
        z-index:99999;
        background: #fff;
        position: absolute;
        /* top: 35%; */
        left: 20%;
    }
    .sendnumber{
        color:#ff0000;
    }

    .popbill_msg_target2{
        display:none;
    }

    .popbill_msg_target2 table{
        display:block;
        border-radius: 5px;
    }
    .popbill_msg_target2 table thead{
        border-radius: 5px;
    }
    .popbill_msg_target2 table thead tr th{
        font-size:20px;
        font-weight:bold;
        width: 170px;
        height:50px;
        text-align: center;
        background: #1a2136;
        color:#fff;
    }
    .popbill_msg_target2 table tbody{
        display: block;
        height: 365px;
        overflow: auto;
        width: 100%;
        border-radius:7px;
    }
    .popbill_msg_target2 table tbody tr {
        width: 100%;
        /* display: flex; */
        height:40px;
        justify-content: center;
        align-items: center;
        border-bottom: 1px solid #00000052;
        background: rgba(221, 221, 221, 0.274);
        font-size:15px;
    }
    .msg_client_add, .msg_client_remove{
        cursor: pointer;
        display:flex;
        justify-content: center;
        align-items: center;
        width:50px;
        height:30px;
        border-radius:5px;
        box-shadow: 0 8px 9px -4px rgba(0, 0, 0, 0.3), 0 4px 18px 0 rgba(1, 13, 31, 0.2);
    }

    .msg_send_ok, .msg_send_cancle{
        cursor: pointer;
        display:flex;
        justify-content: center;
        align-items: center;
        width:80px;
        height:50px;
        border-radius:5px;
        box-shadow: 0 8px 9px -4px rgba(0, 0, 0, 0.3), 0 4px 18px 0 rgba(1, 13, 31, 0.2);
    }

    .msg_client_add, .msg_send_ok{
        background:rgb(48, 133, 214);
        color:#fff;
    }
    .msg_client_remove, .msg_send_cancle{
        background:rgb(221, 51, 51);
        color:#fff;
    }

    .msg_client_add:hover,.msg_client_button:hover, .msg_client_remove:hover, .msg_send_ok:hover, .msg_send_cancle:hover{
        opacity:0.8;
        box-shadow: 0 8px 9px -4px rgba(231, 172, 172, 0.3), 0 4px 18px 0 rgba(1, 13, 31, 0.2);
    }

    .msg_client_button{
        cursor: pointer;
        display:flex;
        justify-content: center;
        align-items: center;
        width:50px;
        height:30px;
        border-radius:5px;
        box-shadow: 0 8px 9px -4px rgba(0, 0, 0, 0.3), 0 4px 18px 0 rgba(1, 13, 31, 0.2);
    }

    .msg_send_confirm_chk_div{
        font-weight:bold;
        font-size:20px;
    }

    .reservation_div{
        font-weight:bold;
    }
    .msg_history_data{
        height:30px;
    }

    .swal_date input{
        width:120px;
        font-weight:bold;
        height:40px;
        text-align: center;
        background: #333;
        color: #fff;
        font-size: 20px;
        border-radius: 10px;
        border: none;
    }
    .swal_date_button{
        display:flex;
        align-items: center;
        justify-content: center;
        cursor:pointer;
        border-radius: 5px;
        font-weight: bold;
        width: 70px;
        margin-left:5px;
        height: 40px;
        box-shadow: 0 8px 9px -4px rgb(59 113 202 / 30%), 0 4px 18px 0 rgb(59 113 202 / 20%);
    }
    .swal_date_button:hover{
        box-shadow: 0 8px 9px -4px rgba(5, 20, 46, 0.3), 0 4px 18px 0 rgba(1, 13, 31, 0.2);
        opacity:0.8;
    }

    .swal_top_search{
        height:40px;
        width: 220px;
        font-size: 13px;
        border-radius:5px;
    }

    .swal_date_button_on{
        background:#333;
        color:#fff;
    }
    .msg_content_view{
        position:absolute;
        width:1000px;
        height:400px;
        top: 50%;
        left: 50%;
        margin: -200px 0 0 -500px;
        display:flex;
        flex-direction: column;
        justify-content: space-between;
        align-items: center;
        background:#fff;
        box-shadow: 0 8px 9px -4px rgba(5, 20, 46, 0.3), 0 4px 18px 0 rgba(1, 13, 31, 0.2);
        border-radius: 5px;
    }

    .msg_content_data{
        width: 100%;
        display:flex;
        justify-content: center;
        align-items: center;
        font-weight:bold;
        padding:40px;
    }

    .msg_content_top{
        width: 100%;
        height:100px;
        display:flex;
        justify-content: space-around;
        align-items: center;
        font-weight:bold;
    }

    .msg_content_bottom{
        width: 100%;
        display:flex;
        justify-content: center;
        align-items: center;
        font-weight:bold;
    }

    .msg_content_bottom div{
        width: 100px;
        height:40px;
        margin-bottom:10px;
        background:#d63c3c;
        color:#fff;
        border-radius: 5px;
        display:flex;
        justify-content: center;
        align-items: center;
        cursor:pointer;
    }

    .msg_content_bottom div:hover{
        opacity:0.8;
    }

    .swal2-content {
        z-index: 2;
    }
    .tg  {
        border-collapse:collapse;
        border-spacing:0;
    }

    .tg th{
        border-color:black;
        border-style:solid;
        border-width:1px;
        font-family:Arial, sans-serif;
        font-size:14px;
        font-weight:normal;
        overflow:hidden;
        padding:10px 5px;
        word-break:normal;
    }
    .clean_history{
        width:100%;
        height:600px;
        overflow:hidden;
        display:flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }

    .durability_history{
        width:100%;
        height:600px;
        overflow:hidden;
        display:flex;
        /* flex-direction: column; */
        justify-content: center;
        align-items: center;
    }

    .durablility_top{
        width:100%;
        display:flex;
        justify-content:space-around;
        font-size:18px;
        font-weight:bold;
        padding:10px 0px 10px 0px;
    }

    .clean_history table{
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed;
        font-size:18px;
        height:600px;
        display:flex;
        flex-direction: column;
        align-items: flex-start;
    }

    .durability_history_data{
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed;
        font-size:18px;
        height:600px;
        display:flex;
        margin:20px;
        flex-direction: column;
        align-items: flex-start;
    }

    .durability_history_data2,.durability_history_data3{
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed;
        font-size:18px;
        height:270px;
        display:flex;
        margin:20px;
        flex-direction: column;
        align-items: flex-start;
    }

    .durability_search{
        margin:0px 0px 0px 10px;
        width:150px;
        height:25px;
    }

    .clean_history table thead,.durability_history table thead {
        display:block;
    }

    .clean_history table th,.durability_history table th {
        position: sticky;
        top: 0;
        background-color: #333;
        color:#fff;
        text-align: center;
        width:120px;
        font-weight:bold;
    }

    .clean_history table td,.durability_history table td {
        width:120px;
        font-size:13px;
        border-color:black;
        border-style:solid;
        border-width:1px;
    }

    .clean_history_tbody,.durability_history_tbody,.durability_history_tbody2,.durability_history_tbody3 {
        /* max-height: 500px; */
        overflow-y: auto;
        display: block;
        font-weight:bold;
    }
    .need_search_option_btn,.clean_search_option_btn{
        display: flex;
        align-items: center;
        justify-content: center;
        width:130px;
        height:40px;
        /* background:#122459; */
        /* box-shadow: 0 8px 9px -4px rgba(0, 0, 0, 0.3), 0 4px 18px 0 rgba(0, 0, 0, 0.2); */
        border-radius: 5px;
        font-size:17px;
        font-weight:bold;
        cursor:pointer;
    }

    .need_search_btn,
    .clean_search_btn{
        width:100px;
        height:40px;
        /* background:#122459; */
        box-shadow: 0 8px 9px -4px rgba(0, 0, 0, 0.3), 0 4px 18px 0 rgba(0, 0, 0, 0.2);
        border-radius: 5px;
        font-size:17px;
        font-weight:bold;
        cursor:pointer;
    }

    .clean_search_btn:hover{
        opacity:0.8;
    }

    .need_search_input,
    .clean_search_input{
        height:40px;
        width:150px;
        border-radius: 5px;
        font-size:17px;
        font-weight:bold;
    }

    .need_search_ctn_area,
    .clean_search_ctn_area{
        display:flex;
        justify-content: center;
        align-items: center;
        font-weight:bold;
        font-size:20px;
    }
    /* #swal2-content > div > table > thead > tr:nth-child(1) > th:nth-child(1),
    #swal2-content > div > table > tbody > tr:nth-child(1) > td:nth-child(1){
        width:80px;
    }
    #swal2-content > div > table > thead > tr:nth-child(1) > th:nth-child(2),
    #swal2-content > div > table > tbody > tr:nth-child(1) > td:nth-child(2){
        width:100px;
    }
    #swal2-content > div > table > thead > tr:nth-child(1) > th:nth-child(3),
    #swal2-content > div > table > tbody > tr:nth-child(1) > td:nth-child(3){
        width:150px;
    }
    #swal2-content > div > table > thead > tr:nth-child(1) > th:nth-child(4),
    #swal2-content > div > table > tbody > tr:nth-child(1) > td:nth-child(4){
        width:150px;
    }
    #swal2-content > div > table > thead > tr:nth-child(2) > th:nth-child(1),
    #swal2-content > div > table > tbody > tr:nth-child(1) > td:nth-child(5){
        width:100px;
    }
    #swal2-content > div > table > thead > tr:nth-child(2) > th:nth-child(2),
    #swal2-content > div > table > tbody > tr:nth-child(1) > td:nth-child(6){
        width:100px;
    }
    #swal2-content > div > table > thead > tr:nth-child(2) > th:nth-child(3),
    #swal2-content > div > table > tbody > tr:nth-child(1) > td:nth-child(7){
        width:100px;
    }
    #swal2-content > div > table > thead > tr:nth-child(2) > th:nth-child(4),
    #swal2-content > div > table > tbody > tr:nth-child(1) > td:nth-child(8){
        width:100px;
    }
    #swal2-content > div > table > thead > tr:nth-child(2) > th:nth-child(5),
    #swal2-content > div > table > tbody > tr:nth-child(1) > td:nth-child(9){
        width:100px;
    }
    #swal2-content > div > table > thead > tr:nth-child(2) > th:nth-child(6),
    #swal2-content > div > table > tbody > tr:nth-child(1) > td:nth-child(10){
        width:100px;
    } */

    /* #swal2-content > div > table > tbody > tr:nth-child(1) > td:nth-child(11){
        width:100px;
    } */
    /* #swal2-content > div > table > thead > tr:nth-child(2) > th:nth-child(7){
        width:130px;
    } */
    .clean_search_area{
        padding:10px;
    }
    .clean_history_btn{
        width:150px;
        height:40px;
        /* background:#122459; */
        box-shadow: 0 8px 9px -4px rgba(0, 0, 0, 0.3), 0 4px 18px 0 rgba(0, 0, 0, 0.2);
        border-radius: 5px;
        font-size:17px;
        font-weight:bold;
        cursor:pointer;
        margin:10px 10px 10px 10px;
    }

    .clean_history_btn:hover{
        opacity:0.7;
    }

    .clean_history_btn_on{
        background:#333;
        color:#fff;
    }

    .clean_history_data_add,.durability_history_data_add{
        width:100%;
        height:30px;
    }

    .clean_history_data_add_btn{
        width:40px;
        height:40px;
        /* background:#122459; */
        box-shadow: 0 8px 9px -4px rgba(0, 0, 0, 0.3), 0 4px 18px 0 rgba(0, 0, 0, 0.2);
        border-radius: 5px;
        font-size:20px;
        font-weight:bold;
        cursor:pointer;
        margin:10px 10px 10px 10px;
    }

    .sortable{
        cursor:pointer;
    }

    .durabililty_top_cnt{
        padding:0px 0px 0px 10px;
        font-size:18px;
        font-weight:bold;
    }

    .docs_preview,.docs_down{
        display:none;
        cursor: pointer;
        padding: 10px;
        margin-bottom: 5px;
        border-radius: 5px;
        box-shadow: 0 8px 9px -4px rgba(5, 20, 46, 0.3), 0 4px 18px 0 rgba(1, 13, 31, 0.2);
    }

    .msg_data{
        cursor:pointer;
    }

    .msg_data:hover{
        opacity:0.7;
    }
    .contract_alert_table_area{
        width:100%;
        display:flex;
        justify-content: center;
    }

    .contract_alert_table{
        width:100%;
    }

    .contract_alert_table thead{
        display:block;
    }
    .contract_alert_table thead tr th{
        text-align: center;
        height:40px;
    }

    .contract_alert_table tbody{
        display:block;
        height:600px;
        overflow-y: scroll;
    }

    .contract_alert_table tbody tr td{
        text-align: center;
        height:40px;
        
    }

    .contract_alert_table thead tr th:nth-child(1),.contract_alert_table tbody tr td:nth-child(1){
        width:100px;
    }

    .contract_alert_table thead tr th:nth-child(2),.contract_alert_table tbody tr td:nth-child(2){
        width:100px;
    }
    .contract_alert_table thead tr th:nth-child(3),.contract_alert_table tbody tr td:nth-child(3){
        width:150px;
    }
    .contract_alert_table thead tr th:nth-child(4),.contract_alert_table tbody tr td:nth-child(4){
        width:50px;
    }
    .contract_alert_table thead tr th:nth-child(5),.contract_alert_table tbody tr td:nth-child(5){
        width:50px;
    }
    .contract_alert_table thead tr th:nth-child(6),.contract_alert_table tbody tr td:nth-child(6){
        width:150px;
    }
    .contract_alert_table thead tr th:nth-child(7),.contract_alert_table tbody tr td:nth-child(7){
        width:150px;
    }
    .contract_alert_table thead tr th:nth-child(8),.contract_alert_table tbody tr td:nth-child(8){
        width:150px;
    }
    .contract_alert_table thead tr th:nth-child(9),.contract_alert_table tbody tr td:nth-child(9){
        width:150px;
    }
</style>

<% if(firstData=="zoa"){%>
    <%- include('webtopmenu_w') %>
<% }else{ %>
    <%- include('webtopmenu') %>
<% } %>
<script>
    var uid = '<%=username%>';
    var company = '<%=company%>';
    var companynumber = "<%=companynum[0].companynum.replace(/[^0-9]/g,'')%>";
    var popbill_id = "<%=companynum[0].popbillid.replace(/ /g,'')%>";
    var company_address = "<%=companynum[0].address%>"+"<%=companynum[0].addressdetail%>";
    var gongchk = '<%=gongchk2%>';
    var deliverychk = '<%=deliverychk2%>';
    var deliveryend = '<%=deliveryend2%>';
    var deliveryending = '<%=deliveryending2%>';
    var bchk2 = '<%=bchk2%>';
    var query = '';
    var product = '<%=product%>';
    var centername = '<%=centername%>';
    var manager = '<%=manager%>';
    var phone = '<%=phone%>';
    var delivery = "<%=delivery%>";
    var contract = "<%=contract%>";
    var rentstatus = "<%=rentstatus%>";
    var cmsstatus = "<%=cmsstatus%>";
    var company = "<%=company%>";
    var member_target = "<%=membertarget%>";
    // var deliverycar = "";
    var bcode = "";
    var managerall = '<%=function(){ var mresult = []; for(m of managerarr){mresult.push(m.name);} return mresult;}()%>';
    var managerarr = [];
    for(m of managerall.split(',')){
        managerarr.push(m);
    }
    managerarr = managerarr.filter((v, i) => managerarr.indexOf(v) === i);
    var now = new Date();
    var year= now.getFullYear();
    var mon = (now.getMonth()+1)>9 ? ''+(now.getMonth()+1) : '0'+(now.getMonth()+1);
    var day = now.getDate()>9 ? ''+now.getDate() : '0'+now.getDate();
    var chan_val = year+'-'+mon+'-'+day;
    const lastdate = new Date(year, mon, 0).getDate();

    var socket = '';
    function socket_start(){
        socket = io({
            transports: ['websocket']
        });
        socket.on('go_lookup_contract_alert_res', function(data){
           console.log(data.data)
           if(data.data){
            let str = '';
            // 객체를 배열로 변환
            const arr = Object.keys(data.data).map(key => ({ key: key, ...data.data[key] }));

            // 날짜에 따라 정렬
            arr.sort((a, b) => b.SAYOU_DT - a.SAYOU_DT);

            // 정렬된 배열을 다시 객체로 변환
            const sortedObj = arr.reduce((acc, curr) => {
                acc[curr.key] = { SAYOU_DT:curr.SAYOU_DT, FNM:curr.FNM, SBA_CD_FR:curr.SBA_CD_FR, SBA_CD_TO:curr.SBA_CD_TO, PROD_NM:curr.PROD_NM, MGDS_NM:curr.MGDS_NM, WIM_CD:curr.WIM_CD, BCD_NO:curr.BCD_NO};
                return acc;
            }, {});

            for (const key in sortedObj){
                console.log(key, sortedObj[key]);
                str += `
                 <tr>
                     <td>${sortedObj[key].SAYOU_DT}</td>
                     <td>${sortedObj[key].FNM}</td>
                     <td>${key}</td>
                     <td>${sortedObj[key].SBA_CD_FR}</td>
                     <td>${sortedObj[key].SBA_CD_TO}</td>
                     <td>${sortedObj[key].PROD_NM}</td>
                     <td>${sortedObj[key].MGDS_NM}</td>
                     <td>${sortedObj[key].WIM_CD}</td>
                     <td>${sortedObj[key].BCD_NO}</td>
                 </tr>
                `;
            }
            $('.contract_alert_table_tbody').append(str);
           }
           socket_end();
        });
    }

    function socket_end(){
        socket.disconnect();
    }
    

    async function product_get_money(){
        let product_money_obj = {};
        return axios({
            method:'post',
            url:'/productGetMoney',
            data:{},
        }).then(function(res){
            const data = res.data.result;
            
            data.forEach(function(obj,index){
                product_money_obj[obj.code] = parseInt(obj.rentprice);
            });
            return product_money_obj
        });
    }

    function addzero(n){                        // 한자리가 되는 숫자에 "0"을 넣어주는 함수
        return n < 10 ? "0" + n: n;
    }

    function dateInputd(n,m){
        var date = new Date();
        var start = new Date(Date.parse(date)-n* 1000 * 60 * 60 * 24);
        var today = new Date(Date.parse(date)-m* 1000 * 60 * 60 * 24);
        
        if(n < 10){
            start.setMonth(start.getMonth()-n);
        }
        var yyyy = start.getFullYear();
        var mm = start.getMonth()+1;
        var dd = start.getDate();
        
        var t_yyyy = today.getFullYear();
        var t_mm = today.getMonth()+1;
        var t_dd = today.getDate();
        
        //return yyyy+'-'+addzero(mm)+'-'+addzero(dd);
        return t_yyyy+'-'+addzero(t_mm)+'-'+addzero(t_dd);
        
    }

    function dateInputm(n,m){
        var date = new Date();
        var start = new Date(Date.parse(date)-n* 1000 * 60 * 60 * 24);
        var today = new Date(Date.parse(date)-m* 1000 * 60 * 60 * 24);
        
        if(n < 10){
            start.setMonth(start.getMonth()-n);
        }
        var yyyy = start.getFullYear();
        var mm = start.getMonth()+1;
        var dd = start.getDate();
        
        var t_yyyy = today.getFullYear();
        var t_mm = today.getMonth()+1;
        var t_dd = today.getDate();
        
        return yyyy+'-'+addzero(mm)+'-'+addzero(dd);
        //return t_yyyy+'-'+addzero(t_mm)+'-'+addzero(t_dd);
        
    }

    function datesearch(){
        rentlookup(1,uid,$('#datepicker').val(),$('#datepicker2').val(),query,rentstatus,cmsstatus,contract,delivery,product,centername,manager,phone,bcode);

        //location.href='//13.209.151./rentlookup/1/'+uid+'/'+$('.date1').val()+'/'+$('.date2').val();
    }

    function allchk(x){
        if($(x).is(":checked")) $("input[name=chk]").prop("checked", true); else $("input[name=chk]").prop("checked", false);
    }

    function msgpersonadd(){
        Swal.mixin({
            toast: true,
        });
    }

    // function selectmsg(sval1,sval2,sval3,sval4){
    //     var reg = /[\{\}\[\]\/?.,;:|\)*~`!^\-_+<>@\#$%&\\\=\(\'\"]/gi;
    //     var str = '';
    //     var strarr = [];
    //     $.ajax({
    //         url: "/biztable",
    //         data: "id=" + uid + "&company=<%=company%>&msgchk=rent&product="+sval1+"&pricetarget="+sval2+"&state="+sval3+"&target="+sval4,
    //         type: "POST",
    //         dataType: "JSON",
    //         async:false,
    //         success: function (result) {
    //             if (result.code==200) {
    //                 $.each(result.result2,function(i){
    //                     $.each(result.result3,function(y){
    //                         var productname = result.result2[i].productname.split(',');
    //                         $.each(productname,function(x){
    //                             if(result.result3[y].code==productname[x].split('|')[0]){
    //                                 if(result.result2[i].phone!=' '&&result.result2[i].phone!='NULL'&&result.result2[i].phone.replace(reg, '').length==11){
    //                                     strarr.push(result.result2[i].phone.replace(reg, ''));
    //                                 }
    //                             }
    //                         });
    //                     });
    //                 });
    //                 const set = new Set(strarr);
    //                 const uniqueArr = [...set];
    //                 $.each(uniqueArr,function(i){
    //                     str += '<span class="msgnumber">'+uniqueArr[i]+'</span>';
    //                 });
    //                 sendmsg(str,sval1,sval2,sval3,sval4);
    //             }
    //         }
    //     });
    // }

    // function sendmsg(str,sval1,sval2,sval3,sval4){
    //     $.ajax({
    //         url: "/biztable",
    //         data: "id=" + uid + "&company=<%=company%>",
    //         type: "POST",
    //         dataType: "JSON",
    //         async:false,
    //         success: function (result) {
    //             if (result.code==200) {
    //                 var reg = /[\{\}\[\]\/?.,;:|\)*~`!^\-_+<>@\#$%&\\\=\(\'\"]/gi;
    //                 //var bizphonenum = result.result[0].bizphonenum.replace(reg, '');
    //                 Swal.fire({
    //                     width: '1300px',
    //                     fontsize:'25px',
    //                     title: '<div class="sendmsg flex"><span class="material-icons">phone_iphone</span>문자 발송</div>',
    //                     text: "문자발송",
    //                     html:'<div class="flexs" style="font-size:18px; font-weight:bold; margin-top:20px;">'+
    //                         '<div>'+
    //                         '<div class="sendnumber">발신번호 [  ] </div><div class="flex msgpersonadd" onclick="msgpersonadd()" style="display:none;"><span class="material-icons" style="font-size:30px;">group_add</span>&nbsp;&nbsp;&nbsp;수신자 등록</div><div><div style="background: #122459; color:fff;">메시지 내용</div><div><textarea class="msgtxt" style="width:600px; height:380px; background:#fbffd8" placeholder="내용을 입력해주세요."></textarea></div></div>'+
    //                         '</div>'+
    //                         '<div class="msgoption">'+
    //                             '<div>수신자선택</div><br/>'+
    //                             '<div class="flex" style="display:none;"><div>조회시작일</div><input class="date1 datepickerall2" type="text" id="datepicker3" autocomplete="off" value="2022-01-01"></div><br/>'+
    //                             '<div class="flex" style="display:none;"><div>조회종료일</div><input class="date2 datepickerall2" type="text" id="datepicker4" autocomplete="off" value="'+chan_val+'"></div><br/>'+
    //                             '<div class="flexcolumns">'+
    //                             '<div class="msgselect flexstart" style="width:100%;"><span>품목</span><select id="sval1" class="sval" onchange="selectmsg(this.value,document.getElementById(\'sval2\').value,document.getElementById(\'sval3\').value,document.getElementById(\'sval4\').value);"><option selected>전체</option><option>전동침대</option><option>배회감지기</option><option>휠체어</option><option>이동욕조</option><option>욕창예방매트리스</option></select></div><br/>'+
    //                             '<div class="msgselect flexstart" style="width:100%;"><span>급여유무</span><select id="sval2" class="sval" onchange="selectmsg(document.getElementById(\'sval1\').value,this.value,document.getElementById(\'sval3\').value,document.getElementById(\'sval4\').value);"><option>전체</option><option selected>급여</option><option>비급여</option></select></div><br/>'+
    //                             '<div class="msgselect flexstart" style="width:100%;"><span>상태</span><select id="sval3" class="sval" onchange="selectmsg(document.getElementById(\'sval1\').value,document.getElementById(\'sval2\').value,this.value,document.getElementById(\'sval4\').value);"><option selected>전체</option><option value="'+year+'-'+mon+'-'+lastdate+'">'+mon+'월 계약종료예정자</option></select></div><br/>'+
    //                             '<div class="msgselect flexstart" style="width:100%;"><span>대상</span><select id="sval4" class="sval" onchange="selectmsg(document.getElementById(\'sval1\').value,document.getElementById(\'sval2\').value,document.getElementById(\'sval3\').value,this.value);"><option selected>전체</option><option>일반|감경</option><option>의료급여|기초</option></select></div><br/>'+
    //                             '</div>'+
    //                         '</div>'+
    //                         '<div>'+
    //                         '<div class="msgpersonlist flexcolumns"><div>수신자&nbsp;&nbsp;:&nbsp;&nbsp;<span class="msgpersoncnt"></span>명</div><div class="msgpersonlistbox flexcolumns">'+str+'</div></div>'+
    //                         '</div>'+
    //                         '</div>',
    //                     //icon: 'question',
    //                     showCancelButton: true,
    //                     confirmButtonColor: '#3085d6',
    //                     cancelButtonColor: '#d33',
    //                     confirmButtonText: '발송',
    //                     showLoaderOnConfirm: true,
    //                     cancelButtonText: '취소',
    //                     allowOutsideClick: false,
    //                     didOpen: () => {
    //                         $('.msgpersoncnt').text($('.msgnumber').length);
    //                         $( "#datepicker3" ).datepicker({
    //                             changeMonth: true,
    //                             changeYear: true
    //                         });
    //                         $( "#datepicker4" ).datepicker({
    //                             changeMonth: true,
    //                             changeYear: true
    //                         });
    //                         $( "#datepicker3,#datepicker4" ).datepicker( "option", "showAnim", "slide" );
                            
    //                         if(sval1!=' '&&sval1!=null)$('.sval').eq(0).val(sval1).prop("selected", true);
    //                         if(sval2!=' '&&sval2!=null)$('.sval').eq(1).val(sval2).prop("selected", true);
    //                         if(sval3!=' '&&sval3!=null)$('.sval').eq(2).val(sval3).prop("selected", true);
    //                         if(sval4!=' '&&sval4!=null)$('.sval').eq(3).val(sval4).prop("selected", true);
    //                     },
    //                     preConfirm: () => {
    //                         // $.each($('.msgnumber'),function(i){
    //                         //     $.ajax({
    //                         //     url: "/bizmsg",
    //                         //     data: "id=" + result.result[0].bizid + "&company=<%=company%>"+ "&bizphonenum="+bizphonenum+ "&biztonum="+$('.msgnumber').eq(i).text().replace(reg, '')+ "&biztxt="+$('.msgtxt').val(),
    //                         //     type: 'POST',
    //                         //     dataType: "JSON",
    //                         //     success: function (result) {
    //                         //         if(result){
    //                         //         Swal.fire({
    //                         //             icon: 'success',
    //                         //             width:'500px',
    //                         //             title: '발송완료',
    //                         //             allowOutsideClick: false,
    //                         //         });
    //                         //         }
    //                         //     }
    //                         //     });
    //                         // });
    //                     }, 
    //                     allowOutsideClick: () => !Swal.isLoading(),
    //                 }).then((result) => {
    //                     if (result.isConfirmed) {
                        
    //                     }
    //                 });
    //             }else{
    //             Swal.fire({
    //                 icon: 'warning',
    //                 width:'500px',
    //                 title: result.msg,
    //                 allowOutsideClick: false,
    //             });
    //             }
    //         }
    //     });
    // }


    function popbill_msg_type_on(x){
        sendMessage_stop = 1;
        $('#sval1').val('all').prop('selected', true);
        $('#sval3').val('none').prop('selected', true);
        $('.msg_data').remove();
        $('.msgpersoncnt').text(0);
        $(x).addClass('popbill_msg_type_on');
        $('.popbill_msg_type').not($(x)).removeClass('popbill_msg_type_on');
        if($(x).hasClass('custum')){
            $('.popbill_msg_custum').show();
            $('.msg_option2').show();
            $('.msgtxt').val('');
            $('.msgtxt').prop('readonly', false);
            $('.msgtxt').prop('placeholder', "발신내용을 작성해주세요.");
            $('.docs_preview').hide();
        }else if($(x).hasClass('kakao_template')){
            $('.docs_preview').hide();
            $('.popbill_msg_custum').show();
            $('.msg_option2').show();
            $('.msgtxt').val($(x).children('textarea').val());
            $('.msgtxt').prop('readonly', true);
        }else if($(x).hasClass('doc_1')){
            $('.docs_preview').show();
            $('.popbill_msg_custum').show();
            $('.msg_option1').click();
            $('.msg_option2').hide();
            $('.msgtxt').val('');
            $('.msgtxt').prop('readonly', false);
            $('.msgtxt').prop('placeholder', "급여제공기록지 제공 안내문구를 작성해주세요.");
        }else if($(x).hasClass('doc_2')){
            $('.docs_preview').hide();
            $('.popbill_msg_custum').show();
            $('.msg_option1').click();
            $('.msg_option2').show();
            $('.msgtxt').val('');
            $('.msgtxt').prop('readonly', false);
            $('.msgtxt').prop('placeholder', "욕구사정기록조사 링크와 함께 발신될 안내 문구를 작성해주세요");
        }
    }

    function popbill_msg_option_on(x){
        $(x).addClass('msg_option_on');
        $('.msg_data').remove();
        $('.msgpersoncnt').text(0);
        $('.msg_option').not($(x)).removeClass('msg_option_on');
        if($(x).hasClass('msg_option1')){
            $('.swal_msg_client_thead').children('.msg_client_thead2').hide();
            $('.swal_msg_client_thead').children('.msg_client_thead1').show();
            $('.popbill_msg_target2').hide();
            $('.popbill_msg_target1').show();
        }else if($(x).hasClass('msg_option2')){
            $('.swal_msg_client_thead').children('.msg_client_thead1').hide();
            $('.swal_msg_client_thead').children('.msg_client_thead2').show();
            $('.popbill_msg_target_tbody').children().remove();
            client_list();
            $('#form1').val('');
            $('.popbill_msg_target2').show();
            $('.popbill_msg_target1').hide();
        }
    }


    function getTodayLabel(date) {
        var week = new Array('(일)', '(월)', '(화)', '(수)', '(목)', '(금)', '(토)');
        var today = new Date(date).getDay();
        var todayLabel = week[today];
        return todayLabel;
    }


    var productlist = '<%=function(){ var mresult = []; for(m of productlist){mresult.push(m.name+"|"+m.code+"|"+m.name2);} return mresult;}()%>';
    var productlistarr = [];
    for(m of productlist.split(',')){
        productlistarr.push(m);
    }

    function sleep(ms) {
        return new Promise((r) => setTimeout(r, ms));
    }

    function sendMessage(data){
        var msg = JSON.stringify(data);
        var xhr = new XMLHttpRequest();

        xhr.onreadystatechange = () => {
            if (xhr.readyState === 4) {
                console.log(xhr.response);
            }
        };
        xhr.open('POST', '/popbill_send_msg_doc');
        xhr.send(msg);
    }

    async function client_click_preview(i){
        console.log("el_arr",el_arr)
        const popbillDom = document.querySelector('.popbill_dom');
        popbillDom.innerHTML = "<html>" + el_arr[i]+el_arr2[i] + "</html>";
    }
 
    var sendMessage_stop = 0;
    async function getBase64Image(name, number, obj, month, doc) {
        console.log(name.length);
        $('.docs_down').hide();
        let swal_msg_client_table = $('.swal_msg_client_table');
        
        $('.swal_msg_client_table').remove();
        const base64Images = [];
        for (let i = 0; i < obj.length; i++) {
            const popbillDom = document.querySelector('.popbill_dom');
            popbillDom.innerHTML = "<html>" + obj[i] + "</html>";
            await html2canvas(popbillDom).then(async canvas => {
                let dataUrl = canvas.toDataURL('image/png');
                let data = {
                    data: dataUrl,
                    id:name[i]+number[i]+doc[i],
                    type:'jpg',
                    name:"<%=company%>",
                    month:month
                }
                
                await sendMessage(data);
                
                
                $('.sendmsg_make_doc_cnt').text(parseInt((i+1)/2));
            });
            
            if(sendMessage_stop==1){
                $('.msg_data').remove();
                break
            }
        }
        $('.reloading').after(swal_msg_client_table);
        $('.reloading').hide();
        $('.docs_down').show();
        $('.sendmsg_make_doc_cnt').text(0);
    }
    
    // async function getBase64Image(name,number,obj) {
    //     console.log(name.length);
    //     for(var i =0; i<name.length; i++){
    //         console.log(i);
    //     // await $.each(obj, function(i){

    //     // })
    //     // obj.forEach(function(el,index){
    //         // $('.popbill_dom').children('html').remove();
    //         // const commentEl = document.createElement('html');
    //         // commentEl.innerHTML=obj[i];
    //         // $('.popbill_dom').append("<html>"+obj[i]+"</html>");
    //         const popbillDom = document.querySelector('.popbill_dom');
            
    //         popbillDom.innerHTML="<html>"+obj[i]+"</html>";
            
    //         html2canvas(popbillDom, { 
    //             onrendered: function (canvas) { 
    //                 console.log(this)
    //                 //$('.popbill_dom').children('.mbody').eq(0).remove();
    //                 canvas.toBlob(function(blob) {
    //                     console.log(blob);
    //                     let dataUrl = canvas.toDataURL('image/png');
    //                     console.log(dataUrl)
    //                     // commentEl.innerHTML=obj[index];
    //                     // // formData.onload=function(){
    //                     //     formData.append("media", blob);
    //                     // //     // formData.append("content", "Blob확인");
    //                     // //     // formData.append("tagList", "blob");
    //                     // //     // formData.append("username", "admin");
                            
    //                     // // }
                        
    //                     let data = {
    //                         data: dataUrl,
    //                         id:name[i],
    //                         type:'png',
    //                         name:"<%=company%>",
    //                     }
    //                     sendMessage(data);
    //                 });
    //                     // let data = {
    //                     //     data: uint8Array,
    //                     //     id:name[index],
    //                     //     type:'png',
    //                     //     name:"<%=company%>",
    //                     // }
    //             }
    //         })
    //     // })
    //     }
        
        
        
    // }

    /*--------------------------------------------------------*
    // 수신자 테이블 욕사정기록조사 링크 생성
    *--------------------------------------------------------*/
    function sendmsg_make_link(x){

    }



    
    /*--------------------------------------------------------*
    // 수신자 테이블 급여제공기록지 생성
    *--------------------------------------------------------*/
    var el_arr = [];
    var el_arr2 = [];
    var el_arr_all= [];
    var doc_arr = [];
    async function sendmsg_make_doc(p_obj,data_all,month){
        $('.reloading').show();
        let now = new Date();
        let year = now.getFullYear();
        if(month==12||month==8||month==9||month==10||month==11){
            year = "2024";
        }
        let mon = (month) > 9 ? '' + (month) : '0' + (month);
        let day = now.getDate() > 9 ? '' + now.getDate() : '0' + now.getDate();
        let chan_val = year + '-' + mon + '-' + day;
        const lastdate = new Date(year, mon, 0).getDate();
        let last_chan_val = year + '-' + mon + '-' +lastdate;
        // let tr_data = $(x).children('tbody').children('tr');
        //let tr_data = document.querySelector('.swal_msg_client_table tbody').children;
        //let tr_data = x.children[0].children;
        let name_arr = [];
        let number_arr = [];
        el_arr = [];
        el_arr2 = [];
        el_arr_all= [];
        // console.log(tr_data);
        const ionContents = document.getElementsByClassName('iprint');
        let same_arr = [];
        $.each(data_all,async function(i){
            // let name = $(tr_data[i]).children('td').eq(0).text();
            // let number = $(tr_data[i]).children('td').eq(1).text();
            let name = data_all[i].name;
            let number = data_all[i].number;
            same_arr.push(name+"|"+number);
        });
        console.log('salme_arr:',same_arr)
        const duplicateIndexes = {};
        same_arr.forEach((value, index) => {
            if (!(value in duplicateIndexes)) {
                duplicateIndexes[value] = [index];
            } else {
                duplicateIndexes[value].push(index);
            }
        });

        for (const [value, indexes] of Object.entries(duplicateIndexes)) {
            if (indexes.length > 1) {
                console.log(`값 ${value}의 중복된 인덱스: ${indexes.join(', ')}`);
            }
        }
        let continue_arr = [];
        let continue_chk = 0;
        $.each(data_all,function(i){
            continue_chk = 0;
            //console.log("coninue:",i,continue_arr)
            for(var c=0; c<continue_arr.length; c++){
                if((i)==continue_arr[c]){
                    console.log("continue:",c)
                    continue_chk = 1;
                }
            }
            if(continue_chk==1)return true;
            //console.log("noconfinue",i)
            let di = 1;
            let rentendResult = [];
            let rentstartResult = [];
            let pdfstr1 = '';
            let alldm = 0;
            let alldm2 = 0;
            let pdfdantotal = 0;
            let pdfbuytotal = 0;
            let pdfgongtotal = 0;
            // let name = $(tr_data[i]).children('td').eq(0).text();
            // let number = $(tr_data[i]).children('td').eq(1).text();
            // let pname = $(tr_data[i]).children('td').eq(2).text();
            // let phone = $(tr_data[i]).children('td').eq(3).text();
            // let rendend = $(tr_data[i]).children('td').eq(4).text();
            // let target = $(tr_data[i]).children('input').eq(5).val();
            // let ranker = $(tr_data[i]).children('input').eq(6).val();
            // let regident = $(tr_data[i]).children('input').eq(7).val();
            // let address = $(tr_data[i]).children('input').eq(8).val();
            // let guardname = $(tr_data[i]).children('input').eq(9).val();
            // let guardtarget = $(tr_data[i]).children('input').eq(10).val();
            // let manager = $(tr_data[i]).children('input').eq(11).val();
            // let pcode = $(tr_data[i]).children('input').eq(12).val();
            let name = data_all[i].name;
            let number = data_all[i].number;
            let pname = data_all[i].pname;
            let phone = data_all[i].phone;
            let rendend = data_all[i].rentend;
            let target = data_all[i].target;
            let ranker = data_all[i].ranker;
            let regident = data_all[i].regident;
            let address = data_all[i].address;
            let guardname = data_all[i].guardname;
            let guardtarget = data_all[i].guardtarget;
            let manager = data_all[i].manager;
            let pcode = data_all[i].pcode;
            let bcodesale = data_all[i].bcodesale;
            let pname2 = '';
            for (var j = 0; j < productlistarr.length; j++) {
                var currentString = productlistarr[j];
                if (currentString.includes(pcode)) {
                    // '|123'를 포함하는 문자열을 발견했을 때의 처리
                    pname2=currentString.split("|")[0]; // 출력: 'a|123'
                    break
                }
            }
            
            // let datenowarr = $(tr_data[i]).children('input').eq(3).val().replace(/(\[|\]|\'|\|| |&#39|\;)/g,'').split('~');
            let datenowarr = data_all[i].datenow.replace(/(\[|\]|\'|\|| |&#39|\;)/g,'').split('~');
            // let nextdatearr = $(tr_data[i]).children('input').eq(4).val().replace(/(\[|\]|\'|\|| |&#39|\;)/g,'').split(',');
            let nextdatearr = data_all[i].nextdate.replace(/(\[|\]|\'|\|| |&#39|\;)/g,'').split(',');
            // let sale =  parseInt($(tr_data[i]).children('input').eq(1).val());
            let sale = parseInt(data_all[i].sale);
            

            // let rendstart = $(tr_data[i]).children('input').eq(0).val();
            let rendstart = data_all[i].rentstart;
            //console.log("data_all",data_all)
            console.log('duplicateIndexes[name+"|"+number].length',duplicateIndexes[name+"|"+number].length)
            let otr_pcode = [pcode];
            let otr_pname = [pname];
            let otr_pname2 = [pname2];
            let otr_rentstart = [rendstart];
            let otr_rentend = [rendend];
            let otr_bcode_sale = [bcodesale];
            if(duplicateIndexes[name+"|"+number].length>1){
                duplicateIndexes[name+"|"+number].forEach(function(obj,index){
                    console.log("index",index)
                    if(index!=0){
                        console.log('[duplicateIndexes[name+"|"+number]',[duplicateIndexes[name+"|"+number]])
                        otr_pcode.push(data_all[obj].pcode);
                        otr_pname.push(data_all[obj].pname);
                        otr_rentstart.push(data_all[obj].rentstart);
                        otr_rentend.push(data_all[obj].rentend);
                        otr_bcode_sale.push(data_all[obj].bcodesale);
                        for (var j = 0; j < productlistarr.length; j++) {
                            var currentString = productlistarr[j];
                            if (currentString.includes(data_all[obj].pcode)) {
                                // '|123'를 포함하는 문자열을 발견했을 때의 처리
                                let pname2=currentString.split("|")[0]; // 출력: 'a|123'
                                otr_pname2.push(pname2);
                                break
                            }
                        }
                        // otr_buybcode = otr_buybcode +","+page_otr_data[obj].buybcode;
                        // otr_buycnt = otr_buycnt +","+page_otr_data[obj].buycnt;
                        // if(page_otr_data[obj].rkey!=''){
                        //     otr_rentstart.push(page_otr_data[obj].rentstart);
                        //     otr_rentend.push(page_otr_data[obj].rentend);
                        //     di_arr.push(1);
                            
                        // }else{
                            
                        // }
                    }    
                    // page_otr_data.splice(duplicateIndexes[order_date+"|"+name+"|"+number][1]);
                    continue_arr.push(obj)
                });
                
            }

            /*--------------------------------------------------------*
            // 전체 대여기간 급여제공기록지 생성
            *--------------------------------------------------------*/
            // if(new Date(rendend)>new Date(datenowarr[1])){
            //     di++;
            //     rentendResult.push(datenowarr[1]);
            //     rentstartResult.push(rendstart);

            //     var nextdatearrLength = nextdatearr.length;
            //     for (var i = nextdatearrLength - 1; i >= 0; i--) {
            //         var nextdate = nextdatearr[i].split('~');
            //         rentstartResult.push(nextdate[0]);

            //         if (new Date(rendend) > new Date(nextdate[1])) {
            //             di++;
            //             rentendResult.push(nextdate[1]);
            //         } else {
            //             rentendResult.push(rendend);
            //             break;
            //         }
            //     }
            // }else{
            //     rentendResult.push(rendend);
            //     rentstartResult.push(rendstart)
            // }
            /*--------------------------------------------------------*
            // 당월 대여기간 급여제공기록지 생성
            *--------------------------------------------------------*/
            // if(otr_pcode.length>1){
            otr_pcode.forEach(function(obj,index){
                di = 1;
                let bcode_sale_cnt = 0;
                let dan = p_obj[obj];
                let bon = p_obj[obj]*(sale/100);
                let gong = dan-bon;

                let salecnt = 5;
                if(otr_pname2[index]=='전동침대')salecnt=10;
                else if(otr_pname2[index]=='욕창예방 매트리스')salecnt=3;
                let newsaledates = new Date(otr_bcode_sale[index]);
                newsaledates.setFullYear(newsaledates.getFullYear() + salecnt);
                newsaledates.setDate(newsaledates.getDate() - 1);
                otr_bcode_sale[index] = dateFormat(newsaledates);
                
                console.log("otr_bcode_sale[index]",otr_bcode_sale[index])
                rentendResult = [];
                rentstartResult = [];

                let bocde_sale_date_plus = new Date(new Date(otr_bcode_sale[index]).setDate(new Date(otr_bcode_sale[index]).getDate() + 1));
                let bocde_sale_year = bocde_sale_date_plus.getFullYear();
                let bocde_sale_month = ('0' + (bocde_sale_date_plus.getMonth() + 1)).slice(-2);
                let bocde_sale_day = bocde_sale_date_plus.getDate() > 9 ? '' + bocde_sale_date_plus.getDate() : '0' + bocde_sale_date_plus.getDate();
                let rentstart = bocde_sale_year + "-" + bocde_sale_month + "-" + bocde_sale_day;
                if(new Date(otr_rentstart[index])<new Date(year + '-' + mon + '-' + '01')){
                    rentstartResult.push(year + '-' + mon + '-' + '01');
                }else{
                    rentstartResult.push(otr_rentstart[index]);
                }
                if(new Date(otr_bcode_sale[index])<new Date(rentstartResult[0])){
                    bcode_sale_cnt++;
                }

                if(new Date(otr_rentend[index])>new Date(last_chan_val)){
                    if(new Date(otr_bcode_sale[index])>new Date(rentstartResult[0])&&new Date(last_chan_val)>new Date(otr_bcode_sale[index])){
                        bcode_sale_cnt++;
                        rentendResult.push(otr_bcode_sale[index]);
                        rentstartResult.push(rentstart);
                        di++;
                    }
                    rentendResult.push(last_chan_val);
                }else{
                    if(new Date(otr_bcode_sale[index])>new Date(rentstartResult[0])&&new Date(otr_rentend[index])>new Date(otr_bcode_sale[index])){
                        bcode_sale_cnt++;
                        rentendResult.push(otr_bcode_sale[index]);
                        rentstartResult.push(rentstart);
                        di++;
                    }
                    rentendResult.push(otr_rentend[index]);
                }


                console.log(otr_pcode,di,rentendResult,rentstartResult)
                for(var y=0; y<di; y++){
                    let dm = 0;
                    let rs = rentstartResult[y];
                    let re = rentendResult[y];
                    if((y+1)>=bcode_sale_cnt&&bcode_sale_cnt!=0){
                        dan = parseInt(dan/2);
                    }
                    let lastDate = new Date(rs.split('-')[0], rs.split('-')[1], 0).getDate();
                    let onem = parseInt(dan)/lastDate;
                    let sm2 = 0;
                    let sm = lastDate-parseInt(rs.split('-')[2])+1;
                    if((rs.split('-')[0]+rs.split('-')[1])==(re.split('-')[0]+re.split('-')[1])){
                        sm2 = lastDate-parseInt(re.split('-')[2]);
                    }
                    
                    dm+=(sm-sm2)*onem;
                    
                    
                    
                    pdfdantotal += Math.floor(parseInt(dm)/10) * 10;
                    // pdfbuytotal += parseInt(bon);
                    pdfbuytotal += Math.floor(parseInt(parseInt(parseInt(dm)*(parseInt(sale)/100)))/10) * 10;
                    // pdfgongtotal += parseInt(gong);
                    pdfgongtotal += Math.ceil(parseInt(parseInt(parseInt(dm)*(1-(parseInt(sale)/100))))/10) * 10;
                    pdfstr1 += "<tr class='addpdf' style='height:40px;'><td class='br bl bd'>"+otr_pname2[index]+"</td><td class='br bd'>"+otr_pname[index]+"</td><td class='br bd'>"+obj+"</td><td class='br bd'>"+parseInt(dan).toLocaleString()+"</td><td class='br bd'>"+rentstartResult[y]+"~<br/>"+rentendResult[y]+"</td><td class='br bd'>"+parseInt(dm).toLocaleString()+"</td><td class='br bd'>"+parseInt(Math.floor(parseInt(parseInt(parseInt(dm)*(parseInt(sale)/100)))/10) * 10).toLocaleString()+"</td><td class='br bd'>"+parseInt(Math.ceil(parseInt(parseInt(parseInt(dm)*(1-(parseInt(sale)/100))))/10) * 10).toLocaleString()+"</td></tr>";
                }   
            });
            

            
            $('.ion').contents().find('.zero_format').remove();
            //console.log('lado')
            console.log("ionContents.length",ionContents.length)
            for(var q=0; q<ionContents.length; q++){
                
                console.log("ionContents.length",ionContents.length,q,ionContents[q].contentDocument)
                ionContents[q].contentDocument.querySelector('.name').innerHTML = name;
                // ionContents[q].querySelector('.regident').innerHTML = regident;
                ionContents[q].contentDocument.querySelector('.number').innerHTML = number;
                ionContents[q].contentDocument.querySelector('.company').innerHTML = "<%=company%>";
                ionContents[q].contentDocument.querySelector('.companynum').innerHTML="<%=companynumber%>";
                ionContents[q].contentDocument.querySelector('.ceo').innerHTML = "<%=managerarr[0].ceo%>";
                let topcm = '-20';
                let tcls = 'basic';
                let pdfstr3 = '<span class="msg_sign" style="position: absolute; top:-35px;"><image style="width:80px; -webkit-user-drag: none;" src="/companystamp/<%=company.replace(/#/g,"%23").replace(/ /g,"%20")%>" onerror="this.style.display=\'none\'"></span>';
                let pdfSign2Element = ionContents[q].contentDocument.querySelector('.pdfsign2');
                while (pdfSign2Element.firstChild) {
                    pdfSign2Element.removeChild(pdfSign2Element.firstChild);
                }

                ionContents[q].contentDocument.querySelector('.pdfsign2').insertAdjacentHTML('beforeend', pdfstr3);
                if(q==0){
                    ionContents[q].contentDocument.querySelector('.target').innerHTML = target + sale +"%";
                    // ionContents.querySelector('.target2').innerHTML = sale;
                    ionContents[q].contentDocument.querySelector('.ranker').innerHTML = ranker;
                    //let addpdfElement = ionContents.querySelector('.addpdf');
                    $('.ion').contents().find('.addpdf').remove();
                    
                    // addpdfElement && addpdfElement.remove();
                    ionContents[q].contentDocument.querySelector('.address').innerHTML = address;
                    ionContents[q].contentDocument.querySelector('.pdfguardname').innerHTML = guardname;
                    if (guardtarget === '본인') ionContents[q].contentDocument.querySelector('.pdfguardname').innerHTML = name;
                    ionContents[q].contentDocument.querySelector('.pdfguardtarget').innerHTML = guardtarget;
                    if (guardname === 'undefined' || guardname === 'null') ionContents[q].contentDocument.querySelector('.pdfguardname').innerHTML = name;
                    if (guardtarget === 'undefined' || guardtarget === 'null') ionContents[q].contentDocument.querySelector('.pdfguardtarget').innerHTML = '본인';
                    ionContents[q].contentDocument.querySelector('.pdfphone1').innerHTML = phone;
                    ionContents[q].contentDocument.querySelector('.manager').innerHTML = manager;
                    ionContents[q].contentDocument.querySelector('.pdfday').innerHTML = last_chan_val + getTodayLabel(last_chan_val);
                    if("<%=company%>"=="도우누리복지용구"){
                        ionContents[q].contentDocument.querySelector('.ceo').innerHTML = "조남식";
                    }

                    ionContents[q].contentDocument.querySelector('.pdfadd2').insertAdjacentHTML('afterend', pdfstr1);
                   
                    let pdfstr2 = '<span class="' + tcls + ' msg_sign" style="position: absolute; z-index: 999; top:' + topcm + 'px;"><image style="width:110px; -webkit-user-drag: none;" src="/signfiles/' + number + '/<%=company%>" onerror="this.style.display=\'none\'"></span>';
                    let pdfSignElement = ionContents[q].contentDocument.querySelector('.pdfsign');
                    while (pdfSignElement.firstChild) {
                        pdfSignElement.removeChild(pdfSignElement.firstChild);
                    }
                    ionContents[q].contentDocument.querySelector('.pdfsign').insertAdjacentHTML('beforeend', pdfstr2);
                   
                    var option1Radio = ionContents[q].contentDocument.querySelector('#option1');
                    var option2Radio = ionContents[q].contentDocument.querySelector('#option2');
                    if (option1Radio) {
                        var checkboxInput = document.createElement('input');
                        checkboxInput.setAttribute('type', 'checkbox');
                        checkboxInput.setAttribute('name', option1Radio.getAttribute('name'));
                        checkboxInput.setAttribute('value', option1Radio.getAttribute('value'));
                        //checkboxInput.setAttribute('checked', option1Radio.checked);
                        option1Radio.parentNode.replaceChild(checkboxInput, option1Radio);
                    }
                    if (option2Radio) {
                        let checkboxInput = document.createElement('span');
                        checkboxInput.innerHTML = "✔";
                        option2Radio.parentNode.replaceChild(checkboxInput, option2Radio);
                        option2Radio.setAttribute('checked', option2Radio.checked);
                    }
                }

                if(q==1){
                    ionContents[q].contentDocument.querySelector('.sdate').innerHTML = otr_rentstart[0] + '~' +otr_rentend[0];
                    ionContents[q].contentDocument.querySelector('.address').innerHTML = company_address;
                    ionContents[q].contentDocument.querySelector('.companynum2').innerHTML = (companynumber=="1681102066")?'5965500438':companynumber;
                    ionContents[q].contentDocument.querySelector('.pdfbuytotal').innerHTML = pdfbuytotal.toLocaleString();
                    ionContents[q].contentDocument.querySelectorAll('.pdfbuytotal').forEach(function(obj,index){
                        obj.innerHTML = pdfbuytotal.toLocaleString();
                    });
                    ionContents[q].contentDocument.querySelectorAll('.pdfgongtotal').forEach(function(obj,index){
                        obj.innerHTML = pdfgongtotal.toLocaleString();
                    });
                    ionContents[q].contentDocument.querySelectorAll('.pdfdantotal').forEach(function(obj,index){
                        obj.innerHTML =(pdfdantotal).toLocaleString();
                    });
                }
                name_arr.push(name);
                number_arr.push(number);
                //console.log(ionContents.querySelector('body').innerHTML);
                // const ionContents2 = ionContents;
                if(q==0){
                    el_arr.push(ionContents[q].contentDocument.querySelector('html').innerHTML);
                    doc_arr.push("doc1");
                }else if(q==1){
                    el_arr2.push(ionContents[q].contentDocument.querySelector('html').innerHTML);
                    doc_arr.push("doc2");
                }
                el_arr_all.push(ionContents[q].contentDocument.querySelector('html').innerHTML);
            }
            
        // }
        });
        $('.sval').css({"pointer-events":""});
        await getBase64Image(name_arr,number_arr,el_arr_all,month,doc_arr);
        
    }

    
    function sendmsg_client(ptype,stype,p_obj,month){
        sendMessage_stop=1;
        if($('.doc_1').hasClass('popbill_msg_type_on')){
            $('.sval').css({"pointer-events":"none"});
        }
        $('.msg_data').remove();
        $('.msgpersoncnt').text(0);
        if(stype!='none'){
            $('.msg_client').append("<tr class='msg_data'><td style='width:750px'>대상자 생성중...<div class='msg_data_cnt'></div></td></tr>");
            let now = new Date();
            let year = now.getFullYear();
            // let year = "2024";
            if(month==12||month==8||month==9||month==10){
                year = "2024";
            }
            let mon = (month) > 9 ? '' + (month) : '0' + (month);
            let day = now.getDate() > 9 ? '' + now.getDate() : '0' + now.getDate();
            let chan_val = year + '-' + mon + '-' + day;
            const lastdate = new Date(year, mon, 0).getDate();
            let last_chan_val = year + '-' + mon + '-' +lastdate;
            let date = '';
            let date2 = '';
            if(stype=="current_y"){
                date= year + '-' + mon + '-' + '01';
            }else if(stype=="current_n"){
                date= chan_val;
            }else if(stype=="all"){
                date = year + '-' + mon + '-' + '01';
                date2 = chan_val;
            }
            axios({
                method:"post",
                url:"/sendmsg_client",
                data:{
                    company:"<%=company%>",
                    ptype:ptype,
                    stype:stype,
                    //ctype:ctype,
                    date:date,
                    date2:date2,
                    lastdate:last_chan_val
                }
            }).then(async function(res){
                
                const data = res.data;
                const bcodesale = data.bcodesale;
                console.log("bcodesale",data);
                const bcodesale_obj = {};
                if(bcodesale.length>0){
                    bcodesale.forEach(function(obj,index){
                        bcodesale_obj[obj.pcode+"-"+obj.bcode]=obj.date;
                    });
                    
                }
                if(data.code==200){
                    $('.msgpersoncnt').text(data.data.length);
                    let str = '';
                    let data_all = [];
                    let data_obj_key = {};
                    let data_obj_name = {};
                    let preview_cnt = -1;
                    // data.data.forEach(async function(obj,index){
                    for(var index = 0; index<data.data.length; index++){
                        let obj = data.data[index];
                    
                        if(data_obj_key.hasOwnProperty(obj.num)){
                            console.log("hasOwnProperty",obj.num);
                            continue;
                        }
                        let phone_number = obj.phone;
                        if(phone_number!=''&&phone_number!=null){
                            phone_number = phone_number.replace(/[^0-9]/g, '');
                        }
                        
                        let hidden_data = `
                        <input class='msg_rentstart' type='hidden' value='`+obj.rentstart+`'>
                        <input class='msg_sale' type='hidden' value='`+obj.sale+`'>
                        <input class='msg_money' type='hidden' value='`+obj.money+`'>
                        <input class='msg_datenow' type='hidden' value='`+obj.datenow+`'>
                        <input class='msg_nextdate' type='hidden' value='`+obj.nextdate.replace(/\'/g,'')+`'>
                        <input class='msg_target' type='hidden' value='`+obj.target+`'>
                        <input class='msg_ranker' type='hidden' value='`+obj.ranker+`'>
                        <input class='msg_regident' type='hidden' value='`+obj.regident+`'>
                        <input class='msg_address' type='hidden' value='`+obj.address+`'>
                        <input class='msg_guardname' type='hidden' value='`+obj.guardname+`'>
                        <input class='msg_guardtarget' type='hidden' value='`+obj.guardtarget+`'>
                        <input class='msg_manager' type='hidden' value='`+obj.manager+`'>
                        <input class='msg_csale' type='hidden' value='`+obj.csale+`'>
                        <input class='msg_ctarget' type='hidden' value='`+obj.ctarget+`'>
                        `;
                        
                        
                        data_obj_key[obj.num]= 1;
                        
                        if(data_obj_name.hasOwnProperty(obj.name+"|"+obj.number)){
                            //data_obj_name[obj.name+"|"+obj.number]++;
                        }else{
                            preview_cnt++;
                        }
                        data_obj_name[obj.name+"|"+obj.number] = 1;
                        if(obj.productname.includes(',')){
                            let product_split = obj.productname.split(',');
                            console.log("product_split",product_split);
                            console.log("index",index)
                            product_split.forEach(function(obj2,index2){
                                
                                hidden_data += "<input class='msg_pcode' type='hidden' value='"+obj2.split("|")[0]+"'>";
                                str += "<tr class='msg_data' onclick='client_click_preview("+(preview_cnt)+")'><td><input type='checkbox' class='sms_rent_checkbox' style='width:20px; height:20px;' checked></td><td>"+obj.name+"</td><td>"+obj.number+"</td><td>"+obj2.split("|")[1]+"</td><td>"+phone_number+"</td><td>"+obj.rentend+"</td>"+hidden_data+"</tr>"
                                data_all.push({
                                    name:obj.name,
                                    number:obj.number,
                                    rentstart:obj.rentstart,
                                    rentend:obj.rentend,
                                    sale:obj.csale!=''&&obj.csale!=null?obj.csale:obj.sale,
                                    money:obj.money,
                                    target:obj.ctarget!=''&&obj.ctarget!=null?obj.ctarget:obj.target,
                                    ranker:obj.ranker,
                                    regident:obj.regident,
                                    address:obj.address,
                                    guardname:obj.guardname,
                                    guardtarget:obj.guardtarget,
                                    manager:obj.manager,
                                    phone:phone_number,
                                    pcode:obj2.split("|")[0],
                                    pname:obj2.split("|")[1],
                                    bcodesale:bcodesale_obj[obj2.split("|")[0]+"-"+obj.buybcode.split(',')[index2]],
                                    datenow:obj.datenow,
                                    nextdate:obj.nextdate.replace(/\'/g,'')
                                });
                            });
                        }else{
                            
                            hidden_data += "<input class='msg_pcode' type='hidden' value='"+obj.productname.split("|")[0]+"'>";
                            str += "<tr class='msg_data' onclick='client_click_preview("+preview_cnt+")'><td><input type='checkbox' class='sms_rent_checkbox' style='width:20px; height:20px;' checked></td><td>"+obj.name+"</td><td>"+obj.number+"</td><td>"+obj.productname.split("|")[1]+"</td><td>"+phone_number+"</td><td>"+obj.rentend+"</td>"+hidden_data+"</tr>"
                            data_all.push({
                                name:obj.name,
                                number:obj.number,
                                rentstart:obj.rentstart,
                                rentend:obj.rentend,
                                sale:obj.csale!=''&&obj.csale!=null?obj.csale:obj.sale,
                                money:obj.money,
                                target:obj.target,
                                ranker:obj.ranker,
                                regident:obj.regident,
                                address:obj.address,
                                guardname:obj.guardname,
                                guardtarget:obj.guardtarget,
                                manager:obj.manager,
                                phone:phone_number,
                                pcode:obj.productname.split("|")[0],
                                pname:obj.productname.split("|")[1],
                                datenow:obj.datenow,
                                nextdate:obj.nextdate.replace(/\'/g,''),
                                bcodesale:bcodesale_obj[obj.productname.split("|")[0]+"-"+obj.buybcode],
                            });
                        }

                    };
                    $('.msg_data').remove();
                    $('.msg_client').append(str);
                    if($('.doc_1').hasClass('popbill_msg_type_on')){
                        sendMessage_stop = 0;
                        await sendmsg_make_doc(p_obj,data_all,month);
                    }
                }else{
                    $('.msg_data').remove();
                    $('.msg_client').append("<tr class='msg_data'><td width='620px'>검색결과없음</td></tr>");
                }
                
            });
        }else{
            $('.sval').css({"pointer-events":"","cursor":""});
        }
        
        
    }

    function table_search(x,id,tr){
        var data = $(x)[0].value.split(" ");
        if ($(x)[0].value == "") {
            $("."+tr).show();
            return;
        }
        $("."+tr).hide();
        
        $("."+tr).filter(function (i, v) {
            var $t = $(this);
            for (var d = 0; d < data.length; ++d) {
                if ($t.is(":contains('" + data[d] + "')")||$t.is(":contains('" + data[d].toUpperCase() + "')")||$t.is(":contains('" + data[d].toLowerCase() + "')")) {
                    return true;
                }
            }
            return false;
        }).show();
    }

    const Toast = Swal.mixin({
        toast: true,
        position: 'top',
        showConfirmButton: false,
        timer: 1500,
        timerProgressBar: true,
        didOpen: (toast) => {
            toast.addEventListener('mouseenter', Swal.stopTimer)
            toast.addEventListener('mouseleave', Swal.resumeTimer)
        }
    });

    function msg_client_remove_all(){
        $('.msg_data').remove();
        $('.msg_client_add').show();
        $('.msg_client_remove').hide();
    }

    let msg_client_obj = [];    
    function msg_client_add_all(){
        
        console.log(msg_client_obj);
        let i = 0;
        for(const x of msg_client_obj){
            let name = x.name;
            let number = x.number;
            let phone = x.phone;
            console.log(name,number,phone);
            var newTr = document.createElement('tr');
            newTr.classList.add('msg_data', number);
            newTr.innerHTML = "<td class='flex'><div class='msg_client_remove'>-</div></td><td style='width:150px;'>" + name + "</td><td style='width:150px;'>" + number + "</td><td style='width:150px;'>" + phone + "</td>";
            document.querySelector('.msg_client').appendChild(newTr);
            (function(index) {
                $(newTr).on('click', function() {
                    msg_client_remove(document.querySelectorAll('.msg_client_tr')[index]);
                });
            })(i);
            i++;
        }
        $('.msgpersoncnt').text($('.msg_data').length);
        $('.msg_client_add').hide();
        $('.msg_client_remove').show();
        
    }

    function msg_client_add(obj){
        
        let name = $(obj).children('td').eq(0).text();
        let number = $(obj).children('td').eq(1).text();
        let phone = $(obj).children('.msg_client_phone').val();
        let client_add_chk = 0;
        $.each($('.msg_data'),function(i){
            if($('.msg_data').eq(i).hasClass(number)){
                client_add_chk=1;
                return false;
            }
        });
        if(client_add_chk==0){
            let str = "<tr class='msg_data "+number+"'><td class='flex'><div class='msg_client_remove'>-</div></td><td style='width:150px;'>"+name+"</td><td style='width:150px;'>"+number+"</td><td style='width:150px;'>"+phone+"</td></tr>"
            $(obj).children('td').eq(2).children('.msg_client_add').hide();
            $(obj).children('td').eq(2).children('.msg_client_remove').show();
            $('.msg_client').append(str);
            $('.msg_client').children('.'+number).on('click',()=>{
                msg_client_remove($(obj));
            });
            $('.msgpersoncnt').text($('.msg_data').length);
        }else{

        }
        
    }

    function msg_client_remove(obj){
        let name = $(obj).children('td').eq(0).text();
        let number = $(obj).children('td').eq(1).text();
        let phone = $(obj).children('.msg_client_phone').val();
        let client_add_chk = 0;
        $.each($('.msg_data'),function(i){
            if($('.msg_data').eq(i).hasClass(number)){
                $(this).remove();
                $('.msgpersoncnt').text($('.msg_data').length);
                $(obj).children('td').eq(2).children('.msg_client_remove').hide();
                $(obj).children('td').eq(2).children('.msg_client_add').show();
                return false;
            }
        })
    }

    function client_list(){
        msg_client_obj = [];
        axios({
            method:"post",
            url:"/clientlist",
            data:{
                company:"<%=company%>"
            }
        }).then(res=>{
            $('.popbill_msg_target_tbody').children().remove();
            const data = res.data;
            let str = '';
            data.data.forEach(function(obj,index){
                msg_client_obj.push({'name':obj.name,'number':obj.number,'phone':obj.phone1});
                str += "<tr class='msg_client_tr'><td style='width:170px;'>"+obj.name+"</td><td style='width:170px;'>"+obj.number+"</td><td style='width:60px;'><div class='msg_client_add' onclick='msg_client_add($(this).parents(\"tr\"))'>+</div><div class='msg_client_remove' style='display:none;' onclick='msg_client_remove($(this).parents(\"tr\"))'>-</div></td><input type='hidden' class='msg_client_phone' value='"+obj.phone1+"'></tr>";
            });
            $('.popbill_msg_target_tbody').append(str);
        })
    }
    var send_number = '';
    function send_number_chk(number){
        $.each($('.send_number_chk'),function(i){
            if($(this).is(":checked")){
                $('.sendnumber').hide();
                send_number = $(this).parent('td').next().text();
                Swal.enableButtons();
                return false
            }else{
                //Swal.disableButtons();
                $('.sendnumber').show();
            }
        })
        
    }

    function ListATSTemplate(){
        axios({
            method:"post",
            url:"/ListATSTemplate",
            data:{
                companynum:"<%=companynum[0].companynum.replace(/[^0-9]/g,'')%>"
            }
        }).then(res=>{
            const data = res.data.data.result;
            console.log('kakao',data);
            let str = '';
            if(data!=undefined){
                data.forEach((obj,index)=>{
                    if(obj.templateName != "계약서 발송")str +='<div class="popbill_msg_type kakao_template" onclick="popbill_msg_type_on(this)">(알림톡 템플릿)<br/>'+obj.templateName+'<textarea style="display:none;">'+obj.template.replace('#{company}','<%=company%>')+'</textarea><input class="tcode" type="hidden" value="'+obj.templateCode+'"></div>'
                });
            }
            if(str!=''){
                $('.custum').after(str);
            }
        })
    }
    
    function GetSenderNumberList(){
        axios({
            method:'post',
            url:'/GetSenderNumberList',
            data:{
                companynum:"<%=companynum[0].companynum.replace(/[^0-9]/g,'')%>"
            }
        }).then(function(res){
            const data = res.data.data.result;
            let str = '';
            if(data!=undefined){
                data.forEach((obj,index)=>{
                    console.log(obj.number);
                    str += '<tr><td><input type="checkbox" class="send_number_chk" style="width:20px; height:20px;" onclick="send_number_chk(this);"></td><td>'+obj.number+'</td></tr>';
                });
                
            }else{
                str = '<tr><td></td><td style="color:#ff0000;">발신번호없음</td></tr>';
            }
            $('.popbill_number_list').append(str);

            
        });
    }
    var kakao_channel_name = '';
    function ListPlusFriendID(){
        axios({
            method:'post',
            url:'/ListPlusFriendID',
            data:{
                companynum:"<%=companynum[0].companynum.replace(/[^0-9]/g,'')%>"
            }
        }).then(res=>{
            const data = res.data.data;
            console.log(data.result[0].plusFriendID);
            kakao_channel_name = data.result[0].plusFriendID;

        });
    }
    
    
    var reservation_data = '';
    function reservation_set(ymd,hms){
        
        reservation_data = ymd.replace(/[^0-9]/g,'')+hms.replace(/[^0-9]/g,'')+'00';
        $('.msg_send_confirm_chk').html(ymd+'&nbsp;&nbsp;'+hms);
        $('.msg_send_confirm_chk_div').show();
    }

    function docs_preview(obj){
        if($(obj).hasClass("off")){
            $('.popbill_dom').css({"top":0,"left":0});
            $(obj).removeClass("off");
            $(obj).addClass("on");
            $(obj).css({'background':'#1a2136','color':'#fff'});
        }else if($(obj).hasClass("on")){
            $('.popbill_dom').css({"top":-4000,"left":0});
            $(obj).removeClass("on");
            $(obj).addClass("off");
            $(obj).css({'background':'#fff','color':'#000'});
        }
        
    }

    async function sms_insert(name,number,company,phonereq,phoneres,doc,type,month){
        name.forEach(function(obj,index){
            return axios({
                method:'post',
                url:'/smsinsertrent',
                data:{
                    name:name[index],
                    number:number[index],
                    company:company,
                    phonereq:phonereq,
                    phoneres:phoneres[index],
                    doc:doc,
                    orderkey:month,
                    type:type
                }
            }).then(res=>{
                const data = res.data;
                return index;
            })
        })
        
    }

    function sms_rent_checkbox_click(obj){
        if($(obj).is(":checked")){
            $('.sms_rent_checkbox').prop('checked',true);
        }else{
            $('.sms_rent_checkbox').prop('checked',false);
        }

    }

    function docs_down(month){
        

        let data_obj = {
            name_arr : [],
            number_arr : []
        }
        $('.msg_data').each(function(i){
            if($('.msg_data').eq(i).children('td').eq(3).text()!=''){
                data_obj.name_arr.push($('.msg_data').eq(i).children('td').eq(1).text());
                data_obj.number_arr.push($('.msg_data').eq(i).children('td').eq(2).text());
            }
        });
        // data_obj.name_arr = Array.from(new Set(data_obj.name_arr));
        // data_obj.number_arr = Array.from(new Set(data_obj.number_arr));
        console.log("data_all",data_obj)
        axios({
            method:'post',
            url:`/send_msg_file_zip`,
            responseType: 'blob',
            data: {
                month:month,
                company:'<%=company%>',
                dataobj:data_obj,
            }
        }).then(res=>{
            const url = window.URL.createObjectURL(new Blob([res.data]));
            const link = document.createElement('a');
            link.href = url;
            link.setAttribute('download', `<%=company%>_${month}월 급여제공기록지.zip`); // 파일명 설정
            document.body.appendChild(link);
            link.click();
        });
    }

    function sendmsg(){
        let custum_mon = `
            <option value="7">7월</option>
            <option value="6">6월</option>
            <option value="5">5월</option>
            <option value="4">4월</option>
            <option value="3">3월</option>
        `;
        let now = new Date();
        let year = now.getFullYear();
        let mon = (now.getMonth() + 1) > 9 ? '' + (now.getMonth() + 1) : '0' + (now.getMonth() + 1);
        let day = now.getDate() > 9 ? '' + now.getDate() : '0' + now.getDate();
        let chan_val = year + '-' + mon + '-' + day;
        let time = now.getHours()+':'+now.getMinutes();
        product_get_money().then(p_obj=>{
            Swal.fire({
                width: '97%',
                fontsize:'25px',
                title: '<div class="sendmsg flex"><span class="material-icons">phone_iphone</span>카카오톡/문자 발송</div>',
                text: "문자발송",
                html:'<div class="flexs" style="font-size:18px; font-weight:bold; margin-top:20px;">'+
                    '<div>'+
                        '<div class="flexcolumns">'+
                            '<table>'+
                                '<thead>'+
                                    '<tr>'+
                                        '<th style="padding-bottom:20px; padding-right:10px; padding-left:10px;">선택</th>'+
                                        '<th style="padding-bottom:20px; padding-right:10px; padding-left:10px;">발신번호 목록</th>'+
                                    '</tr>'+
                                '</thead>'+
                                '<tbody class="popbill_number_list">'+
                                '</tbody>'+
                            '</table>'+
                        '</div>'+
                    '</div>'+
                    `
                    <div class="flexcolumns" style="width:200px;">
                        <div class="popbill_msg_col">문자 발송 내용 선택</div>
                        <div>
                            <div class="popbill_msg_type custum popbill_msg_type_on" onclick="popbill_msg_type_on(this)">(친구톡,SMS)<br/>직접작성</div>
                            <div class="popbill_msg_type doc_1" onclick="popbill_msg_type_on(this)">(친구톡,SMS)<br/>급여제공기록지</div>
                            <!--div class="popbill_msg_type doc_2" onclick="popbill_msg_type_on(this)">(개발중)<br/>욕구사정기록조사</div-->
                            <!--div class="popbill_msg_type doc_3" onclick="popbill_msg_type_on(this)">(개발중)<br/>연장대여동의서</div-->
                            </div>
                    </div>`+
                    '<div class="popbill_msg_custum">'+
                        '<div class="sendnumber flex">발신번호를 선택해주세요</div><div class="flex msgpersonadd" onclick="msgpersonadd()" style="display:none;"><span class="material-icons" style="font-size:30px;">group_add</span>&nbsp;&nbsp;&nbsp;수신자 등록</div><div><div style="background: #122459; color:fff; border-radius:5px;">메시지 내용</div><div><textarea class="msgtxt" style="width:400px; height:510px; border-radius:5px;" placeholder="내용을 입력해주세요."></textarea></div></div>'+
                    '</div>'+
                    `
                    <div style="">
                        <iframe id="print1" class="print1 iprint ion" name="print1" src="//localhost:802/rentnew" frameborder="0" style="position:absolute; top: -2500px; width:912px;" ></iframe>
                        <iframe id="print2" class="print2 iprint ion" name="print1" src="//localhost:802/paymentfile" frameborder="0" style="position:absolute; top: -2500px; width:912px;" ></iframe>

                    </div>
                    `+
                    '<div class="msgoption">'+
                        '<div class="popbill_msg_col">수신자선택</div>'+
                        '<div class="flex" style="margin-bottom:10px;"><div class="msg_option msg_option1 msg_option_on" onclick="popbill_msg_option_on(this);">선택형식</div>&nbsp;&nbsp;&nbsp;<div class="msg_option msg_option2" onclick="popbill_msg_option_on(this);">수급자직접지정</div></div>'+
                        '<div class="flex" style="display:none;"><div>조회시작일</div><input class="date1 datepickerall2" type="text" id="datepicker3" autocomplete="off" value="2022-01-01"></div>'+
                        '<div class="flex" style="display:none;"><div>조회종료일</div><input class="date2 datepickerall2" type="text" id="datepicker4" autocomplete="off" value=""></div>'+
                        '<div class="flexcolumns popbill_msg_target1">'+
                            `<div class="msgselect flex" style="width:100%;">
                                <span>대여월</span>
                                <select id="sval0" class="sval" onchange="sendmsg_client(document.getElementById(\'sval1\').value,document.getElementById(\'sval3\').value,${JSON.stringify(p_obj).replace(/\"/g,'\'')},this.value);">
                                    <option value="1" selected>1월</option>
                                    <option value="3">2월</option>
                                    ${'<%=company%>'=='주식회사 엘케어'?custum_mon:''}
                                </select>
                            </div>
                            <br/>`+
                            `<div class="msgselect flex" style="width:100%;">
                                <span>품목</span>
                                <select id="sval1" class="sval" onchange="sendmsg_client(this.value,document.getElementById(\'sval3\').value,${JSON.stringify(p_obj).replace(/\"/g,'\'')},document.getElementById(\'sval0\').value);">
                                    <option value="all" selected>전체</option>
                                    <option>전동침대</option>
                                    <option>배회감지기</option>
                                    <option>수동휠체어</option>
                                    <option>이동욕조</option>
                                    <option>욕창예방&nbsp;매트리스</option>
                                    <option>경사로(실외용)</option>
                                </select>
                            </div>
                            <br/>`+
                            // '<div class="msgselect flexstart" style="width:100%;"><span>급여유무</span><select id="sval2" class="sval" onchange="selectmsg(document.getElementById(\'sval1\').value,this.value,document.getElementById(\'sval3\').value,document.getElementById(\'sval4\').value);"><option>전체</option><option selected>급여</option><option>비급여</option></select></div><br/>'+
                            `<div class="msgselect flex" style="width:100%;">
                                <span>상태</span>
                                <select id="sval3" class="sval" onchange="sendmsg_client(document.getElementById(\'sval1\').value,this.value,${JSON.stringify(p_obj).replace(/\"/g,'\'')},document.getElementById(\'sval0\').value);">
                                    <option value="none" selected>선택</option>
                                    <option value="current_y">대여중</option>
                                    <option value="current_n">당월 회수</option>
                                    <option value="all">전체</option>
                                </select>
                            </div>
                            <br/>`+
                            // '<div class="msgselect flex" style="width:100%;"><span>대상</span><select id="sval4" class="sval" onchange="sendmsg_client(document.getElementById(\'sval1\').value,document.getElementById(\'sval3\').value,this.value);"><option value="all" selected>전체</option><option>일반|감경</option><option>의료급여|기초</option></select></div><br/>'+
                        '</div>'+
                        '<div class="flexcolumns popbill_msg_target2">'
                            +`
                            <div class="flex">
                                <div>검색</div>&nbsp;&nbsp;&nbsp;<div><input type="text" id="form1" style="width:100%; border-radius:5px; height:30px;" onchange="table_search(this,'#form1','msg_client_tr')"></div><div class="msg_client_button" onlcick="table_search($(this).prev().children('input'),'#form1','msg_client_tr')">검색</div>
                            </div>
                            <br/>
                            <table>
                                <thead>
                                    <tr>
                                        <th>성함</th><th>인정번호</th><th style="display:flex; justify-content:center; text-align:center; align-items:center;"><div class='msg_client_add' onclick='msg_client_add_all()'>+</div><div class='msg_client_remove' style='display:none;' onclick='msg_client_remove_all()'>-</div></th>
                                    </tr>
                                </thead>
                                <tbody class="popbill_msg_target_tbody">
                                </tbody>
                            </table>
                            `+
                        '</div>'+
                    '</div>'+
                    '<div style="width:35%;">'+
                    `<div class="msgpersonlist flexcolumns">
                    <div>수신자&nbsp;&nbsp;:&nbsp;&nbsp;<span class="msgpersoncnt"></span>명</div>
                    <div class="flex"><div onclick="docs_preview(this)" class="off docs_preview">급여제공기록지<br/>미리보기</div>&nbsp;&nbsp;<div onclick="docs_down($('#sval0').val())" class="docs_down" style="display:none;">급여제공기록지<br/>내려받기</div> <div>검색:<input type="text" id="form2" style="width:50%; border-radius:5px; height:30px;" onchange="table_search(this,'#form2','msg_data')"></div></div>
                    <div><table class="swal_msg_client_table">`+
                    `
                    <thead class="swal_msg_client_thead">
                        <tr class="msg_client_thead1">
                            <th><input type="checkbox" class="sms_rent_checkbox_th" style="width:20px; height:20px;" onclick="sms_rent_checkbox_click(this)" checked></th><th>성함</th><th>인정번호</th><th>대여품목</th><th>연락처</th><th>대여종료일</th>
                        </tr>
                        <tr class="msg_client_thead2" style="display:none;">
                            <th></th><th>성함</th><th>인정번호</th><th>연락처</th>
                        </tr>
                    </thead>
                    <tbody class="msg_client">
                        <div class="reloading" style="">
                            <br/>
                        <div class="loading">
                            <div class="sk-folding-cube">
                                <div class="sk-cube1 sk-cube"></div>
                                <div class="sk-cube2 sk-cube"></div>
                                <div class="sk-cube4 sk-cube"></div>
                                <div class="sk-cube3 sk-cube"></div>
                            </div>
                            <br/>
                            <div class="flex"><div class="sendmsg_make_doc_cnt"></div>명</div>
                            <br/>
                            <div>&nbsp;&nbsp;&nbsp;선택월 급여제공기록지 생성중&nbsp;&nbsp;&nbsp;</div>
                            <br/>
                            <div>&nbsp;&nbsp;*수신자에 따라 소요시간이 길어질수있습니다.&nbsp;&nbsp;</div>
                            <br/>
                        </div>
                    </div></tbody>
                    `+
                    '</table></div></div>'+
                    '</div>'+
                    
                    '</div>'+
                    `
                    <div style="display:none;">
                        <div class="flex"><div class="msg_send_ok">발송</div>&nbsp;&nbsp;&nbsp;<div class="msg_send_cancle">취소</div></div>
                    </div>
                    <div class="msg_send_confirm_chk_div flex" style="display:none;">
                        예약일시 :&nbsp;&nbsp;
                        <div class="msg_send_confirm_chk" style="color:#000;">
                            
                        </div>
                        </div>
                        <br/>
                    </div>
                    `,
                //icon: 'question',
                showCancelButton: true,
                showDenyButton: true,
                showConfirmButton:false,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                denyButtonText :'예약발송',
                confirmButtonText: '즉시발송',
                showLoaderOnConfirm: true,
                showLoaderOnDeny:true,
                cancelButtonText: '취소',
                allowOutsideClick: false,
                didOpen: () => {
                    //Swal.disableButtons();
                    GetSenderNumberList();
                    ListATSTemplate();
                    ListPlusFriendID();
                    $('.msgpersoncnt').text($('.msgnumber').length);
                    $( "#datepicker3" ).datepicker({
                        changeMonth: true,
                        changeYear: true
                    });
                    $( "#datepicker4" ).datepicker({
                        changeMonth: true,
                        changeYear: true
                    });
                    $( "#datepicker3,#datepicker4" ).datepicker( "option", "showAnim", "slide" );
                    
                    // if(sval1!=' '&&sval1!=null)$('.sval').eq(0).val(sval1).prop("selected", true);
                    // if(sval2!=' '&&sval2!=null)$('.sval').eq(1).val(sval2).prop("selected", true);
                    // if(sval3!=' '&&sval3!=null)$('.sval').eq(2).val(sval3).prop("selected", true);
                    // if(sval4!=' '&&sval4!=null)$('.sval').eq(3).val(sval4).prop("selected", true);
                },
                preConfirm: () => {
                    reservation_data = '';
                    $('.msg_send_confirm_chk').text('');
                    if(parseInt(document.querySelector('.msgpersoncnt').innerHTML)==0){
                        Swal.showValidationMessage(`
                            발송실패: 수신자가 없습니다.
                        `);
                        return false
                    }else if($('.msgtxt').val()==''){
                        Swal.showValidationMessage(`
                            발송실패: 발신 내용이 없습니다.
                        `);
                        return false
                    }else if(send_number==''){
                        Swal.showValidationMessage(`
                            발송실패: 발신번호를 선택해주세요.
                        `);
                        return false
                    }else if(parseInt(document.querySelector('.msgpersoncnt').innerHTML)>0){
                        let name_arr = [];
                        let number_arr = [];
                        let phone_arr = [];
                        //let popbill_id = 'wjdwdhrkr2';
                        let tcode = '';
                        let content = '';
                        if($('.msg_option_on').hasClass('msg_option1')){
                            $.each($('.msg_data'),function(i){
                                if($('.msg_data').eq(i).children('td').eq(3).text()!=''){
                                    name_arr.push($('.msg_data').eq(i).children('td').eq(1).text());
                                    number_arr.push($('.msg_data').eq(i).children('td').eq(2).text());
                                    phone_arr.push($('.msg_data').eq(i).children('td').eq(4).text());
                                }
                            });
                        }else if($('.msg_option_on').hasClass('msg_option2')){
                            $.each($('.msg_data'),function(i){
                                if($('.msg_data').eq(i).children('td').eq(3).text()!=''){
                                    name_arr.push($('.msg_data').eq(i).children('td').eq(1).text());
                                    number_arr.push($('.msg_data').eq(i).children('td').eq(2).text());
                                    phone_arr.push($('.msg_data').eq(i).children('td').eq(3).text());
                                }
                            });
                        }
                        console.log(name_arr,number_arr,phone_arr,tcode,send_number,content);
                        if(phone_arr.length>0){
                            if($('.popbill_msg_type_on').hasClass('kakao_template')){
                                tcode = $('.popbill_msg_type_on').children('input').val();
                                content = $('.popbill_msg_type_on').children('textarea').val();
                                axios({
                                    method:'post',
                                    url:'/SendATS_multi',
                                    data:{
                                        name:name_arr,
                                        number:number_arr,
                                        phone:phone_arr,
                                        tcode:tcode,
                                        sendnumber:send_number,
                                        content:content,
                                        companynum:companynumber,
                                        popbillid:popbill_id
                                    }
                                }).then(res=>{
                                    console.log(res);
                                    if(res.data.data.code){
                                        Swal.fire(
                                            '전송 실패',
                                            res.data.data.message,
                                            'error'
                                        )
                                    }else{
                                        Swal.fire(
                                            '전송 완료',
                                            '',
                                            'success'
                                        )
                                    }
                                })
                            }else if($('.popbill_msg_type_on').hasClass('custum')){
                                console.log(kakao_channel_name);
                                content = $('.msgtxt').val();
                                axios({
                                    method:'post',
                                    url:'/SendFTS_multi',
                                    data:{
                                        name:name_arr,
                                        number:number_arr,
                                        phone:phone_arr,
                                        tcode:tcode,
                                        sendnumber:send_number,
                                        content:content,
                                        companynum:companynumber,
                                        kakaochannelname:kakao_channel_name,
                                        popbillid:popbill_id,
                                        type:'',
                                        company:"<%=company%>"
                                    }
                                }).then(res=>{
                                    console.log('??',res.data.data.code);
                                    console.log(res)
                                    if(res.data.data.code){
                                        Swal.fire(
                                            '전송 실패',
                                            res.data.data.message,
                                            'error'
                                        )
                                    }else{
                                        Swal.fire(
                                            '전송 완료',
                                            '',
                                            'success'
                                        )
                                    }
                                })
                            }else if($('.popbill_msg_type_on').hasClass('doc_1')){
                                console.log(kakao_channel_name);
                                content = $('.msgtxt').val();
                                let doc_num_arr = [1];
                                let month = document.getElementById('sval0').value;
                                sms_insert(name_arr,number_arr,"<%=company%>",send_number,phone_arr,doc_num_arr,'basic',month).then(res=>{
                                    if(res.code==200){
                                        axios({
                                            method:'post',
                                            url:'/SendFMS_multi',
                                            data:{
                                                name:name_arr,
                                                number:number_arr,
                                                phone:phone_arr,
                                                tcode:tcode,
                                                sendnumber:send_number,
                                                content:content,
                                                companynum:companynumber,
                                                kakaochannelname:kakao_channel_name,
                                                popbillid:popbill_id,
                                                company:'<%=company%>',
                                                docarr:doc_num_arr,
                                                signkey:res.signkey,
                                                orderkey:month,
                                                type:'orderDoc'
                                            }
                                        }).then(res=>{
                                            console.log(res.data)
                                            console.log('??',res.data.data.code)
                                            if(res.data.data.code){
                                                Swal.fire(
                                                    '전송 실패',
                                                    res.data.data.message,
                                                    'error'
                                                )
                                            }else{
                                                Swal.fire(
                                                    '전송 완료',
                                                    '',
                                                    'success'
                                                )
                                            }
                                            
                                        })
                                    }
                                });

                                /**************
                                //문자 발송 요청
                                ***************/
                                // axios({
                                //     method:'post',
                                //     url:'/SendMMS_multi',
                                //     data:{
                                //         name:name_arr,
                                //         number:number_arr,
                                //         phone:phone_arr,
                                //         tcode:tcode,
                                //         sendnumber:send_number,
                                //         content:content,
                                //         companynum:companynumber,
                                //         kakaochannelname:kakao_channel_name,
                                //         popbillid:popbill_id,
                                //         company:'<%=company%>',
                                //     }
                                // }).then(res=>{
                                //     console.log('??',res)
                                //     if(res.data.data.code){
                                //         Swal.fire(
                                //             '전송 실패',
                                //             res.data.data.message,
                                //             'error'
                                //         )
                                //     }else{
                                //         Swal.fire(
                                //             '전송 완료',
                                //             '',
                                //             'success'
                                //         )
                                //     }
                                    
                                // })
                            }else if($('.popbill_msg_type_on').hasClass('doc_2')){
                                content = $('.msgtxt').val();
                                axios({
                                    method:'post',
                                    url:'/SendFTS_multi',
                                    data:{
                                        name:name_arr,
                                        number:number_arr,
                                        phone:phone_arr,
                                        tcode:tcode,
                                        sendnumber:send_number,
                                        content:content,
                                        companynum:companynumber,
                                        kakaochannelname:kakao_channel_name,
                                        popbillid:popbill_id,
                                        type:'doc2',
                                        company:"<%=company%>"
                                    }
                                }).then(res=>{
                                    console.log('??',res.data.data.code);
                                    console.log(res)
                                    if(res.data.data.code){
                                        Swal.fire(
                                            '전송 실패',
                                            res.data.data.message,
                                            'error'
                                        )
                                    }else{
                                        Swal.fire(
                                            '전송 완료',
                                            '',
                                            'success'
                                        )
                                    }
                                })
                            }
                        }else{
                            Swal.showValidationMessage(`
                                발송실패: 수신자 번호 없음
                            `);
                            return false
                        }
                        
                        
                    }
                    
                    // $.each($('.msgnumber'),function(i){
                    //     $.ajax({
                    //     url: "/bizmsg",
                    //     data: "id=" + result.result[0].bizid + "&company=<%=company%>"+ "&bizphonenum="+bizphonenum+ "&biztonum="+$('.msgnumber').eq(i).text().replace(reg, '')+ "&biztxt="+$('.msgtxt').val(),
                    //     type: 'POST',
                    //     dataType: "JSON",
                    //     success: function (result) {
                    //         if(result){
                    //         Swal.fire({
                    //             icon: 'success',
                    //             width:'500px',
                    //             title: '발송완료',
                    //             allowOutsideClick: false,
                    //         });
                    //         }
                    //     }
                    //     });
                    // });
                }, 
                preDeny:()=>{
                    if(send_number==''){
                        Swal.showValidationMessage(`
                            발송실패: 발신번호를 선택해주세요.
                        `);
                        return false
                    }else if(parseInt(document.querySelector('.msgpersoncnt').innerHTML)==0){
                        Swal.showValidationMessage(`
                            발송실패: 수신자가 없습니다.
                        `);
                        return false;
                    }else if($('.msgtxt').val()==''){
                        Swal.showValidationMessage(`
                            발송실패: 발신 내용이 없습니다.
                        `);
                        return false;
                    }else if(reservation_data==''){
                        Swal.showValidationMessage(`
                            <div class="reservation_div">예약일시 선택:<input type="date" style="height:30px;" id="reservation_date" value="`+chan_val+`" onchange="reservation_set(this.value,document.getElementById('reservation_time').value)"><input id="reservation_time" style="height:30px;" type="time" value="`+time+`" onchange="reservation_set(document.getElementById('reservation_date').value,this.value)"></div>
                        `);
                        return false;
                    }else{
                        if(parseInt(document.querySelector('.msgpersoncnt').innerHTML)>0){
                            let name_arr = [];
                            let number_arr = [];
                            let phone_arr = [];
                            //let popbill_id = 'wjdwdhrkr2';
                            let tcode = '';
                            let content = '';
                            if($('.msg_option_on').hasClass('msg_option1')){
                                $.each($('.msg_data'),function(i){
                                    if($('.msg_data').eq(i).children('td').eq(3).text()!=''){
                                        if($('.msg_data').eq(i).children('td').eq(0).children('input').is(":checked")){
                                            if(!number_arr.includes($('.msg_data').eq(i).children('td').eq(2).text())){
                                                name_arr.push($('.msg_data').eq(i).children('td').eq(1).text());
                                                number_arr.push($('.msg_data').eq(i).children('td').eq(2).text());
                                                phone_arr.push($('.msg_data').eq(i).children('td').eq(4).text());
                                            }
                                        }
                                    }
                                });
                            }else if($('.msg_option_on').hasClass('msg_option2')){
                                $.each($('.msg_data'),function(i){
                                    if($('.msg_data').eq(i).children('td').eq(3).text()!=''){
                                        if(!number_arr.includes($('.msg_data').eq(i).children('td').eq(1).text())){
                                            name_arr.push($('.msg_data').eq(i).children('td').eq(1).text());
                                            number_arr.push($('.msg_data').eq(i).children('td').eq(2).text());
                                            phone_arr.push($('.msg_data').eq(i).children('td').eq(3).text());
                                        }
                                    }
                                });
                            }
                            console.log(name_arr,number_arr,phone_arr,tcode,send_number,content);
                            if(phone_arr.length>0){
                                if($('.popbill_msg_type_on').hasClass('kakao_template')){
                                    tcode = $('.popbill_msg_type_on').children('input').val();
                                    content = $('.popbill_msg_type_on').children('textarea').val();
                                    axios({
                                        method:'post',
                                        url:'/SendATS_multi',
                                        data:{
                                            name:name_arr,
                                            number:number_arr,
                                            phone:phone_arr,
                                            tcode:tcode,
                                            sendnumber:send_number,
                                            content:content,
                                            companynum:companynumber,
                                            reservation:reservation_data,
                                            popbillid:popbill_id
                                        }
                                    }).then(res=>{
                                        console.log(res);
                                        reservation_data='';
                                        Swal.fire(
                                            '전송 완료',
                                            '',
                                            'success'
                                        )
                                    })
                                }else if($('.popbill_msg_type_on').hasClass('custum')){
                                    console.log(kakao_channel_name);
                                    content = $('.msgtxt').val();
                                    axios({
                                        method:'post',
                                        url:'/SendFTS_multi',
                                        data:{
                                            name:name_arr,
                                            number:number_arr,
                                            phone:phone_arr,
                                            tcode:tcode,
                                            sendnumber:send_number,
                                            content:content,
                                            companynum:companynumber,
                                            kakaochannelname:kakao_channel_name,
                                            reservation:reservation_data,
                                            popbillid:popbill_id,
                                            type:'',
                                            company:"<%=company%>"
                                        }
                                    }).then(res=>{
                                        console.log(res);
                                        reservation_data='';
                                        Swal.fire(
                                            '예약 전송 완료',
                                            '',
                                            'success'
                                        )
                                    })
                                }else if($('.popbill_msg_type_on').hasClass('doc_1')){
                                    // content = $('.msgtxt').val();
                                    // axios({
                                    //     method:'post',
                                    //     url:'/SendFMS_multi',
                                    //     data:{
                                    //         name:name_arr,
                                    //         number:number_arr,
                                    //         phone:phone_arr,
                                    //         tcode:tcode,
                                    //         sendnumber:send_number,
                                    //         content:content,
                                    //         companynum:companynumber,
                                    //         kakaochannelname:kakao_channel_name,
                                    //         reservation:reservation_data,
                                    //         popbillid:popbill_id,
                                    //         company:'<%=company%>',

                                    //     }
                                    // }).then(res=>{
                                    //     console.log(res);
                                    //     reservation_data='';
                                    //     Swal.fire(
                                    //         '예약 전송 완료',
                                    //         '',
                                    //         'success'
                                    //     )
                                    // })
                                    console.log(kakao_channel_name);
                                    content = $('.msgtxt').val();
                                    let doc_num_arr = [0,1];
                                    let month = document.getElementById('sval0').value;
                                    sms_insert(name_arr,number_arr,"<%=company%>",send_number,phone_arr,doc_num_arr,'basic',month).then(res=>{  
                                        axios({
                                            method:'post',
                                            url:'/SendFTS_multi',
                                            data:{
                                                name:name_arr,
                                                number:number_arr,
                                                phone:phone_arr,
                                                tcode:tcode,
                                                sendnumber:send_number,
                                                content:content,
                                                companynum:companynumber,
                                                kakaochannelname:kakao_channel_name,
                                                popbillid:popbill_id,
                                                company:'<%=company%>',
                                                docarr:doc_num_arr,
                                                signkey:"1",
                                                orderkey:month,
                                                type:'orderDoc',
                                                reservation:reservation_data,
                                            }
                                        }).then(res=>{
                                            console.log(res.data)
                                            console.log('??',res.data.data.code)
                                            reservation_data='';
                                            if(res.data.data.code){
                                                Swal.fire(
                                                    '예약 전송 완료',
                                                    res.data.data.message,
                                                    'error'
                                                )
                                            }else{
                                                Swal.fire(
                                                    '예약 전송 완료',
                                                    '',
                                                    'success'
                                                )
                                            }
                                            
                                        })
                                        
                                    });

                                }else if($('.popbill_msg_type_on').hasClass('doc_2')){
                                    console.log(kakao_channel_name);
                                    content = $('.msgtxt').val();
                                    axios({
                                        method:'post',
                                        url:'/SendFTS_multi',
                                        data:{
                                            name:name_arr,
                                            number:number_arr,
                                            phone:phone_arr,
                                            tcode:tcode,
                                            sendnumber:send_number,
                                            content:content,
                                            companynum:companynumber,
                                            kakaochannelname:kakao_channel_name,
                                            reservation:reservation_data,
                                            popbillid:popbill_id,
                                            type:'doc2',
                                            company:"<%=company%>"
                                        }
                                    }).then(res=>{
                                        console.log(res);
                                        reservation_data='';
                                        Swal.fire(
                                            '예약 전송 완료',
                                            '',
                                            'success'
                                        )
                                    })
                                }
                                
                            }else{
                                Swal.showValidationMessage(`
                                    발송실패: 수신자 번호 없음
                                `);
                                return false;
                            }
                            
                            
                        }
                    }
                    
                    
                },
                didDestroy:()=>{
                    $('.popbill_dom').css({"top":-4000,"left":0});
                }
                // allowOutsideClick: () => !Swal.isLoading(),
            }).then((result) => {
                if (result.isConfirmed) {

                }else if(result.isDenied){
                    
                }else if(result.dismiss){
                    sendMessage_stop = 1;
                }
            });
        });
        
        // $.ajax({
        //     url: "/biztable",
        //     data: "id=" + uid + "&company=<%=company%>",
        //     type: "POST",
        //     dataType: "JSON",
        //     async:false,
        //     success: function (result) {
        //         if (result.code==200) {
        //             var reg = /[\{\}\[\]\/?.,;:|\)*~`!^\-_+<>@\#$%&\\\=\(\'\"]/gi;
        //             //var bizphonenum = result.result[0].bizphonenum.replace(reg, '');
        //             Swal.fire({
        //                 width: '1300px',
        //                 fontsize:'25px',
        //                 title: '<div class="sendmsg flex"><span class="material-icons">phone_iphone</span>문자 발송</div>',
        //                 text: "문자발송",
        //                 html:'<div class="flexs" style="font-size:18px; font-weight:bold; margin-top:20px;">'+
        //                     '<div>'+
        //                     '<div class="sendnumber">발신번호 [  ] </div><div class="flex msgpersonadd" onclick="msgpersonadd()" style="display:none;"><span class="material-icons" style="font-size:30px;">group_add</span>&nbsp;&nbsp;&nbsp;수신자 등록</div><div><div style="background: #122459; color:fff;">메시지 내용</div><div><textarea class="msgtxt" style="width:600px; height:380px; background:#fbffd8" placeholder="내용을 입력해주세요."></textarea></div></div>'+
        //                     '</div>'+
        //                     '<div class="msgoption">'+
        //                         '<div>수신자선택</div><br/>'+
        //                         '<div class="flex" style="display:none;"><div>조회시작일</div><input class="date1 datepickerall2" type="text" id="datepicker3" autocomplete="off" value="2022-01-01"></div><br/>'+
        //                         '<div class="flex" style="display:none;"><div>조회종료일</div><input class="date2 datepickerall2" type="text" id="datepicker4" autocomplete="off" value="'+chan_val+'"></div><br/>'+
        //                         '<div class="flexcolumns">'+
        //                         '<div class="msgselect flexstart" style="width:100%;"><span>품목</span><select id="sval1" class="sval" onchange="selectmsg(this.value,document.getElementById(\'sval2\').value,document.getElementById(\'sval3\').value,document.getElementById(\'sval4\').value);"><option selected>전체</option><option>전동침대</option><option>배회감지기</option><option>휠체어</option><option>이동욕조</option><option>욕창예방매트리스</option></select></div><br/>'+
        //                         '<div class="msgselect flexstart" style="width:100%;"><span>급여유무</span><select id="sval2" class="sval" onchange="selectmsg(document.getElementById(\'sval1\').value,this.value,document.getElementById(\'sval3\').value,document.getElementById(\'sval4\').value);"><option>전체</option><option selected>급여</option><option>비급여</option></select></div><br/>'+
        //                         '<div class="msgselect flexstart" style="width:100%;"><span>상태</span><select id="sval3" class="sval" onchange="selectmsg(document.getElementById(\'sval1\').value,document.getElementById(\'sval2\').value,this.value,document.getElementById(\'sval4\').value);"><option selected>전체</option><option value="'+year+'-'+mon+'-'+lastdate+'">'+mon+'월 계약종료예정자</option></select></div><br/>'+
        //                         '<div class="msgselect flexstart" style="width:100%;"><span>대상</span><select id="sval4" class="sval" onchange="selectmsg(document.getElementById(\'sval1\').value,document.getElementById(\'sval2\').value,document.getElementById(\'sval3\').value,this.value);"><option selected>전체</option><option>일반|감경</option><option>의료급여|기초</option></select></div><br/>'+
        //                         '</div>'+
        //                     '</div>'+
        //                     '<div>'+
        //                     '<div class="msgpersonlist flexcolumns"><div>수신자&nbsp;&nbsp;:&nbsp;&nbsp;<span class="msgpersoncnt"></span>명</div><div class="msgpersonlistbox flexcolumns">'+str+'</div></div>'+
        //                     '</div>'+
        //                     '</div>',
        //                 //icon: 'question',
        //                 showCancelButton: true,
        //                 confirmButtonColor: '#3085d6',
        //                 cancelButtonColor: '#d33',
        //                 confirmButtonText: '발송',
        //                 showLoaderOnConfirm: true,
        //                 cancelButtonText: '취소',
        //                 allowOutsideClick: false,
        //                 didOpen: () => {
        //                     $('.msgpersoncnt').text($('.msgnumber').length);
        //                     $( "#datepicker3" ).datepicker({
        //                         changeMonth: true,
        //                         changeYear: true
        //                     });
        //                     $( "#datepicker4" ).datepicker({
        //                         changeMonth: true,
        //                         changeYear: true
        //                     });
        //                     $( "#datepicker3,#datepicker4" ).datepicker( "option", "showAnim", "slide" );
                            
        //                     if(sval1!=' '&&sval1!=null)$('.sval').eq(0).val(sval1).prop("selected", true);
        //                     if(sval2!=' '&&sval2!=null)$('.sval').eq(1).val(sval2).prop("selected", true);
        //                     if(sval3!=' '&&sval3!=null)$('.sval').eq(2).val(sval3).prop("selected", true);
        //                     if(sval4!=' '&&sval4!=null)$('.sval').eq(3).val(sval4).prop("selected", true);
        //                 },
        //                 preConfirm: () => {
        //                     // $.each($('.msgnumber'),function(i){
        //                     //     $.ajax({
        //                     //     url: "/bizmsg",
        //                     //     data: "id=" + result.result[0].bizid + "&company=<%=company%>"+ "&bizphonenum="+bizphonenum+ "&biztonum="+$('.msgnumber').eq(i).text().replace(reg, '')+ "&biztxt="+$('.msgtxt').val(),
        //                     //     type: 'POST',
        //                     //     dataType: "JSON",
        //                     //     success: function (result) {
        //                     //         if(result){
        //                     //         Swal.fire({
        //                     //             icon: 'success',
        //                     //             width:'500px',
        //                     //             title: '발송완료',
        //                     //             allowOutsideClick: false,
        //                     //         });
        //                     //         }
        //                     //     }
        //                     //     });
        //                     // });
        //                 }, 
        //                 allowOutsideClick: () => !Swal.isLoading(),
        //             }).then((result) => {
        //                 if (result.isConfirmed) {
                        
        //                 }
        //             });
        //         }else{
        //         Swal.fire({
        //             icon: 'warning',
        //             width:'500px',
        //             title: result.msg,
        //             allowOutsideClick: false,
        //         });
        //         }
        //     }
        // });
    }

    function msg_content_view(){

    }

    function sendmsg_get_history(pagenum,sdate,edate,search){
        console.log('?',sdate,edate)
        axios({
            method:'post',
            url:'/Sendmsg_Search',
            data:{
                companynum:companynumber,
                sdate:sdate.replace(/[^0-9]/g,''),
                edate:edate.replace(/[^0-9]/g,''),
                popbillid:popbill_id,
                pagenum:pagenum,
                search:search
            }
        }).then(res=>{
            $('.msg_history_paging, .msg_history_tbody').children().remove();
            console.log(res.data.data);
            if(res.data.data.code==-15002109){
                Swal.showValidationMessage(`
                    <div style="font-weight:bold; font-size:20px;">검색실패: 조회기간은 2개월을 초과할 수 없습니다.</div>
                `);
            }else{
                Swal.resetValidationMessage();
                const data = res.data.data.result;
                let pstr ='';
                let str = '';
                let pclick1 = '';
                let pclick2 = '';
                let pclick3 = '';
                let pclick4 = '';
                let pnum = '';
                let pnumclick = '';
                if (data.list.length != 0) {
                    if(data.pageNum-10<1){
                        pclick1='disabled';
                    }else{
                        pclick1='waves-effect';
                    }
                    if(data.pageNum==1){
                        pclick2='disabled';
                    }else{
                        pclick2='waves-effect';
                    }
                    if(data.pageNum==data.pageCount){
                        pclick3='disabled';
                    }else{
                        pclick3='waves-effect';
                    }
                    if(data.pageNum+10>data.pageCount){
                        pclick4='disabled';
                    }else{
                        pclick4='waves-effect';
                    }
                    for(var j=1; j<=data.pageCount; j++){
                        if(j===data.pageNum){
                            pnumclick = 'active';
                        }else{
                            pnumclick = '';
                        }
                        pnum += '<li class="'+pnumclick+'"><a class="pnumlock" style="z-index:0;" >'+j+'</a></li>';
                    }
                    pstr =
                        '<td class="msg_paging" colspan="21">'+
                        '<div class="tablemenutop" style="text-align:center;">'+
                        '<div class="mobile"></div>'+
                        '<ul class="pagination">'+
                            '<li class="'+pclick1+'"><a onclick='+((data.pageNum-10 >= 1) ?'sendmsg_get_history('+(data.pageNum-10)+',\''+sdate+'\',\''+edate+'\',\''+search+'\')':'')+'><i class="material-icons">keyboard_double_arrow_left</i></a></li>'+
                                '<li class="'+pclick2+'"><a onclick='+((data.pageNum>1) ?'sendmsg_get_history('+(data.pageNum-1)+',\''+sdate+'\',\''+edate+'\',\''+search+'\')':'')+'><i class="material-icons">chevron_left</i></a></li>'+
                                    pnum+
                                '<li class="'+pclick3+'"><a class="waves-effect" onclick='+((data.pageNum<data.pageCount) ?'sendmsg_get_history('+(data.pageNum+1)+',\''+sdate+'\',\''+edate+'\',\''+search+'\')':'')+'><i class="material-icons">chevron_right</i></a></li>'+
                            '<li class="'+pclick4+'"><a class="waves-effect" onclick='+((data.pageNum+10 <= data.pageCount) ?'sendmsg_get_history('+(data.pageNum+10)+',\''+sdate+'\',\''+edate+'\',\''+search+'\')':'')+'><i class="material-icons">keyboard_double_arrow_right</i></a></li>'+
                            '</ul><div class="topmenuright mobile"></div>'+
                        '</div>'+
                        '</td>';


                    data.list.forEach((obj,index)=>{
                        const dateString = obj.regDT;
                        const year = dateString.slice(0, 4);
                        const month = dateString.slice(4, 6);
                        const day = dateString.slice(6, 8);
                        const hour = dateString.slice(8, 10);
                        const minute = dateString.slice(10, 12);
                        const date = new Date(`${year}-${month}-${day}T${hour}:${minute}:00`);
                        const formattedDate = `${date.getFullYear()}년 ${String(date.getMonth() + 1).padStart(2, '0')}월 ${String(date.getDate()).padStart(2, '0')}일 ${String(date.getHours()).padStart(2, '0')}시 ${String(date.getMinutes()).padStart(2, '0')}분`;
                        let content = obj.content;
                        let content_re = obj.content;
                        if (content.length > 10) {
                            content_re = content.slice(0, 20) + "...";
                        }
                        let contenttype = '';
                        if(obj.contentType==1){
                            contenttype = '알림톡';
                        }else if(obj.contentType==2){
                            contenttype = '친구톡';
                        }else if(obj.contentType==3){
                            contenttype = '친구톡(이미지)';
                        }
                        let contentstate = '';
                        if(obj.state==0){
                            contentstate = '전송대기';
                        }else if(obj.result==1){
                            contentstate = '전송중';
                        }else if(obj.result==100){
                            contentstate = '전송성공';
                        }else if(obj.result==634){
                            contentstate = '대체문자 전송';
                        }else if(obj.result==400){
                            contentstate = '전송실패';
                        }else if(obj.result==5){
                            contentstate = '전송취소';
                        }
                        str += '<tr class="msg_history_data"><td>'+formattedDate+'</td><td>'+obj.receiveName+'</td><td>'+obj.receiveNum+'</td>'+`<input type="hidden" value="${content}"><td onclick="msg_content_view_show(this);" style="cursor:pointer;">${content_re}</td>`+'<td>'+contenttype+'</td><td>'+contentstate+'</td></tr>';
                    });

                }
                $('.msg_history_paging').append(pstr);
                $('.msg_history_tbody').append(str);
                $('.pnumlock').on('click',async function(){
                    await sendmsg_get_history($(this).text(),sdate,edate,search);
                    //$(this).parent().addClass("disabled");
                });
            }
        });
    }

    function enterkey2(x) {
        if (window.event.keyCode == 13) {
            sendmsg_get_history(1,$('#msg_datepicker1').val(),$('#msg_datepicker2').val(),$(x).val());        
        }
    }

    function dateInputm(n,m){
        var date = new Date();
        var start = new Date(Date.parse(date)-n* 1000 * 60 * 60 * 24);
        var today = new Date(Date.parse(date)-m* 1000 * 60 * 60 * 24);
        
        if(n < 10){
            start.setMonth(start.getMonth()-n);
        }
        var yyyy = start.getFullYear();
        var mm = start.getMonth()+1;
        var dd = start.getDate();
        
        var t_yyyy = today.getFullYear();
        var t_mm = today.getMonth()+1;
        var t_dd = today.getDate();
        
        return yyyy+'-'+addzero(mm)+'-'+addzero(dd);
        //return t_yyyy+'-'+addzero(t_mm)+'-'+addzero(t_dd);
        
    }

    function addzero(n){                        // 한자리가 되는 숫자에 "0"을 넣어주는 함수
        return n < 10 ? "0" + n: n;
    }
    
    function dateInputd(n,m){
            var date = new Date();
            var start = new Date(Date.parse(date)-n* 1000 * 60 * 60 * 24);
            var today = new Date(Date.parse(date)-m* 1000 * 60 * 60 * 24);
            
            if(n < 10){
                start.setMonth(start.getMonth()-n);
            }
            var yyyy = start.getFullYear();
            var mm = start.getMonth()+1;
            var dd = start.getDate();
            
            var t_yyyy = today.getFullYear();
            var t_mm = today.getMonth()+1;
            var t_dd = today.getDate();
            
            //return yyyy+'-'+addzero(mm)+'-'+addzero(dd);
            return t_yyyy+'-'+addzero(t_mm)+'-'+addzero(t_dd);
            
        }

    function datesearch2(x){
            $('.swal_top_search').val('');
            let now = new Date();
            let year = now.getFullYear();
            let mon = (now.getMonth() + 1) > 9 ? '' + (now.getMonth() + 1) : '0' + (now.getMonth() + 1);
            let day = now.getDate() > 9 ? '' + now.getDate() : '0' + now.getDate();
            let chan_val = year + '-' + mon + '-' + day;
            let startdt ='';
            let enddt ='';
            if(x=='dday'){
                startdt = chan_val;
                enddt = chan_val;
            }else if(x=='yday'){
                startdt = dateInputd(0,1);
                enddt = dateInputd(0,1);
            }else if(x=='dmon'){
                let lastDate = new Date(dateInputd(0,0).split('-')[0], dateInputm(0,0).split('-')[1], 0);
                const rentmoneycal = lastDate.getDate()    
                startdt = dateInputd(0,0).split('-')[0]+'-'+dateInputm(0,0).split('-')[1]+'-01';
                enddt = dateInputd(0,0).split('-')[0]+'-'+dateInputm(0,0).split('-')[1]+'-'+rentmoneycal;
            }else if(x=='ymon'){
                let lastDate = new Date(dateInputm(1,0).split('-')[0], dateInputm(1,0).split('-')[1], 0);
                const rentmoneycal = lastDate.getDate()    
                startdt = dateInputm(1,0).split('-')[0]+'-'+dateInputm(1,0).split('-')[1]+'-01';
                enddt = dateInputm(1,0).split('-')[0]+'-'+dateInputm(1,0).split('-')[1]+'-'+rentmoneycal;
            }else if(x=='all'){
                startdt = '1999-01-01';
                enddt = '2099-01-01';
            }
            sendmsg_get_history(1,startdt,enddt,'');
            $('#msg_datepicker1').val(startdt);
            $('#msg_datepicker2').val(enddt);
        }

        function msg_content_view_close(){
            $('.msg_content_view').fadeOut();
        }

        function msg_content_view_show(x){
            $('.msg_content_view').fadeIn();
            const data = $(x).parents('tr').children('td');
            const content = $(x).parents('tr').children('input').val();
            $('.msg_content_date').text($(data).eq(0).text());
            $('.msg_content_name').text($(data).eq(1).text());
            $('.msg_content_phone').text($(data).eq(2).text());
            $('.msg_content_type').text($(data).eq(4).text());
            $('.msg_content_state').text($(data).eq(5).text());
            $('.msg_content_data').text(content)
        }

    async function sendmsg_get_url(){
        return axios({
            method:'post',
            url:'/SendMsgGetUrl',
            data:{
                companynumber:companynumber,
                popbillid:popbill_id
            }
        }).then(res=>{
            const data = res.data;
            
            if(data){
                return data
            }
        });
    }

    async function sendkakao_get_url(){
        return axios({
            method:'post',
            url:'/SendKakaoGetUrl',
            data:{
                companynumber:companynumber,
                popbillid:popbill_id
            }
        }).then(res=>{
            const data = res.data;
            
            if(data){
                return data
            }
        });
    }

    function get_kakao_history(){
        sendkakao_get_url().then(res=>{
            console.log('result:',res.data.result);
            window.open(res.data.result, "_blank");
            // let str = `
            // <iframe src="${res.data.result}" class="sendmsg_iframe">
            // `;
            // $('.msg_iframe_area').append(str);
        });
    }

    function get_msg_history(){
        sendmsg_get_url().then(res=>{
            console.log('result:',res.data.result);
            window.open(res.data.result, "_blank");
            // let str = `
            // <iframe src="${res.data.result}" class="sendmsg_iframe">
            // `;
            // $('.msg_iframe_area').append(str);
        });
    }

    function sendmsg_history2(){
        Swal.fire({
            width: '20%',
            fontsize:'25px',
            confirmButtonText:"닫기",
            html:`
            <div class="flex">
                <div class="history_btn" onclick="get_msg_history()">문자발송내역</div>&nbsp;&nbsp;&nbsp;
                <div class="history_btn" onclick="get_kakao_history()">카카오톡발송내역</div>
            </div>
            `,
            didOpen:()=>{
                
            }
        });
    }

    function sendmsg_history(){
        Swal.fire({
            width: '97%',
            fontsize:'25px',
            title: '<div class="sendmsg flex"><span class="material-icons">phone_iphone</span>카카오톡/문자 발송 내역</div>',
            html:`
            <div class="msg_history_top flex">
                <div class="msg_history_top_date flex">
                    <div class="swal_date">
                        <input type="text" class="swal_input_date" id="msg_datepicker1" autocomplete='off'>&nbsp;~&nbsp;<input type="text" class="swal_input_date" id="msg_datepicker2" autocomplete='off'>
                    </div>
                    <div class="swal_date_button swal_search_button" onclick="sendmsg_get_history(1,$('#msg_datepicker1').val(),$('#msg_datepicker2').val(),'')">검색</div>
                    <div class="swal_date_button datesearch_button swal_date_button_on" onclick="datesearch2('dday')">당일</div>
                    <div class="swal_date_button datesearch_button" onclick="datesearch2('dmon')">당월</div>
                    <div class="swal_date_button datesearch_button" onclick="datesearch2('ymon')">전월</div>
                </div>
                <div class="msg_history_top_search flex">
                    <div><input type="text" class="swal_top_search" onkeyup="enterkey2(this)"></div>
                    <div class="swal_date_button" onclick="sendmsg_get_history(1,$('#msg_datepicker1').val(),$('#msg_datepicker2').val(),$('.swal_top_search').val())">검색</div>
                </div>
                <div class="msg_history_top_data"></div>
            </div>
            <table style="width:100%;"><tr class="msg_history_paging"></tr></table>
            <table style="width:100%;">
                <thead>
                    <tr style="font-size:20px;">
                        <th style="text-align:center;">발송일시</th>
                        <th style="text-align:center;">수신자명</th>
                        <th style="text-align:center;">수신번호</th>
                        <th style="text-align:center;">내용</th>
                        <th style="text-align:center;">구분</th>
                        <th style="text-align:center;">상태</th>
                    </tr>
                </thead>
                <tbody class="msg_history_tbody">

                </tbody>
            </table>
            <br/>
            <div class="msg_content_view" style="display:none;">
                <div class="msg_content_top">
                    <div class="msg_content_date">2024년 01월 25일 10시 33분</div>
                    <div class="msg_content_name">박태욱(L0105873284)</div>
                    <div class="msg_content_phone">01028559735</div>
                    <div class="msg_content_type">친구톡(이미지)</div>
                    <div class="msg_content_state">전송성공</div>
                </div>
                <div class="msg_content_data">
                    당월급여제공 기록지
                </div>
                <div class="msg_content_bottom">
                    <div class="" onclick="msg_content_view_close();">닫기</div>
                </div>
            </div>
            `,
            confirmButtonText:"확인",
            didOpen:()=>{
                $("#msg_datepicker1,#msg_datepicker2").datepicker({
                    changeMonth: true,
                    changeYear: true
                });
                $("#msg_datepicker1,#msg_datepicker2").datepicker("option", "showAnim", "slide");
                datesearch2('dday');
                $('.datesearch_button').click(function(){
                    $(this).addClass('swal_date_button_on');
                    $('.datesearch_button').not($(this)).removeClass('swal_date_button_on');
                });

                $('.swal_search_button').click(function(){
                    $('.datesearch_button').removeClass('swal_date_button_on');
                });
                $('.swal2-actions, .swal2-popup').css({'z-index':0});

            }
        })
    }

    function filterdel(page,username,dates,datee,query,rentstatus,cmsstatus,contract,delivery,product,centername,manager,phone,bcode,chk){
        if(chk=='대여상태')rentstatus = '';
        if(chk=='CMS상태')cmsstatus = '';
        if(chk=='인쇄')printchk = '';
        if(chk=='계약상태')contract = '';
        if(chk=='품목명')product = '';
        if(chk=='배송상태')delivery = '';
        // if(chk=='배송방법')deliverycar = '';
        if(chk=='센터명')centername = '';
        if(chk=='바코드')bcode = '';
        if(chk=='연락처')phone = '';
        if(chk=='담당자')manager = '';
        rentlookup(1,uid,dates,datee,query,rentstatus,cmsstatus,contract,delivery,product,centername,manager,phone,bcode);
    }

    function detailsearch(){
        const { value: formValues } = Swal.fire({
        title: '상세검색',
        html:
            '<form class="detailsearch" action="//localhost:802/order/1/'+uid+'/2019-01-01/'+$('#datepicker2').val()+'" method="get" style="position:relative;">'+
            '<div class="flex"><span style="width:100px; font-weight:bold;">대여상태</span><select id="swal-input0" class="swal2-input" name="rentstatus"><option value="">전체</option><option value="y">대여중</option><option value="n">회수</option><option value="s">중지</option></select></div>'+
            '<div class="flex"><span style="width:100px; font-weight:bold;">CMS상태</span><select id="swal-input-cms" class="swal2-input" name="cmsstatus"><option value="">전체</option><option value="1">등록</option><option value="n">미등록</option><option value="0">중지</option></select></div>'+
            '<div class="flex"><span style="width:100px; font-weight:bold;">계약상태</span><select id="swal-input1" class="swal2-input" name="contract"><option value="">전체</option><option value="ok">계약완료</option><!--option value="vok">부분계약완료</option--><option value="cok">취소계약완료</option><option value="n">미계약</option></select></div>'+
            '<div class="flex"><span style="width:100px; font-weight:bold;">배송상태</span><select id="swal-input2" class="swal2-input" name="delivery"><option value="">전체</option><option value="end">배송완료</option><option value="wait">배송대기</option><option value="back">회수중</option><option value="backend">회수완료</option></select></div>'+
            // '<div class="flex"><span style="width:100px; font-weight:bold;">배송방법</span><select id="swal-input9" class="swal2-input" name="deliverycar"><option value="">전체</option><option value="not">직접전달</option><option value="basic">택배</option><option value="none">물류</option></select></div>'+
            // '<div class="flex"><span style="width:100px; font-weight:bold;">인쇄</span><select id="swal-input8" class="swal2-input" name="printchk"><option value="">선택</option><option value="pok">출력</option><option value="pno">미출력</option></select></div>'+
            '<div class="flex"><span style="width:100px; font-weight:bold;">품목명</span><input id="swal-input3" class="swal2-input" name="product" value=""></div>' +
            '<div class="flex"><span style="width:100px; font-weight:bold;">센터명</span><input id="swal-input4" class="swal2-input" name="centername" value="<%=centername%>"></div>' +
            '<div class="flex manager_search"><span style="width:100px; font-weight:bold;">담당자</span><input id="swal-input5" class="swal2-input" name="manager" value="<%=manager%>" readonly></div>' +
            '<div id="checkboxList" style="display: none; width:100%; position:relative;">'+
                '<div id="checkboxList2" style="display:flex; width:100%; flex-wrap:wrap;">'+
                '</div>'+
            '</div>'+
            '<div class="flex" style="position:absolute; background:#fff;"><span style="width:100px; font-weight:bold;" id="manageradd"></span></div>'+
            '<div class="flex"><span style="width:100px; font-weight:bold;">연락처</span><input id="swal-input6" class="swal2-input" name="phone" value="<%=phone%>"></div>'+
            '<div class="flex"><span style="width:100px; font-weight:bold;">바코드</span><input id="swal-input7" class="swal2-input" name="bcode" value="<%=bcode%>"></div>'+
            '</form>'
            
            ,
        focusConfirm: false,
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: '검색',
        cancelButtonText: '취소',
        didOpen: () => {
            if(member_target=="영업"){
                $(".manager_search").hide();
            }
            $('.swal2-input').eq(8).val(bcode);
            $('.swal2-input').eq(7).val(phone);
            $('.swal2-input').eq(6).val(manager);
            $('.swal2-input').eq(5).val(centername);
            $('.swal2-input').eq(4).val(product);
            // $('.swal2-input').eq(3).val(printchk).prop('selected',1);
            // $('.swal2-input').eq(2).val(deliverycar).prop('selected',1);
            $('.swal2-input').eq(3).val(delivery).prop('selected',1);
            $('.swal2-input').eq(2).val(contract).prop('selected',1);
            $('.swal2-input').eq(1).val(cmsstatus).prop('selected',1);
            $('.swal2-input').eq(0).val(rentstatus).prop('selected',1);
            
            $.each(managerarr,function(i){
                $('#checkboxList2').append('<label class="citem"><input type="checkbox" value="'+managerarr[i]+'"> '+managerarr[i]+'</label>');
            });

        

            const input = document.getElementById('swal-input5');
            const checkboxList = document.getElementById('checkboxList');
            const checkboxes = $('#checkboxList2').children('label').children('input');
            if(manager!=''){
                console.log(manager);
                const managerchkarr = manager.replace(/ /g,'').split(',');
                managerchkarr.pop();
                $.each(checkboxes,function(i){
                    console.log('managerchkarr',managerchkarr);
                    console.log('checkboxes[i].value',checkboxes[i].value);
                    if (managerchkarr.includes(checkboxes[i].value)) {
                        checkboxes.eq(i).prop('checked',1);
                    }
                });
                
            }
            input.addEventListener('click', function() {
                checkboxList.style.display = 'block';
                
            });

            document.addEventListener('click', function(event) {
            if (!input.contains(event.target) && !checkboxList.contains(event.target)) {
                checkboxList.style.display = 'none';
            }
            });

            for (let i = 0; i < checkboxes.length; i++) {
                checkboxes[i].addEventListener('click', function() {
                    if (this.checked) {
                        input.value += this.value + ',';
                    } else {
                        input.value = input.value.replace(this.value + ',', '');
                    }
                });
            }
            
        },
        }).then((result) => {
            if (result.isConfirmed) {
                rentlookup(1,uid,$('#datepicker').val(),$('#datepicker2').val(),'',$('#swal-input0').val(),$('#swal-input-cms').val(),$('#swal-input1').val(),$('#swal-input2').val(),$('#swal-input3').val(),$('#swal-input4').val(),$('#swal-input5').val(),$('#swal-input6').val(),$('#swal-input7').val(),$('#swal-input9').val());
            }
        });
        //$( '.searchdetail' ).toggle( 'slow' );
    }

    async function rentlookup(page,username,dates,datee,query,rrentstatus,ccmsstatus,ccontract,ddelivery,pproduct,ccentername,mmanager,pphone,bbcode){
        //socket.emit('login', {'name': uid});
        if(dates=='2020-01-01'){
            $('.clientupbtn').removeClass('don');
            $('.clientupbtn').addClass('doff');
        }
        
        $.ajax({
            url:"/rentlookup",
            data:"company="+company+'&page='+page+'&username='+username+'&dates='+dates+'&datee='+datee+'&query='+query+'&rentstatus='+rrentstatus+'&cmsstatus='+ccmsstatus+'&contract='+ccontract+'&delivery='+ddelivery+'&product='+pproduct+'&centername='+ccentername+'&manager='+mmanager+'&phone='+pphone+'&bcode='+bbcode.replace(/ /g,''),
            type:'POST',
            dataType:"JSON",
            async:true,
            success:function(results){
                console.log(results);
                $('.ordertr, .copydata, .orderpaging').remove();
                if(results){
                    var filterarr = [];
                    $('.filterarr').text('');
                    if(ccmsstatus){
                        var dd = '';
                        if(ccmsstatus=='1')dd = '등록';
                        else if(ccmsstatus=='n')dd = '미등록';
                        else if(ccmsstatus=='0')dd = '중지';
                        filterarr.push({'CMS상태':dd});
                    }
                    if(rrentstatus){
                        var dd = '';
                        if(rrentstatus=='y')dd = '대여중';
                        else if(rrentstatus=='n')dd = '회수';
                        else if(rrentstatus=='s')dd = '중지';
                        filterarr.push({'대여상태':dd});
                    }
                    if(ccontract){
                        var dd = '';
                        if(ccontract=='ok')dd = '계약완료';
                        else if(ccontract=='cok')dd = '취소계약완료';
                        else if(ccontract=='n')dd = '미계약';
                        filterarr.push({'계약상태':dd});
                    }
                    if(ddelivery){
                        var dd = '';
                        if(ddelivery=='end')dd = '배송완료';
                        else if(ddelivery=='wait')dd = '배송대기';
                        else if(ddelivery=='back')dd = '회수중';
                        else if(ddelivery=='backend')dd = '회수완료';
                        filterarr.push({'배송상태':dd});
                    }
                    // if(ddeliverycar){
                    //     var dd = '';
                    //     if(ddeliverycar=='basic')dd = '택배';
                    //     else if(ddeliverycar=='not')dd = '직접전달';
                    //     else if(ddeliverycar=='none')dd = '물류';
                    //     filterarr.push({'배송방법':dd});
                    // }
                    if(pproduct){
                        filterarr.push({'품목명':pproduct});
                    }
                    if(pphone){
                        filterarr.push({'연락처':pphone});
                    }
                    if(bbcode){
                        filterarr.push({'바코드':bbcode});
                    }
                    if(mmanager){
                        filterarr.push({'담당자':mmanager.slice(0, -1)});
                    }
                    if(ccentername){
                        filterarr.push({'센터명':ccentername});
                    }
                    
                    for(f of filterarr){
                        $('.filterarr').append('<div class="filtercls"><div class="fitems">'+Object.keys(f)+':'+f[Object.keys(f)]+'</div><div class="material-icons filter_close" style="color:#ff0000; cursor:pointer; font-weight:bold;" onclick="filterdel(\'1\',\''+uid+'\',\''+$('#datepicker').val()+'\',\''+$('#datepicker2').val()+'\',\''+results.query+'\',\''+rrentstatus+'\',\''+ccmsstatus+'\',\''+ccontract+'\',\''+ddelivery+'\',\''+pproduct+'\',\''+ccentername+'\',\''+mmanager+'\',\''+pphone+'\',\''+bbcode+'\',\''+Object.keys(f)+'\')">close</div></div>');
                    }

                    if(member_target=="영업"){
                        $(".filter_close").hide();
                    }else{
                        $(".filter_close").show();
                    }
                    
                    //socket.emit('vschk', {'name': uid,'msg':String(results.vschk)});
                    var otr = results.articles.contents;
                    var str = '';
                    var str2 ='';
                    var pstr ='';
                    var pclick1 = '';
                    var pclick2 = '';
                    var pclick3 = '';
                    var pclick4 = '';
                    var pnum = '';
                    var pnumclick = '';
                    var mpricetotal = 0;
                    var query = results.query;
                    rentstatus = results.rentstatus;
                    cmsstatus = results.cmsstatus;
                    contract = results.contract;
                    delivery = results.delivery;
                    product = results.product;
                    centername = results.centername;
                    manager = results.manager;
                    phone = results.phone;
                    bcode = results.bcode;
                    printchk = results.printchk;
                    // deliverycar = results.deliverycar;
                    console.log(otr);
                    if (otr.length != 0) {
                        $('.noment').remove();
                        if(results.articles.pageNum-10<1){
                            pclick1='disabled';
                        }else{
                            pclick1='waves-effect';
                        }
                        if(results.articles.pageNum==1){
                            pclick2='disabled';
                        }else{
                            pclick2='waves-effect';
                        }
                        if(results.articles.pageNum==results.articles.pnTotal){
                            pclick3='disabled';
                        }else{
                            pclick3='waves-effect';
                        }
                        if(results.articles.pageNum+10>results.articles.pnTotal){
                            pclick4='disabled';
                        }else{
                            pclick4='waves-effect';
                        }
                        for(var j=results.articles.pnStart; j<=results.articles.pnEnd; j++){
                            if(j===results.articles.pageNum){
                                pnumclick = 'active';
                            }else{
                                pnumclick = '';
                            }
                            pnum += '<li class="'+pnumclick+'"><a class="pnumlock" style="z-index:0;" >'+j+'</a></li>';
                        }
                        pstr =
                            '<td class="orderpaging" colspan="21">'+
                            '<div class="tablemenutop" style="text-align:center;">'+
                            '<div class="mobile"></div>'+
                            '<ul class="pagination">'+
                                '<li class="'+pclick1+'"><a onclick='+((results.articles.pageNum-10 >= 1) ?'rentlookup('+(results.articles.pageNum-10)+',"'+uid+'","'+$("#datepicker").val()+'","'+$("#datepicker2").val()+'",\"'+query+'\",\"'+rentstatus+'\",\"'+cmsstatus+'\",\"'+contract+'\",\"'+delivery+'\",\"'+product+'\",\"'+centername+'\",\"'+manager.replace(/ /g,'')+'\",\"'+phone+'\",\"'+bcode+'\")':'')+'><i class="material-icons">keyboard_double_arrow_left</i></a></li>'+
                                    '<li class="'+pclick2+'"><a onclick='+((results.articles.pageNum>1) ?'rentlookup('+(results.articles.pageNum-1)+',"'+uid+'","'+$("#datepicker").val()+'","'+$("#datepicker2").val()+'",\"'+query+'\",\"'+rentstatus+'\",\"'+cmsstatus+'\",\"'+contract+'\",\"'+delivery+'\",\"'+product+'\",\"'+centername+'\",\"'+manager.replace(/ /g,'')+'\",\"'+phone+'\",\"'+bcode+'\")':'')+'><i class="material-icons">chevron_left</i></a></li>'+
                                        pnum+
                                    '<li class="'+pclick3+'"><a class="waves-effect" onclick='+((results.articles.pageNum<results.articles.pnTotal) ?'rentlookup('+(results.articles.pageNum+1)+',"'+uid+'","'+$("#datepicker").val()+'","'+$("#datepicker2").val()+'",\"'+query+'\",\"'+rentstatus+'\",\"'+cmsstatus+'\",\"'+contract+'\",\"'+delivery+'\",\"'+product+'\",\"'+centername+'\",\"'+manager.replace(/ /g,'')+'\",\"'+phone+'\",\"'+bcode+'\")':'')+'><i class="material-icons">chevron_right</i></a></li>'+
                                '<li class="'+pclick4+'"><a class="waves-effect" onclick='+((results.articles.pageNum+10 <= results.articles.pnTotal) ?'rentlookup('+(results.articles.pageNum+10)+',"'+uid+'","'+$("#datepicker").val()+'","'+$("#datepicker2").val()+'",\"'+query+'\",\"'+rentstatus+'\",\"'+cmsstatus+'\",\"'+contract+'\",\"'+delivery+'\",\"'+product+'\",\"'+centername+'\",\"'+manager.replace(/ /g,'')+'\",\"'+phone+'\",\"'+bcode+'\")':'')+'><i class="material-icons">keyboard_double_arrow_right</i></a></li>'+
                                '</ul><div class="topmenuright mobile"></div>'+
                            '</div>'+
                            '</td>'
                    }
                    $.each(otr,function(i){
                        mpricetotal+=parseInt(otr['SUM(money)']);
                        
                        var productcode = '';
                        var productcoderesult1 = [];
                        var productcoderesult2 = [];
                        if (otr.length != 0) {
                            productcoderesult1 = [];
                            productcoderesult2 = [];
                            productcode = otr[i].productname.replace(/((블루,레드)|(네이비,베이지))/g,'').replace(/\(오션블루, 버건디\)/g,'').split(',');
                            
                            productcode = productcode.filter(function (el) {
                                return el != "";
                            });
                            for(var j = 0; j< productcode.length; j++){
                                productcodesplit = productcode[j].split('|');
                                productcoderesult1.push(productcodesplit[0]);
                                productcoderesult2.push(productcodesplit[1]);
                            }
                        }

                        var producttext = '';
                        if(productcoderesult2.length!=1){
                            producttext = "외"+(productcoderesult2.length-1)+"개";
                        }else{
                            producttext = '';
                        }
                        var t = '';
                        if(otr[i].status == "back" || otr[i].status == "backend"){
                            t = '-';
                        }

                        var status = '';
                        let status_color = 'bg-success';
                        if(otr[i].status == "end"){
                            status = '배송완료'; 
                            status_color = 'bg-success'; 
                        }else if(otr[i].status == "wait"){
                            status = '배송대기'; 
                            status_color = 'bg-success'; 
                        }else if(otr[i].status == "back"){ 
                            status = '회수중'; 
                            status_color = 'bg-danger';
                        }else if(otr[i].status == "backend"){
                            status = '회수완료';
                            status_color = 'bg-danger';
                        }
                        var gongchk = 'close';
                        var color = 'red';
                        if(otr[i].chk=='ok') {gongchk = 'check'; color = 'green'; } else if(otr[i].chk=='n') {gongchk = 'close'; color = 'red';} else if(otr[i].chk=='cok') { gongchk = 'change_history'; color = 'green'; } else if(otr[i].chk=='vok') { gongchk = 'star'; color = 'orange'; }
                        if(otr[i].buybcode.split('|')[0]=='비급여') {gongchk = '-'; color = '#000'; }
                        var brchk = '대여'+((otr[i].rental!='')?'</br>('+otr[i].rental+')':'');
                        var releasetxt = otr[i].guardname;
                        var deliverytxt = '';
                        if(otr[i].deliverymanager=='not'){
                            deliverytxt = '직접전달';
                        }else if(otr[i].deliverymanager=='basic'){
                            deliverytxt = '택배';
                        }else if(otr[i].deliverymanager=='none'){
                            deliverytxt = '물류';
                        }
                        let rstatus = '';
                        let bgcolor = 'bg-success';
                        if(otr[i].rentchk == "y"){ 
                            rstatus = '대여중';
                            bgcolor = 'bg-success'; 
                        }else if(otr[i].rentchk == "n"){
                            rstatus = '회수'; 
                            bgcolor = 'bg-danger';
                        }else if(otr[i].rentchk == "s"){
                            rstatus = '중지'; 
                            bgcolor = 'bg-warning';
                        }
                        let cmschk = '';
                        let cms_color = '';
                        for(var j=0; j<results.cmstable.length; j++){
                            if(otr[i].number==results.cmstable[j].number){
                                if(otr[i].cmschk==1){
                                    cmschk = '등록';
                                    cms_color = 'bg-success';
                                }else if(otr[i].cmschk==0){
                                    cmschk = '중지';
                                    cms_color = 'bg-warning';
                                }
                                
                            }
                        }

                        str += 
                            '<tr class="ordertr center borderblack table-bordered tr'+otr[i].num+'" style="display:none;">'+
                            '<td class="chkbox mobile"><input type="hidden" class="listcheckbox listcheckbox2" name="chk" placeholder="X" value="'+i+'"></td>'+
                            '<td>'+otr[i].orderdate.split(' ')[0]+'</td>'+
                            `<td>${otr[i].name}${company=="주안애복지용구"?'<br/>('+otr[i].cnum+')':''}</td>`+
                            '<td>'+otr[i].number+'</td>'+
                            // '<td class="mobile">'+otr[i].regident+'</td>'+
                            '<td class="mobile">'+otr[i].target+'</td>'+
                            '<!--td class="mobile">'+otr[i].ranker+'</td>'+
                            '<td class="mobile">'+otr[i].sale+'</td-->'+
                            '<td class="productcode">'+productcoderesult2[0]+ producttext +'<input type="hidden" value="'+productcoderesult1+'"></td>'+
                            '<td class="">'+otr[i].rentstart+'</td>'+
                            '<td class="">'+otr[i].rentend+'</td>'+
                            '<td class="deliverytxt mobile" style="width:150px;">'+((otr[i].address=='undefined undefined')?'미입력':otr[i].address)+'</td>'+
                            '<td class="mobile">'+((releasetxt=='')?'본인':releasetxt)+'</td>'+
                            // '<td class="mobile">'+brchk+'</td>'+
                            // '<td class="mobile">'+otr[i].phone1+'</td>'+
                            '<td class="mobile">'+((otr[i].center!='')?otr[i].center:'개인')+'</td>'+
                            '<td class="mobile">'+otr[i].manager+'</td>'+
                            '<td class="mobile '+cms_color+'">'+cmschk+'</td>'+
                            '<td class="memotxt mobile"></td>'+
                            '<td class="'+bgcolor+'">'+rstatus+'</td>'+
                            '<td class="mobile '+status_color+'">'+status+'</td>'+
                            '<td class="sign"><span class="material-icons '+color+'" style="font-size:30px;">'+gongchk+'</span><span class="material-icons" style="display:none; font-size:30px; color:#00923d;">check</span></td>'+
                            '</tr>'
                    });

                    //document.addEventListener("DOMContentLoaded", function() {

                    //});
                    
                    $('.renttable').append(str);
                    $('.mprice').html(mpricetotal);
                    $('.ordertr').fadeIn();
                    // cmtview().then(mres=>{
                    //     $(".memotxt").each(function(){
                    //         var length = 20; //표시할 글자수 정하기
                    //         $(this).each(function(){
                    //             if( $(this).text().length >= length ){
                    //                 $(this).text( $(this).text().substr(0,length)+'...') 
                    //                 //지정할 글자수 이후 표시할 텍스트
                    //             }
                    //         });
                    //     });
                    // });
                    
                    const boxTit = Array.from(document.querySelectorAll('.deliverytxt'));  
                    const box = [];
                    const textSlice = function(tits, lengths){
                        tits.forEach((el, idx) => {
                            const tix = el.textContent;
                            const memberPart = tix.slice(0, lengths);
                            const t = memberPart.concat('...');
                            box.push(t);

                            tits[idx].innerHTML = box[idx];
                        });
                    };
                    textSlice(boxTit, 20);
                    
                    var tr_length = $('.table tr td').length;
                    var tab_td = $('.table tr td');//tb 테이블의 td들 불러오기
                    
                    $(tab_td).click(async function(){
                        if(($(this).parent().hasClass('tablemenu')!=1&&$(this).hasClass('chkbox')!=true&&$(this).hasClass('copyclip')!=true)){
                            //window.frames['clientmodify'].location.href("//localhost:802/ordermodify/1/<%=username%>/"+$(this).parent().children('td:eq(3)').text()+"/"+$(this).parent().prev().val());
                            var targeted_popup_class = $('[data-popup-open2]').attr('data-popup-open2');
                            $('[data-popup="' + targeted_popup_class + '"]').fadeIn(350);
                            var releasen = $(this).parents('tr').children('td').children('.releasenumber').val();
                            var releasec = $(this).parents('tr').children('td').children('.releasecompany').val();
                            var uid2 = uid;
                            
                            if(releasen!=''&&releasec==company){
                                if(uid.includes('(')){
                                    if(uid.split('(')[1].replace(')','')==releasen){
                                        uid2 = uid;
                                    }else{
                                        uid2 = uid.split('(')[0];
                                    }
                                }else{
                                    uid2 = uid+'('+releasen+')';
                                }
                            }
                            
                            $('.clientmodify').attr('src',"//localhost:802/rentmodify/1/"+uid2+"/"+$(this).parent().children('td:eq(3)').text()+"/"+$(this).parent().prev().val());
                            window.frames['clientmodify'].src="//localhost:802/rentmodify/1/"+uid2+"/"+$(this).parent().children('td:eq(3)').text()+"/"+$(this).parent().prev().val();
                            window.frames['clientmodify'].onload = function() {
                                $('.clientmodify').contents().find('.reloading').css({'display':'none'});
                            }
                            // $('.clientmodify').load(function(){
                            //     $('.clientmodify').contents().find('.reloading').css({'display':'none'});
                            //     alert('aa');
                            // });
                            //document.getElementById('clientmodify').onload = await function() {
                                //$('[data-popup="' + targeted_popup_class + '"]').fadeIn(350);
                            window.frames['clientmodify'].focus();
                            //}
                            
                            //e.preventDefault();
                        }
                    });
                            
                    $(tab_td).hover(function(){
                        if($(this).parent().hasClass('tablemenu')!=1)$(this).parent().css({'border':'2px solid #000000',"cursor":"pointer","opacity":"0.5"});
                    }, function() {
                        if($(this).parent().hasClass('tablemenu')!=1)$(this).parent().css({'border':'1px solid #bebebe',"opacity":"1"});
                    });
                    for (var i = 0; i < tr_length; i++) {
                        var td2 = tab_td.eq(i);
                    }
                    $.each(otr,function(i){
                        str2 = '<input class="copydata bcodecopy" type="hidden" value="'+otr[i].buybcode+'"><input class="copydata pcodecopy" type="hidden" value="'+otr[i].product+'"><input class="copydata requestmemocopy" type="hidden" value="'+otr[i].reqeustmemo+'"><input class="copydata addresscopy" type="hidden" value="'+otr[i].address2+' ['+otr[i].addressdetail+']"><input class="copydata listnum" type="hidden" value="'+otr[i].num+'">';
                        $('.tr'+otr[i].num).before(str2);
                    });
                    //$('.ordertr').remove();             
                }
                
                $('.search-bar').val('');
                $('#datepicker').val(dates);
                $('#datepicker2').val(datee);
                $('.orderpagingtr').append(pstr);
                if(Mobile()==true){
                    $('.mobile').css("display","none");
                    $('.pc').css("display","");
                }else{
                    $('.pc').css("display","none");
                    $('.mobile').css("display","");
                }
                setTimeout(function() {
                    $('.pnumlock').on('click',async function(){
                        await rentlookup($(this).text(),uid,dates,datee,query,rentstatus,cmsstatus,contract,delivery,product,centername,manager,phone,bcode);
                        //$(this).parent().addClass("disabled");
                    });
                },300);
                setTimeout(function() {
                    var buttons = document.getElementsByClassName("btnlock");
                    Array.from(buttons).forEach(function(button) {
                        button.addEventListener("click", function() {
                            button.disabled = true;
                            setTimeout(function() {
                            button.disabled = false;
                            }, 500);
                        });
                    });
                }, 1000);
            }
        });
    }

    function enterkey(x) {
        if (window.event.keyCode == 13) {
            //orderlookup(1,uid,'2020-01-01',chan_val,$(x).val(),'','','','','','','','');
            rentlookup(1,uid,"1999-01-01","2029-01-01",$(x).val(),rentstatus,cmsstatus,contract,delivery,product,centername,manager,phone,bcode);
        }
    }

    function clean_history_get_btn(x){
        clean_history_get($(x).val()).then(res=>{
            $('.clean_history_tr').remove();
            let str = '';
            res.data.forEach(function(obj,index){
                let pname2 = '';
                for (var j = 0; j < productlistarr.length; j++) {
                    var currentString = productlistarr[j];
                    if (currentString.includes(obj.pcode)) {
                        pname2=currentString.split("|")[0];
                        break
                    }
                }
                if(obj.date==''||obj.date==null){
                    clean_data = '소독일자 미입력';
                }else{
                    clean_data = obj.date;
                }
                if(obj.cnum==''){
                    clean_cnum = '소독필증 미입력';
                }else if(obj.cnum=='자동생성'){
                    clean_cnum = "신규품목";
                }else{
                    clean_cnum = obj.cnum;
                }

                if(obj.meditxt==''||obj.meditxt==null){
                    meditxt = '미입력';
                }else{
                    meditxt = obj.meditxt;
                }

                if(obj.mediname==''||obj.mediname==null){
                    mediname = '미입력';
                }else{
                    mediname = obj.mediname;
                }

                if(obj.size==''||obj.size==null){
                    medisize = '미입력';
                }else{
                    medisize = obj.size;
                }

                if(obj.companynumber==''){
                    clean_companynumber = '사업자등록번호 미입력';
                }else{
                    clean_companynumber = obj.companynumber;
                }
                
                if($('.clean_history_btn_on').hasClass('data_4')){
                    if(clean_cnum!='신규품목'){
                        str += `<tr class="clean_history_tr"><td>${index+1}</td><td>${clean_data}</td><td>${pname2}</td><td>${obj.pcode}-<br/>${obj.bcode}</td><td>${meditxt}</td><td>${mediname}</td><td>${medisize}</td><td><%=company%></td><td>${companynumber}</td><td>${clean_cnum}</td></tr>`;
                    }
                }else{
                    if(obj.company==obj.companyname){
                    str += `<tr class="clean_history_tr"><td>${index+1}</td><td>${pname2}</td><td>${obj.pcode}-<br/>${obj.bcode}</td><td>${obj.cnum.split(' ')[0].replace(/[^0-9]/g,'')}</td><td>${obj.meditxt}</td><td>${obj.mediname}</td><td>${obj.size}</td><td></td><td></td><td></td><td></td></tr>`;
                }else{
                    if(clean_cnum!='신규품목'){
                        str += `<tr class="clean_history_tr"><td>${index+1}</td><td>${pname2}</td><td>${obj.pcode}-<br/>${obj.bcode}</td><td>${clean_data}</td><td></td><td></td><td></td><td></td><td>${obj.companyname}</td><td>${obj.companynumber}</td><td>${clean_cnum}</td></tr>`;
                    }
                }
                }

                
            });
            $('.clean_history_manager').before(str);
        });
    }

    function enterkey3(x){
        if (window.event.keyCode == 13) {
            console.log(x);
            clean_history_get($(x).val()).then(res=>{
                $('.clean_history_tr').remove();
                let str = '';
                res.data.forEach(function(obj,index){
                    let pname2 = '';
                    for (var j = 0; j < productlistarr.length; j++) {
                        var currentString = productlistarr[j];
                        if (currentString.includes(obj.pcode)) {
                            pname2=currentString.split("|")[0];
                            break
                        }
                    }
                    if(obj.company==obj.companyname){
                        str += `<tr class="clean_history_tr"><td>${index+1}</td><td>${pname2}</td><td>${obj.pcode}-<br/>${obj.bcode}</td><td>${obj.cnum.split(' ')[0].replace(/[^0-9]/g,'')}</td><td>${obj.meditxt}</td><td>${obj.mediname}</td><td>${obj.size}</td><td></td><td></td><td></td><td></td></tr>`;
                    }else{
                        str += `<tr class="clean_history_tr"><td>${index+1}</td><td>${pname2}</td><td>${obj.pcode}-<br/>${obj.bcode}</td><td></td><td></td><td></td><td></td><td></td><td>${obj.companyname}</td><td>${obj.companynumber}</td><td>${obj.cnum}</td></tr>`;
                    }
                });
                $('.clean_history_manager').before(str);
            });
        }
    }

    $(document).ready(function () {
        //socket_start();
        if(Mobile()==true){
            $('.mobile').css("display","none");
            $('.pc').css("display","");
        }else{
            $('.pc').css("display","none");
            $('.mobile').css("display","");
        }
        $.datepicker.setDefaults({
            dateFormat: 'yy-mm-dd',
            prevText: '이전 달',
            nextText: '다음 달',
            monthNames: ['1월', '2월', '3월', '4월', '5월', '6월', '7월', '8월', '9월', '10월', '11월', '12월'],
            monthNamesShort: ['1월', '2월', '3월', '4월', '5월', '6월', '7월', '8월', '9월', '10월', '11월', '12월'],
            dayNames: ['일', '월', '화', '수', '목', '금', '토'],
            dayNamesShort: ['일', '월', '화', '수', '목', '금', '토'],
            dayNamesMin: ['일', '월', '화', '수', '목', '금', '토'],
            showMonthAfterYear: true,
            yearSuffix: '년'
        });
        $( "#datepicker,#datepicker2,#datepicker3,#datepicker4" ).datepicker({
            changeMonth: true,
            changeYear: true
        });
        $( "#datepicker,#datepicker2,#datepicker3,#datepicker4" ).datepicker( "option", "showAnim", "slide" );
        $(function() {
            var tr_length = $('.table tr td').length;
            var tab_td = $('.table tr td');//tb 테이블의 td들 불러오기
            for (var i = 0; i < tr_length; i++) {
                    var td2 = tab_td.eq(i).text();
                    /*
                    if(td2=="일반") $(".table tr td:eq("+i+")").parent().addClass('success');
                    if(td2=="의료급여") $(".table tr td:eq("+i+")").parent().addClass('info');
                    if(td2=="감경") $(".table tr td:eq("+i+")").parent().addClass('warning');
                    if(td2=="기초") $(".table tr td:eq("+i+")").parent().addClass('danger');
                    */
                
            }
            var tr_length = $('.table tr td').length;
            var tab_td = $('.table tr td');//tb 테이블의 td들 불러오기
            
            $(tab_td).click(function(){
                        if($(this).parent().hasClass('tablemenu')!=1){
                            window.frames['clientmodify'].location.reload();
                            $('.clientmodify').attr('src',"//localhost:802/rentmodify/1/<%=username%>/"+$(this).parent().children('td:eq(3)').text()+"/"+$(this).parent().prev().val());
                            window.frames['clientmodify'].src="//localhost:802/rentmodify/1/<%=username%>/"+$(this).parent().children('td:eq(3)').text()+"/"+$(this).parent().prev().val();
                            var targeted_popup_class = $('[data-popup-open2]').attr('data-popup-open2');
                            $('[data-popup="' + targeted_popup_class + '"]').fadeIn(350);
                            //e.preventDefault();
                        }
                    });
                    
            $(tab_td).hover(function(){
                if($(this).parent().hasClass('tablemenu')!=1)$(this).parent().css({'border':'2px solid #000000',"cursor":"pointer","opacity":"0.5"});
                    }, function() {
                if($(this).parent().hasClass('tablemenu')!=1)$(this).parent().css({'border':'1px solid #bebebe',"opacity":"1"});
                });
            for (var i = 0; i < tr_length; i++) {
                var td2 = tab_td.eq(i);
            }
        });
        $(".table").hide();
        $(".table").fadeIn(500);
        var pagen='<%=page%>';
        $(".pagingnum").eq(pagen-1).css("background","#000000");

        /*
        $(".clientup span").click(function(){
            window.frames['clientup'].location.reload();
            var targeted_popup_class = $('[data-popup-open]').attr('data-popup-open');
            $('[data-popup="' + targeted_popup_class + '"]').fadeIn(350);
        });
        */

        $(function() {
            //----- OPEN
            $('[data-popup-open]').on('click', function(e) {
                var targeted_popup_class = jQuery(this).attr('data-popup-open');
                $('[data-popup="' + targeted_popup_class + '"]').fadeIn(350);

                e.preventDefault();
            });

            //----- CLOSE
            $('[data-popup-close]').on('click', function(e) {
                var targeted_popup_class = jQuery(this).attr('data-popup-close');
                $('[data-popup="' + targeted_popup_class + '"]').fadeOut(350);

                e.preventDefault();
            });
        });

        var states = "<%=states%>";
        var pname = "<%=pname%>";

        // $( '.search-detail-button' ).click( function() {
        //     const { value: formValues } = Swal.fire({
        //         title: '상세검색',
        //         html:
        //             '<form id="detailsearch" class="detailsearch" action="//localhost:802/rentlookup/1/'+uid+'/1999-01-01/'+chan_val+'" method="get">'+
        //                 '<div class="flex"><span style="width:100px; font-weight:bold;">계약상태</span><select id="swal-input6" class="swal2-input" name="contract"><option value="">전체</option><option value="ok">계약완료</option><option value="cok">취소계약완료</option><option value="n">미계약</option></select></div>'+
        //                 '<div class="flex"><span style="width:100px; font-weight:bold;">대여상태</span><select id="swal-input" class="swal2-input" name="states" form="detailsearch"><option value="" selected>전체</option><option value="y">대여중</option><option value="s">대여중지</option><option value="n">회수</option></select></div>'+
        //                 '<div class="flex"><span style="width:100px; font-weight:bold;">품목</span><select id="swal-input0" class="swal2-input" name="pname" form="detailsearch"><option value="" selected>전체</option><option>전동침대</option><option>휠체어</option><option>욕창예방 매트리스</option><option>이동욕조</option><option>배회감지기</option><option>경사로</option></select></div>' +
        //                 '<div class="flex"><span style="width:100px; font-weight:bold;">품목명</span><input id="swal-input1" class="swal2-input" name="product" value="<%=product%>"></div>' +
        //                 '<div class="flex"><span style="width:100px; font-weight:bold;">센터명</span><input id="swal-input2" class="swal2-input" name="centername" value="<%=centername%>"></div>' +
        //                 '<div class="flex"><span style="width:100px; font-weight:bold;">담당자</span><input id="swal-input3" class="swal2-input" name="manager" value="<%=manager%>"></div>' +
        //                 '<div class="flex"><span style="width:100px; font-weight:bold;">연락처</span><input id="swal-input4" class="swal2-input" name="phone" value="<%=phone%>"></div>'+
        //                 '<div class="flex"><span style="width:100px; font-weight:bold;">바코드</span><input id="swal-input5" class="swal2-input" name="bcode" value="<%=bcode%>"></div>'+
        //                 '</form>',
        //         focusConfirm: false,
        //         showCancelButton: true,
        //         confirmButtonColor: '#3085d6',
        //         cancelButtonColor: '#d33',
        //         confirmButtonText: '검색',
        //         cancelButtonText: '취소',
        //         didOpen: () => {
        //             $('.swal2-input').eq(0).val(contract).prop('selected',1);
        //             $('.swal2-input').eq(1).val(states).prop('selected',1);
        //             $('.swal2-input').eq(2).val(pname).prop('selected',1);
        //         },
        //     }).then((result) => {
        //         if (result.isConfirmed) {
        //             $('.detailsearch').submit();
        //         }
        //     });
        //     //$( '.searchdetail' ).toggle( 'slow' );
        // });

        $( '.searchdetail' ).hide();
        $('.date1').val('<%=datetarget%>');
        $('.date2').val('<%=datetargete%>');
        $(".search-form").attr("action", "//localhost:802/rentlookup/1/"+uid+"/2022-01-01/"+chan_val);
        let lastDate = new Date(dateInputd(0,0).split('-')[0], dateInputm(0,0).split('-')[1], 0);
        var rentmoneycal = lastDate.getDate()    
        var startdt = dateInputd(0,0).split('-')[0]+'-'+dateInputm(0,0).split('-')[1]+'-01';
        //var enddt = dateInputd(0,0).split('-')[0]+'-'+dateInputm(0,0).split('-')[1]+'-'+rentmoneycal;
        var enddt = chan_val;
        if(member_target=="영업"){
            rentlookup(1,uid,$('#datepicker').val(),$('#datepicker2').val(),'',rentstatus,cmsstatus,contract,delivery,product,centername,"<%=membername%>,",phone,bcode);
        }else{
            rentlookup(1,uid,$('#datepicker').val(),$('#datepicker2').val(),'',rentstatus,cmsstatus,contract,delivery,product,centername,manager,phone,bcode);
        }
    });

    async function clean_history_get(search){
        
        return axios({
            method:'post',
            url:'/cleanhistoryget',
            data:{
                company:'<%=company%>',
                search:search,
            }
        }).then(res=>{
            const data = res.data;
            if(data.code==200){
                console.log(data);
                return data;
            }else{

            }
        });
    }

    function s2ab(s) {
        var buf = new ArrayBuffer(s.length); //convert s to arrayBuffer
        var view = new Uint8Array(buf);  //create uint8array as viewer
        for (var i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xFF; //convert to octet
        return buf;
    }
    function exportExcel() {
        // step 1. workbook 생성
        var wb = XLSX.utils.book_new();

        // step 2. 시트 만들기 
        var newWorksheet = excelHandler.getWorksheet();

        // step 3. workbook에 새로만든 워크시트에 이름을 주고 붙인다.  
        XLSX.utils.book_append_sheet(wb, newWorksheet, excelHandler.getSheetName());

        // step 4. 엑셀 파일 만들기 
        var wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'binary' });

        // step 5. 엑셀 파일 내보내기 
        saveAs(new Blob([s2ab(wbout)], { type: "application/octet-stream" }), excelHandler.getExcelFileName());
    }

    var excelHandler = {
        getExcelFileName: function () {
            return '<%=company%> 소독관리.xlsx';
        },
        getSheetName: function () {
            return 'Sheet';
        },
        getExcelData: function () {
            return document.getElementById('excelbody');
        },
        getWorksheet: function () {
            return XLSX.utils.table_to_sheet(this.getExcelData());
        }
    }

    function exelchange(){
        exportExcel();
    }

    let clean_company_search = [];
    async function clean_manager_get(company){
        let company_target = company;
        console.log(clean_company_search);
        clean_company_search.forEach(function(obj,index){
            if(Object.keys(obj).includes('rental')){
                
                if(obj.rental[0].rentalcompany==company){
                    company = obj;
                    company_target = 'same';
                }
            }else if(Object.keys(obj).includes('clean')){
                if(obj.rental[0].cleancompany==company){
                    company = obj;
                    company_target = 'same';
                }
            }
        });
        
        if(company_target=='same'){
            console.log("same")
            return company
        }else if(company_target!=''){
            return axios({
                method:'post',
                url:'/cleanmanagerget',
                data:{
                    company:"<%=company%>",
                    rentalcompany:company_target
                }
            }).then(res=>{
                const data = res.data;
                if(data.code==201){
                    clean_company_search.push({code:201,rental:data.rental[0].rentalcompany});
                    return data
                }else if(data.code==202){
                    clean_company_search.push({code:202,clean:data.clean[0].cleancompany});
                    return data
                }else if(data.code==200){
                    clean_company_search.push({code:200})
                }
            });
        }else{
            return {code:400}
        }
        
    }

    function row_delete(x){
        console.log($('.clean_history_tr').index($(x).parents('tr')))
        if($('.clean_history_tbody').children('tr').length>1){
            if($('.clean_history_btn_on').hasClass("data_2")){
                clean_history_car_del($('.clean_history_tr').index($(x).parents('tr')));
            }else if($('.clean_history_btn_on').hasClass("data_3")){
                clean_history_medi_del($('.clean_history_tr').index($(x).parents('tr')));
            }
            const newArray = change_arr.filter(value => value !== 1);

            // 원본 배열을 업데이트
            change_arr.length = 0;
            change_arr.push(...newArray);

            console.log(change_arr);
            $(x).parents('tr').remove();
            $('.clean_history_tr').each(function(i){
                $(this).children('td').eq(0).text(i+1);
            });
        }
        
    }

    let str1 = `
        <div class="flex clean_search_area clean_history_data">
            <div class="clean_search_option">
                <div class="clean_search_option_btn option_on" onclick="option_click(this);" data-key="0">바코드 검색</div>
            </div>
            <br/>
            <div><input type="text" class="clean_search_input" placeholer="바코드 검색" onkeyup="enterkey3(this)"></div>
            &nbsp;&nbsp;<div><div class="clean_search_btn flex" style="width:80px;" onclick="clean_history_get_btn($('.clean_search_input'))">검색</div></div>
        </div>
        <table class="tg excelbody clean_history_data" id="excelbody">
            <thead>
                <tr>
                    <th class="tg-0pky" rowspan="2">일련번호</th>
                    <th class="tg-0pky" rowspan="2">품목명(제품명)</th>
                    <th class="tg-0pky" rowspan="2">제품코드/바코드</th>
                    <th class="tg-0pky" rowspan="2">소독일자</th>
                    <th class="tg-0pky" colspan="4">소독내용(자체소독)</th>
                    <th class="tg-0pky" colspan="3">위탁내용</th>
                </tr>
                <tr>
                    <th class="tg-0pky">소독의 종류</th>
                    <th class="tg-0pky">사용 약품명</th>
                    <th class="tg-0pky">사용량</th>
                    <th class="tg-0pky">소독작업원성명</th>
                    <th class="tg-0pky">소독업체명</th>
                    <th class="tg-0pky">사업자등록번호</th>
                    <th class="tg-0pky">소독필증교부번호</th>
                </tr>
            </thead>
            <tbody class="clean_history_tbody">
            
                
                <tr class="clean_history_manager">
                    <!--td class="tg-0pky" colspan="2" rowspan="4">소독원 기록</td>
                    <td class="tg-0pky">작업일자</td>
                    <td class="tg-0pky" colspan="2">작업시간</td>
                    <td class="tg-0pky" colspan="2">성명</td>
                    <td class="tg-0pky"></td>
                    <td class="tg-0pky" colspan="2">전화번호</td>
                    <td class="tg-0pky">서명</td>
                </tr>
                <tr>
                    <td class="tg-0pky">2011.1.4</td>
                    <td class="tg-0pky">09:00~10:30</td>
                    <td class="tg-0pky"></td>
                    <td class="tg-0pky" colspan="2">이영순</td>
                    <td class="tg-0pky"></td>
                    <td class="tg-0pky" colspan="2">000-000-0000</td>
                    <td class="tg-0pky">이영순</td>
                </tr>
                <tr>
                    <td class="tg-0pky"></td>
                    <td class="tg-0pky"></td>
                    <td class="tg-0pky"></td>
                    <td class="tg-0pky" colspan="2"></td>
                    <td class="tg-0pky"></td>
                    <td class="tg-0pky" colspan="2"></td>
                    <td class="tg-0pky"></td>
                </tr>
                <tr>
                    <td class="tg-0pky"></td>
                    <td class="tg-0pky"></td>
                    <td class="tg-0pky"></td>
                    <td class="tg-0pky" colspan="2"></td>
                    <td class="tg-0pky"></td>
                    <td class="tg-0pky" colspan="2"></td>
                    <td class="tg-0pky"></td-->
                </tr>
            </tbody>
        </table>
        `;

    let str4 = `
        <div class="flex clean_search_area clean_history_data">
            <div class="clean_search_option">
                <div class="clean_search_option_btn option_on" onclick="option_click(this);" data-key="0">바코드 검색</div>
            </div>
            <br/>
            <div><input type="text" class="clean_search_input" placeholer="바코드 검색" onkeyup="enterkey3(this)"></div>
            &nbsp;&nbsp;<div><div class="clean_search_btn flex" style="width:80px;" onclick="clean_history_get_btn($('.clean_search_input'))">검색</div></div>
        </div>
        <table class="tg excelbody clean_history_data" id="excelbody">
            <thead>
                <tr>
                    <th class="tg-0pky" rowspan="2">일련번호</th>
                    <th class="tg-0pky" rowspan="2">소독일자</th>
                    
                    <th class="tg-0pky" colspan="2">소독대상</th>
                    <th class="tg-0pky" colspan="3">소독실시내용</th>
                    <th class="tg-0pky" rowspan="2">위탁요청업체명</th>
                    <th class="tg-0pky" rowspan="2">장기요양기관기호</th>
                    <th class="tg-0pky" rowspan="2">소독필증교부번호</th>
                </tr>
                <tr>
                    <th class="tg-0pky">품목명(제품명)</th>
                    <th class="tg-0pky">제품코드/바코드</th>
                    <th class="tg-0pky">소독의 종류</th>
                    <th class="tg-0pky">사용 약품명</th>
                    <th class="tg-0pky">사용량</th>
                    
                </tr>
            </thead>
            <tbody class="clean_history_tbody">
            
                
                <tr class="clean_history_manager">
                    <!--td class="tg-0pky" colspan="2" rowspan="4">소독원 기록</td>
                    <td class="tg-0pky">작업일자</td>
                    <td class="tg-0pky" colspan="2">작업시간</td>
                    <td class="tg-0pky" colspan="2">성명</td>
                    <td class="tg-0pky"></td>
                    <td class="tg-0pky" colspan="2">전화번호</td>
                    <td class="tg-0pky">서명</td>
                </tr>
                <tr>
                    <td class="tg-0pky">2011.1.4</td>
                    <td class="tg-0pky">09:00~10:30</td>
                    <td class="tg-0pky"></td>
                    <td class="tg-0pky" colspan="2">이영순</td>
                    <td class="tg-0pky"></td>
                    <td class="tg-0pky" colspan="2">000-000-0000</td>
                    <td class="tg-0pky">이영순</td>
                </tr>
                <tr>
                    <td class="tg-0pky"></td>
                    <td class="tg-0pky"></td>
                    <td class="tg-0pky"></td>
                    <td class="tg-0pky" colspan="2"></td>
                    <td class="tg-0pky"></td>
                    <td class="tg-0pky" colspan="2"></td>
                    <td class="tg-0pky"></td>
                </tr>
                <tr>
                    <td class="tg-0pky"></td>
                    <td class="tg-0pky"></td>
                    <td class="tg-0pky"></td>
                    <td class="tg-0pky" colspan="2"></td>
                    <td class="tg-0pky"></td>
                    <td class="tg-0pky" colspan="2"></td>
                    <td class="tg-0pky"></td-->
                </tr>
            </tbody>
        </table>
        `;

    let str2 = `
        <table class="tg excelbody clean_history_data" id="excelbody">
            <thead>
                <tr>
                    <th class="tg-0pky" rowspan="2">일련번호</th>
                    <th class="tg-0pky" rowspan="2">소독일자</th>
                    <th class="tg-0pky" rowspan="2">차량번호</th>
                    <th class="tg-0pky" rowspan="2">차량소속</th>
                    <th class="tg-0pky" colspan="3">소독실시 내용</th>
                    <th class="tg-0pky" colspan="2">소독작업자</th>
                    <th class="tg-0pky" rowspan="2">비고</th>
                </tr>
                <tr>
                    <th class="tg-0pky">소독의 종류</th>
                    <th class="tg-0pky">사용 약품명</th>
                    <th class="tg-0pky">사용량</th>
                    <th class="tg-0pky">성명</th>
                    <th class="tg-0pky">전화번호</th>
                </tr>
            </thead>
            <tbody class="clean_history_tbody">
                
            </tbody>
        </table>
        `;

    let str3 = `
        <table class="tg excelbody clean_history_data" id="excelbody">
            <thead>
                <tr>
                    <th class="tg-0pky">일련번호</th>
                    <th class="tg-0pky">소독제 명칭</th>
                    <th class="tg-0pky">종류</th>
                    <th class="tg-0pky">제조사</th>
                    <th class="tg-0pky">성분 및 농도</th>
                    <th class="tg-0pky">유효기간</th>
                    <th class="tg-0pky">구매일</th>
                    <th class="tg-0pky">재고량 (단위)</th>
                    <th class="tg-0pky">보관 장소</th>
                    <th>비고</th>
                </tr>

            </thead>
            <tbody class="clean_history_tbody">
                
                
               
            </tbody>
        </table>
        `;

    let change_arr = [];

    function compareNumbers(a, b) {
        return a - b;
    }
    async function clean_history_car_add(){
        if(change_arr.length>0){
            
            change_arr.sort(compareNumbers).forEach(function(obj,index){
                let row_arr = [];
                for(var i = 1; i<9; i++){
                    row_arr.push($('.clean_history_tr').eq(obj).children('td').eq(i).children('input').val());
                }
                console.log(row_arr, obj)
                row_arr.push("<%=company%>");
                $.ajax({
                    url:"/cleancaradd",
                    type:"POST",
                    dataType:"JSON",
                    data:`company=<%=company%>&cnt=${obj}&row=${row_arr}`,
                    async:false,
                    success:function(res){
                        console.log(res);
                    }
                });
                
            });
            
        }
    }

    async function clean_history_medi_add(){
        if(change_arr.length>0){
            
            change_arr.sort(compareNumbers).forEach(function(obj,index){
                let row_arr = [];
                for(var i = 1; i<9; i++){
                    row_arr.push($('.clean_history_tr').eq(obj).children('td').eq(i).children('input').val());
                }
                console.log(row_arr, obj)
                row_arr.push("<%=company%>");
                $.ajax({
                    url:"/cleanmediadd",
                    type:"POST",
                    dataType:"JSON",
                    data:`company=<%=company%>&cnt=${obj}&row=${row_arr}`,
                    async:false,
                    success:function(res){
                        console.log(res);
                    }
                });
                
            });
            
        }
    }
    
    function clean_history_car_update(x){
        if(!change_arr.includes($('.clean_history_tr').index($(x).parents('tr')))){
            change_arr.push($('.clean_history_tr').index($(x).parents('tr')));

        }
        console.log(change_arr);
        
    }

    function clean_history_car_del(index){
        axios({
            method:'post',
            url:'/cleancardel',
            data:{
                company:"<%=company%>",
                cnt:index
            }
        }).then(res=>{

        });
    }

    function clean_history_medi_del(index){
        axios({
            method:'post',
            url:'/cleanmedidel',
            data:{
                company:"<%=company%>",
                cnt:index
            }
        }).then(res=>{

        });
    }

    async function clean_history_car_get(){
        return axios({
            method:'post',
            url:'/cleancarget',
            data:{
                company:"<%=company%>",

            }
        }).then(res=>{
            const data = res.data;
            return data;
        });
    }

    async function clean_history_medi_get(){
        return axios({
            method:'post',
            url:'/cleanmediget',
            data:{
                company:"<%=company%>",

            }
        }).then(res=>{
            const data = res.data;
            return data;
        });
    }

    function clean_history_data_change(x){
        change_arr = [];
        Swal.resetValidationMessage();
        $(x).addClass('clean_history_btn_on');
        $('.clean_history_btn').not($(x)).removeClass('clean_history_btn_on');
        $('.clean_history_data').remove();
        
        if($(x).hasClass('data_1')){
            let deny_btn = Swal.getDenyButton();
            $(deny_btn).hide();
            $('.clean_history_data_add').after(str1);
            clean_history_get($('.need_search_input').val()).then(res=>{
                $('.clean_history_tr').remove();
                let str = '';
                let clean_manager = '';
                let clean_data = '';
                let clean_cnum = '';
                let clean_companynumber = '';
                let company_search_arr = [];
                res.data.forEach(function(obj,index){
                    let pname2 = '';
                    for (var j = 0; j < productlistarr.length; j++) {
                        var currentString = productlistarr[j];
                        if (currentString.includes(obj.pcode)) {
                            pname2=currentString.split("|")[0];
                            break
                        }
                    }
                    if(obj.company==obj.companyname){
                        str += `<tr class="clean_history_tr"><td>${index+1}</td><td>${pname2}</td><td>${obj.pcode}-<br/>${obj.bcode}</td><td>${obj.cnum.split(' ')[0].replace(/[^0-9]/g,'')}</td><td>${obj.meditxt}</td><td>${obj.mediname}</td><td>${obj.size}</td><td>${(obj.cleanmanager==null)?'':obj.cleanmanager}</td><td></td><td></td><td></td></tr>`;
                    }else{
                        // clean_manager_get(obj.companyname).then(res2=>{
                        //     console.log('index',res2)
                        //     if(res2.code==201){
                        //         clean_manager = res2.rental[0].cleanmanager;
                        //     }else if(res2.code==202){
                        //         clean_manager = res2.clean[0].cleanmanager;
                        //     }
                            if(obj.date==''||obj.date==null){
                                clean_data = '소독일자 미입력';
                            }else{
                                clean_data = obj.date;
                            }
                            if(obj.cnum==''){
                                clean_cnum = '소독필증 미입력';
                            }else if(obj.cnum=='자동생성'){
                                clean_cnum = "신규품목";
                            }else{
                                clean_cnum = obj.cnum;
                            }
                            if(obj.companynumber==''){
                                clean_companynumber = '사업자등록번호 미입력';
                            }else{
                                clean_companynumber = obj.companynumber;
                            }
                            if(clean_cnum!='신규품목'){
                                str += `<tr class="clean_history_tr"><td></td><td>${pname2}</td><td>${obj.pcode}-<br/>${obj.bcode}</td><td>${clean_data}</td><td></td><td></td><td></td><td>${(obj.cleanmanager==null)?'':obj.cleanmanager}</td><td>${obj.companyname}</td><td>${clean_companynumber}</td><td>${clean_cnum}</td></tr>`;
                            }
                        // });
                    }
                });
                $('.clean_history_manager').before(str);
            });
        }else if($(x).hasClass('data_4')){
            let deny_btn = Swal.getDenyButton();
            $(deny_btn).hide();
            $('.clean_history_data_add').after(str4);
            clean_history_get($('.need_search_input').val()).then(res=>{
                $('.clean_history_tr').remove();
                let str = '';
                let clean_manager = '';
                let clean_data = '';
                let clean_cnum = '';
                let clean_companynumber = '';
                let company_search_arr = [];
                res.data.forEach(function(obj,index){
                    let pname2 = '';
                    for (var j = 0; j < productlistarr.length; j++) {
                        var currentString = productlistarr[j];
                        if (currentString.includes(obj.pcode)) {
                            pname2=currentString.split("|")[0];
                            break
                        }
                    }
                    
                       
                    if(obj.date==''||obj.date==null){
                        clean_data = '소독일자 미입력';
                    }else{
                        clean_data = obj.date;
                    }
                    if(obj.cnum==''){
                        clean_cnum = '소독필증 미입력';
                    }else if(obj.cnum=='자동생성'){
                        clean_cnum = "신규품목";
                    }else{
                        clean_cnum = obj.cnum;
                    }

                    if(obj.meditxt==''||obj.meditxt==null){
                        meditxt = '미입력';
                    }else{
                        meditxt = obj.meditxt;
                    }

                    if(obj.mediname==''||obj.mediname==null){
                        mediname = '미입력';
                    }else{
                        mediname = obj.mediname;
                    }

                    if(obj.size==''||obj.size==null){
                        medisize = '미입력';
                    }else{
                        medisize = obj.size;
                    }
                    
                    if(obj.companynumber==''){
                        clean_companynumber = '사업자등록번호 미입력';
                    }else{
                        clean_companynumber = obj.companynumber;
                    }

                    if(clean_cnum!='신규품목'){
                        str += `<tr class="clean_history_tr"><td>${index+1}</td><td>${clean_data}</td><td>${pname2}</td><td>${obj.pcode}-<br/>${obj.bcode}</td><td>${meditxt}</td><td>${mediname}</td><td>${medisize}</td><td><%=company%></td><td>${companynumber}</td><td>${clean_cnum}</td></tr>`;
                    }
                       
                    
                });
                $('.clean_history_manager').before(str);
            });
        }else if($(x).hasClass('data_2')){
            let deny_btn = Swal.getDenyButton();
            $(deny_btn).show();
            Swal.showDenyButton = false;
            $('.clean_history_data_add').after(str2);
            let str = '';
            clean_history_car_get().then(res=>{
                console.log(res);
                if(res.code==200){
                    
                    res.data.forEach(function(obj,index){
                        str += `
                        <tr class="clean_history_tr">
                            <td><input type="text" class="clean_history_data_add" onchange="clean_history_car_update(this)" value="${obj.num}"></td>
                            <td><input type="text" class="clean_history_data_add" onchange="clean_history_car_update(this)" value="${obj.cleandate}"></td>
                            <td><input type="text" class="clean_history_data_add" onchange="clean_history_car_update(this)" value="${obj.carnum}"></td>
                            <td><input type="text" class="clean_history_data_add" onchange="clean_history_car_update(this)" value="${obj.cartype}"></td>
                            <td><input type="text" class="clean_history_data_add" onchange="clean_history_car_update(this)" value="${obj.meditype}"></td>
                            <td><input type="text" class="clean_history_data_add" onchange="clean_history_car_update(this)" value="${obj.mediname}"></td>
                            <td><input type="text" class="clean_history_data_add" onchange="clean_history_car_update(this)" value="${obj.medisize}"></td>
                            <td><input type="text" class="clean_history_data_add" onchange="clean_history_car_update(this)" value="${obj.name}"></td>
                            <td><input type="text" class="clean_history_data_add" onchange="clean_history_car_update(this)" value="${obj.phone}"></td>
                            <td onclick="row_delete(this);" style="cursor:pointer;"><div>삭제</div></td>
                        </tr>`;
                    });
                    
                }
                str+=`
                <tr class="clean_history_tr">
                    <td class=""></td>
                    <td><input type="text" class="clean_history_data_add" onchange="clean_history_car_update(this)"></td>
                    <td><input type="text" class="clean_history_data_add" onchange="clean_history_car_update(this)"></td>
                    <td><input type="text" class="clean_history_data_add" onchange="clean_history_car_update(this)"></td>
                    <td><input type="text" class="clean_history_data_add" onchange="clean_history_car_update(this)"></td>
                    <td><input type="text" class="clean_history_data_add" onchange="clean_history_car_update(this)"></td>
                    <td><input type="text" class="clean_history_data_add" onchange="clean_history_car_update(this)"></td>
                    <td><input type="text" class="clean_history_data_add" onchange="clean_history_car_update(this)"></td>
                    <td><input type="text" class="clean_history_data_add" onchange="clean_history_car_update(this)"></td>
                    <td onclick="row_delete(this);" style="cursor:pointer;"><div>삭제</div></td>
                </tr>
                `;
                $('.clean_history_tbody').append(str);
                $('.clean_history_tr').each(function(i){
                    $(this).children('td').eq(0).text(i+1);
                });
            });
            
            document.addEventListener('input', function (event) {
                if (event.target.classList.contains('clean_history_data_add')) {
                    const row = event.target.closest('tr');
                    const inputs = row.querySelectorAll('.clean_history_data_add');
                    const isLastRow = row === document.querySelector('.clean_history_tbody tr:last-child');

                    if (Array.from(inputs).some(input => input.value.trim() !== '') && isLastRow) {
                        // Clone the row and clear input values
                        const newRow = row.cloneNode(true);
                        newRow.querySelectorAll('.clean_history_data_add').forEach(input => input.value = '');

                        // Update the row number
                        const rowCount = document.querySelectorAll('.clean_history_tbody tr').length;
                        newRow.querySelector('td:first-child').textContent = rowCount + 1;

                        // Append the new row
                        document.querySelector('.clean_history_tbody').appendChild(newRow);
                    }
                }
            });
        }else if($(x).hasClass('data_3')){
            let deny_btn = Swal.getDenyButton();
            $(deny_btn).show();
            $('.clean_history_data_add').after(str3);

            let str = '';
            clean_history_medi_get().then(res=>{
                console.log(res);
                if(res.code==200){
                    
                    res.data.forEach(function(obj,index){
                        str += `
                        <tr class="clean_history_tr">
                            <td class=""></td>
                            <td><input type="text" class="clean_history_data_add" onchange="clean_history_car_update(this)" value="${obj.mediname}"></td>
                            <td><input type="text" class="clean_history_data_add" onchange="clean_history_car_update(this)" value="${obj.meditype}"></td>
                            <td><input type="text" class="clean_history_data_add" onchange="clean_history_car_update(this)" value="${obj.medicompany}"></td>
                            <td><input type="text" class="clean_history_data_add" onchange="clean_history_car_update(this)" value="${obj.mediinfo}"></td>
                            <td><input type="text" class="clean_history_data_add" onchange="clean_history_car_update(this)" value="${obj.mediperiod}"></td>
                            <td><input type="text" class="clean_history_data_add" onchange="clean_history_car_update(this)" value="${obj.medibuydate}"></td>
                            <td><input type="text" class="clean_history_data_add" onchange="clean_history_car_update(this)" value="${obj.medicnt}"></td>
                            <td><input type="text" class="clean_history_data_add" onchange="clean_history_car_update(this)" value="${obj.medisafe}"></td>
                            <td onclick="row_delete(this);" style="cursor:pointer;"><div>삭제</div></td>
                        </tr>`;
                    });
                    
                }
                str+=`
                <tr class="clean_history_tr">
                    <td class=""></td>
                    <td><input type="text" class="clean_history_data_add" onchange="clean_history_car_update(this)"></td>
                    <td><input type="text" class="clean_history_data_add" onchange="clean_history_car_update(this)"></td>
                    <td><input type="text" class="clean_history_data_add" onchange="clean_history_car_update(this)"></td>
                    <td><input type="text" class="clean_history_data_add" onchange="clean_history_car_update(this)"></td>
                    <td><input type="text" class="clean_history_data_add" onchange="clean_history_car_update(this)"></td>
                    <td><input type="text" class="clean_history_data_add" onchange="clean_history_car_update(this)"></td>
                    <td><input type="text" class="clean_history_data_add" onchange="clean_history_car_update(this)"></td>
                    <td><input type="text" class="clean_history_data_add" onchange="clean_history_car_update(this)"></td>

                    <td onclick="row_delete(this);" style="cursor:pointer;"><div>삭제</div></td>
                </tr>
                `;
                $('.clean_history_tbody').append(str);
                $('.clean_history_tr').each(function(i){
                    $(this).children('td').eq(0).text(i+1);
                });
            });
            
            document.addEventListener('input', function (event) {
                if (event.target.classList.contains('clean_history_data_add')) {
                    const row = event.target.closest('tr');
                    const inputs = row.querySelectorAll('.clean_history_data_add');
                    const isLastRow = row === document.querySelector('.clean_history_tbody tr:last-child');

                    if (Array.from(inputs).some(input => input.value.trim() !== '') && isLastRow) {
                        // Clone the row and clear input values
                        const newRow = row.cloneNode(true);
                        newRow.querySelectorAll('.clean_history_data_add').forEach(input => input.value = '');

                        // Update the row number
                        const rowCount = document.querySelectorAll('.clean_history_tbody tr').length;
                        newRow.querySelector('td:first-child').textContent = rowCount + 1;

                        // Append the new row
                        document.querySelector('.clean_history_tbody').appendChild(newRow);
                    }
                }
            });
        }
    }

    function clean_history(){
        Swal.fire({
            title: '소독관리',
            width:'75%',
            html:`
            <div class="clean_history">
                <div class="flex">
                    <div class="clean_history_btn flex clean_history_btn_on data_1" onclick="clean_history_data_change(this)">소독일지</div>
                    <div class="clean_history_btn flex data_4" onclick="clean_history_data_change(this)">수탁소독실시대장</div>
                    <div class="clean_history_btn flex data_2" onclick="clean_history_data_change(this)">차량소독일지</div>
                    <div class="clean_history_btn flex data_3" onclick="clean_history_data_change(this)">소독제관리</div>
                </div>
                <br class="clean_history_data_add"/>
            </div>
            `,
            focusConfirm: false,
            showCancelButton: true,
            showDenyButton:false,
            denyButtonText:' 저장 ',
            denyButtonColor:'rgb(48, 133, 214)',
            confirmButtonColor: 'rgb(13, 105, 41)',
            cancelButtonColor: '#d33',
            confirmButtonText: '엑셀변환',
            cancelButtonText: '취소',
            allowOutsideClick:false,
            didOpen: () => {
                $('.clean_history_data_add').after(str1);
                clean_history_get($('.need_search_input').val()).then(res=>{
                    $('.clean_history_tr').remove();
                    let str = '';
                    let clean_manager = '';
                    let clean_data = '';
                    let clean_cnum = '';
                    let clean_companynumber = '';
                    let company_search_arr = [];
                    res.data.forEach(function(obj,index){
                        let pname2 = '';
                        for (var j = 0; j < productlistarr.length; j++) {
                            var currentString = productlistarr[j];
                            if (currentString.includes(obj.pcode)) {
                                pname2=currentString.split("|")[0];
                                break
                            }
                        }
                        if(obj.company==obj.companyname){
                            str += `<tr class="clean_history_tr"><td>${index+1}</td><td>${pname2}</td><td>${obj.pcode}-<br/>${obj.bcode}</td><td>${obj.cnum.split(' ')[0].replace(/[^0-9]/g,'')}</td><td>${obj.meditxt}</td><td>${obj.mediname}</td><td>${obj.size}</td><td>${(obj.cleanmanager==null)?'':obj.cleanmanager}</td><td></td><td></td><td></td></tr>`;
                        }else{
                            // clean_manager_get(obj.companyname).then(res2=>{
                            //     console.log('index',res2)
                            //     if(res2.code==201){
                            //         clean_manager = res2.rental[0].cleanmanager;
                            //     }else if(res2.code==202){
                            //         clean_manager = res2.clean[0].cleanmanager;
                            //     }
                                if(obj.date==''||obj.date==null){
                                    clean_data = '소독일자 미입력';
                                }else{
                                    clean_data = obj.date;
                                }
                                if(obj.cnum==''){
                                    clean_cnum = '소독필증 미입력';
                                }else if(obj.cnum=='자동생성'){
                                    clean_cnum = "신규품목";
                                }else{
                                    clean_cnum = obj.cnum;
                                }
                                if(obj.companynumber==''){
                                    clean_companynumber = '사업자등록번호 미입력';
                                }else{
                                    clean_companynumber = obj.companynumber;
                                }
                                if(clean_cnum!='신규품목'){
                                    str += `<tr class="clean_history_tr"><td>${index+1}</td><td>${pname2}</td><td>${obj.pcode}-<br/>${obj.bcode}</td><td>${clean_data}</td><td></td><td></td><td></td><td>${(obj.cleanmanager==null)?'':obj.cleanmanager}</td><td>${obj.companyname}</td><td>${clean_companynumber}</td><td>${clean_cnum}</td></tr>`;
                                }
                            // });
                        }
                    });
                    $('.clean_history_manager').before(str);
                });
            },
            preDeny:()=>{
                if(change_arr.length>0){
                    if($('.clean_history_btn_on').hasClass('data_2')){
                        clean_history_car_add();
                    }else if($('.clean_history_btn_on').hasClass('data_3')){
                        clean_history_medi_add();
                    }

                    
                    change_arr = [];
                    // Swal.showValidationMessage(`
                    //     저장완료:내역이 변경되었습니다.
                    // `);
                    return false;
                }else{
                    Swal.showValidationMessage(`
                        저장실패:변경된 내역이 없습니다.
                    `);
                    return false;
                }
            },
        }).then((result) => {
            if (result.isConfirmed) {
                if($('.clean_history_btn_on').hasClass('data_2')){
                    Swal.fire("준비중입니다",'','info');
                }else if($('.clean_history_btn_on').hasClass('data_3')){
                    Swal.fire("준비중입니다",'','info');
                }else{
                    exelchange();
                }
                
            }
        });
    }

    async function durability_get(){
        return axios({
            method:'post',
            url:'/DurabilityGet',
            data:{
                company:"<%=company%>"
            }
        }).then(res=>{
            const data = res.data;
            return data;
        });
    }

    function dateFormat(date) {
        let month = date.getMonth() + 1;
        let day = date.getDate();
        let hour = date.getHours();
        let minute = date.getMinutes();
        let second = date.getSeconds();

        month = month >= 10 ? month : '0' + month;
        day = day >= 10 ? day : '0' + day;
        hour = hour >= 10 ? hour : '0' + hour;
        minute = minute >= 10 ? minute : '0' + minute;
        second = second >= 10 ? second : '0' + second;

        return date.getFullYear() + '-' + month + '-' + day;
    }

    function table_sort(){
        var headers = document.querySelectorAll('.sortable');
        headers.forEach(function(header) {
            header.addEventListener('click', function() {
                var column = this.dataset.column;
                var order = this.dataset.order = (this.dataset.order === 'desc' ? 'asc' : 'desc');
                var tbody = this.closest('table').querySelector('tbody');
                var rows = Array.from(tbody.querySelectorAll('tr'));
                var arrow = order === 'asc' ? '▲' : '▼';

                // 화살표 표시를 제거
                headers.forEach(function(header) {
                    header.innerHTML = header.innerHTML.replace(' ▲', '').replace(' ▼', '');
                });

                // 현재 클릭한 헤더에 화살표 추가
                this.innerHTML += ' ' + arrow;

                rows.sort(function(a, b) {
                    var aValue = a.querySelector('td[data-column="' + column + '"]').textContent.trim();
                    var bValue = b.querySelector('td[data-column="' + column + '"]').textContent.trim();
                    
                    // 값이 날짜 형식인 경우 Date 객체로 변환
                    if (!isNaN(Date.parse(aValue)) && !isNaN(Date.parse(bValue))) {
                        aValue = new Date(aValue);
                        bValue = new Date(bValue);
                        return order === 'asc' ? aValue - bValue : bValue - aValue;
                    }else{
                        return order === 'asc' ? aValue.localeCompare(bValue) : bValue.localeCompare(aValue);

                    }
                });

                tbody.innerHTML = '';
                rows.forEach(function(row) {
                    tbody.appendChild(row);
                });
            });
        });


        
    }

    function table_search2(x,id,tr){
            console.log($(x)[0].value);
            var data = $(x)[0].value.split(" ");
            if ($(x)[0].value == "") {
                $("."+tr).show();
                return;
            }
            $("."+tr).hide();
            
            $("."+tr).filter(function (i, v) {
                var $t = $(this);
                for (var d = 0; d < data.length; ++d) {
                    if ($t.is(":contains('" + data[d] + "')")||$t.is(":contains('" + data[d].toUpperCase() + "')")||$t.is(":contains('" + data[d].toLowerCase() + "')")) {
                        return true;
                    }
                }
                return false;
            }).show();
    }
    
    function contract_alert(){
        Swal.fire({
            title:'자격변동수급자 목록',
            width:'60%',
            html:`
            <div class="contract_alert_table_area">
                <table class="contract_alert_table">
                    <thead>
                        <tr>
                            <th>변동일</th>
                            <th>성함</th>
                            <th>인정번호</th>
                            <th>이전</th>
                            <th>이후</th>
                            <th>품목명</th>
                            <th>제품명</th>
                            <th>제품코드</th>
                            <th>바코드</th>
                        </tr>
                    </thead>
                    <tbody class="contract_alert_table_tbody">
                        <tr>
                            
                        </tr>
                    </tbody>
                </table>
            </div>
            `
        })

        socket_start();
        socket.emit('login', {'name': uid});
        socket.emit('go_lookup_contract_alert_req', { 'name':uid,'date':'20240527','company':'(수)복지용구의료기3'});

    }


    function rent_durability(){
        Swal.fire({
            title: '내구연한관리',
            width:'90%',
            html:`
            <div class="durablility_top">
                <div class="flex">누적품목:<div class="durabililty_top_cnt"></div>개<div><input type="text" id="form4" class="durability_search" placeholder="바코드입력" onkeyup="table_search(this,'#form4','durability_tr1')"></div></div>
                <div class="flex">만료품목:<div class="durabililty_top_cnt"></div>개<div><input type="text" id="form5" class="durability_search" placeholder="바코드입력" onkeyup="table_search(this,'#form5','durability_tr2')"></div></div>
            </div>
            <div class="durability_history">
                <table class="tg excelbody durability_history_data" id="excelbody">
                    <thead>
                        <tr>
                            <th class="tg-0pky sortable" data-column="등록일">등록일</th>
                            <th class="tg-0pky sortable" data-column="만료일">만료일</th>
                            <th class="tg-0pky sortable" data-column="품목">품목</th>
                            <th class="tg-0pky sortable" data-column="제품명">제품명</th>
                            <th class="tg-0pky sortable" data-column="품목코드">품목코드</th>
                            <th class="tg-0pky sortable" data-column="바코드">바코드</th>
                        </tr>
                    </thead>
                    <tbody class="durability_history_tbody">

                    </tbody>
                </table>
                <div class="flexcolumns" style="width:100%;">
                    <table class="tg excelbody durability_history_data2" id="excelbody">
                        <thead>
                            <tr>
                                <th class="tg-0pky sortable" data-column="등록일">등록일</th>
                                <th class="tg-0pky sortable" data-column="만료일">만료일</th>
                                <th class="tg-0pky sortable" data-column="품목">품목</th>
                                <th class="tg-0pky sortable" data-column="제품명">제품명</th>
                                <th class="tg-0pky sortable" data-column="품목코드">품목코드</th>
                                <th class="tg-0pky sortable" data-column="바코드">바코드</th>
                            </tr>
                        </thead>
                        <tbody class="durability_history_tbody2">

                        </tbody>
                    </table>
                    <div class="flex" style="font-weight:bold; font-size:18px;">만료예정품목(+3개월):<div class="durabililty_top_cnt"></div>개<div><input type="text" id="form6" class="durability_search" placeholder="바코드입력" onkeyup="table_search(this,'#form6','durability_tr3')"></div></div>
                    <table class="tg excelbody durability_history_data3" id="excelbody">
                        <thead>
                            <tr>
                                <th class="tg-0pky sortable" data-column="등록일">등록일</th>
                                <th class="tg-0pky sortable" data-column="만료일">만료일</th>
                                <th class="tg-0pky sortable" data-column="품목">품목</th>
                                <th class="tg-0pky sortable" data-column="제품명">제품명</th>
                                <th class="tg-0pky sortable" data-column="품목코드">품목코드</th>
                                <th class="tg-0pky sortable" data-column="바코드">바코드</th>
                            </tr>
                        </thead>
                        <tbody class="durability_history_tbody3">

                        </tbody>
                    </table>
                </div>
            </div>
            `,
            focusConfirm: false,
            showCancelButton: true,
            showConfirmButton:false,
            showDenyButton:false,
            denyButtonText:' 저장 ',
            denyButtonColor:'rgb(48, 133, 214)',
            confirmButtonColor: 'rgb(13, 105, 41)',
            cancelButtonColor: '#d33',
            confirmButtonText: '엑셀변환',
            cancelButtonText: '취소',
            allowOutsideClick:false,
            didOpen: () => {
                let str = '';
                let str2 = '';
                let str3 = '';
                durability_get().then(res=>{
                    if(res.code==200){
                        
                        let salecnt = 5;
                        let pname1 = '';
                        let pname2 = '';
                        let cnt1 = '';
                        let cnt2 = '';
                        let cnt3 = '';
                        res.data.forEach(function(obj,index){
                            let newsaledates = new Date(obj.date);
                            for (var j = 0; j < productlistarr.length; j++) {
                                var currentString = productlistarr[j];
                                if (currentString.includes(obj.pcode)) {
                                    pname1=currentString.split("|")[2];
                                    pname2=currentString.split("|")[0];
                                    if(pname2=='전동침대')salecnt=10;
                                    else if(pname2=='욕창예방 매트리스')salecnt=3;
                                    else if(pname2=='수동휠체어')salecnt=5;
                                    newsaledates.setFullYear(newsaledates.getFullYear() + salecnt);
                                    newsaledates.setDate(newsaledates.getDate() - 1);
                                    newsaledates = dateFormat(newsaledates);
                                    break
                                }
                            }
                            if(obj.date!=''){
                                cnt1++;
                                str += `
                                <tr class="durability_history_data_add durability_tr1">
                                    <td data-column="등록일">${obj.date}</td>
                                    <td data-column="만료일">${newsaledates}</td>
                                    <td data-column="품목">${pname2}</td>
                                    <td data-column="제품명">${pname1}</td>
                                    <td data-column="품목코드">${obj.pcode}</td>
                                    <td data-column="바코드">${obj.bcode}</td>
                                </tr>`;
                                let date_now = new Date();
                                if(date_now>=new Date(newsaledates)){
                                    cnt2++;
                                    str2 += `
                                    <tr class="durability_history_data_add durability_tr2">
                                        <td data-column="등록일">${obj.date}</td>
                                        <td data-column="만료일">${newsaledates}</td>
                                        <td data-column="품목">${pname2}</td>
                                        <td data-column="제품명">${pname1}</td>
                                        <td data-column="품목코드">${obj.pcode}</td>
                                        <td data-column="바코드">${obj.bcode}</td>
                                    </tr>`;
                                }else if(date_now<=new Date(newsaledates)&&new Date(newsaledates)<=date_now.setMonth(date_now.getMonth() + 3)){
                                    cnt3++;
                                    str3 += `
                                    <tr class="durability_history_data_add durability_tr3">
                                        <td data-column="등록일">${obj.date}</td>
                                        <td data-column="만료일">${newsaledates}</td>
                                        <td data-column="품목">${pname2}</td>
                                        <td data-column="제품명">${pname1}</td>
                                        <td data-column="품목코드">${obj.pcode}</td>
                                        <td data-column="바코드">${obj.bcode}</td>
                                    </tr>`;
                                }
                            }
                        });
                        $('.durability_history_tbody').append(str);
                        $('.durabililty_top_cnt').eq(0).text(cnt1);
                        $('.durability_history_tbody2').append(str2);
                        $('.durabililty_top_cnt').eq(1).text(cnt2);
                        $('.durability_history_tbody3').append(str3);
                        $('.durabililty_top_cnt').eq(2).text(cnt3);
                        table_sort();
                        $('.durability_history_data2').children('thead').children('tr').children('th').eq(1).click();
                        $('.durability_history_data3').children('thead').children('tr').children('th').eq(1).click().click();
                    }
                });
            }
        }).then((result) => {
            if (result.isConfirmed) {
                
            };
        });

    }

    function video_sign_url_get(video_name){
        $('.rent_video').remove();
        let str = `
            <video class="rent_video ${video_name}" width="1250px" height="800px" controls>
        `;
        fetch('/S3GetVideo?directory=RentVideo&bucketname=hanq&name='+video_name+'&type=webm') // 서버에서 서명된 URL을 가져오는 엔드포인트로 수정해야 합니다.
        .then(response => response.text())
        .then(url => {
            console.log(url)
            str+=`<source id='Rent_video1' class="Rent_video1" src="${url}" type="video/webm">`;
            str+=`
                </video>
            `;
            $('.video_area').append(str);
        })
        .catch(error => console.error('Error fetching signed URL:', error));
    }

    function guide_on_click(obj,video_name){
        $(obj).addClass("guide_on");
        $('.guide_swal_button').not($(obj)).removeClass("guide_on");
        video_sign_url_get(video_name);
    }

    function guide_show(){
        Swal.fire({
            width:"90%",
            icon: 'info',
            title: '화면 학습 선택',
            html: `
            <div class="guide_swal" style="flex-direction:column;">
                <div style="display:flex; justify-content:space-around; width:100%;">
                    <div class="guide_swal_button guide_on" onclick="guide_on_click(this,'Rent_video1')" style="font-size:18px;">1.대여관리 설명</div>
                    <div class="guide_swal_button" onclick="guide_on_click(this,'Rent_video2')" style="font-size:18px;">2.수급자 검색</div>
                    <div class="guide_swal_button" onclick="guide_on_click(this,'Rent_video3')" style="font-size:18px;">3.대여연장계약</div>
                    <div class="guide_swal_button" onclick="guide_on_click(this,'Rent_video4')" style="font-size:18px;">4.대여중지계약(병원입원)</div>
                    <div class="guide_swal_button" onclick="guide_on_click(this,'Rent_video5')" style="font-size:18px;">5.대여중지재시작</div>
                    <div class="guide_swal_button" onclick="guide_on_click(this,'Rent_video6')" style="font-size:18px;">6.대여중지취소</div>
                </div>
                <br/>
                <div style="display:flex; justify-content:space-around; width:100%;">
                    <div class="guide_swal_button" onclick="guide_on_click(this,'Rent_video7')" style="font-size:18px;">7.대여회수등록</div>
                    <div class="guide_swal_button" onclick="guide_on_click(this,'Rent_video8')" style="font-size:18px;">8.대여계약취소</div>
                    <div class="guide_swal_button" onclick="guide_on_click(this,'Rent_video9')" style="font-size:18px;">9.상세검색</div>
                    <div class="guide_swal_button" onclick="guide_on_click(this,'Rent_video10')" style="font-size:18px;">10.수급자문자발송</div>
                    <div class="guide_swal_button" onclick="guide_on_click(this,'Rent_video11')" style="font-size:18px;">11.대여알림톡발송</div>
                    <div class="guide_swal_button" onclick="guide_on_click(this,'Rent_video12')" style="font-size:18px;">12.급여제공기록지발송</div>
                    <div class="guide_swal_button" onclick="guide_on_click(this,'Rent_video13')" style="font-size:18px;">13.문자발송내역</div>
                </div>
            </div>
            <br/>
            <div class="video_area" style="height:900px;">
                
            </div>

            `,
            showConfirmButton:false,
            didOpen:()=>{
                video_sign_url_get("Rent_video1");
            }
        });
    }

    function excel_download(page,username,dates,datee,query,rrentstatus,ccmsstatus,ccontract,ddelivery,pproduct,ccentername,mmanager,pphone,bbcode){
        //socket.emit('login', {'name': uid});
        if(dates=='2020-01-01'){
            $('.clientupbtn').removeClass('don');
            $('.clientupbtn').addClass('doff');
        }
        
        $.ajax({
            url:"/rentlookupexcel",
            data:"company="+company+'&page='+page+'&username='+username+'&dates='+dates+'&datee='+datee+'&query='+query+'&rentstatus='+rrentstatus+'&cmsstatus='+ccmsstatus+'&contract='+ccontract+'&delivery='+ddelivery+'&product='+pproduct+'&centername='+ccentername+'&manager='+mmanager+'&phone='+pphone+'&bcode='+bbcode.replace(/ /g,''),
            type:'POST',
            dataType:"JSON",
            async:true,
            success:function(results){
                console.log(results);
                if(results.code==200){
                    // 엑셀 파일 생성 및 다운로드
                    let workbook = XLSX.utils.book_new();
                    
                    // 필요한 필드만 추출
                    const filteredData = results.rows.map(row => {
                        let productCode = '';
                        let productName = '';
                        
                        if (row.productname.includes(',')) {
                            const commaParts = row.productname.split(',');
                            let codes = [];
                            let names = [];
                            
                            commaParts.forEach(part => {
                                if (part.includes('|')) {
                                    const pipeParts = part.split('|');
                                    codes.push(pipeParts[0] || '');
                                    names.push(pipeParts[1] || '');
                                }
                            });
                            
                            productCode = codes.join(',');
                            productName = names.join(',');
                        } else if (row.productname.includes('|')) {
                            const productParts = row.productname.split('|');
                            productCode = productParts[0] || '';
                            productName = productParts[1] || '';
                        }
                        
                        return {
                            "등록일": row.orderdate.split(' ')[0],
                            "성함": row.name,
                            "인정번호": row.number,
                            "생년월일": row.regident,
                            "대상": row.target,
                            "등급": row.ranker,
                            "본인부담율": row.sale,
                            "품목코드": productCode,
                            "품목명": productName,
                            "대여시작일": row.rentstart,
                            "대역종료일": row.rentend,
                            "주소": row.address,
                            "보호자성함": row.guardname,
                            "관계": (row.guardtarget=='null'||row.guardtarget==null)?'본인':row.guardtarget,
                            "연락처1": row.phone,
                            "센터명": row.center,
                            "담당자": row.manager,
                            "배송상태": (row.status=="wait")?'배송중':(row.status=="backend")?'회수완료':(row.status=="back")?'회수중':'배송완료',
                            "공단계약": (row.chk=="ok")?'공단계약완료':(row.chk=="cok")?'취소계약완료':'공단미계약',
                            "대여상태": (row.rentchk=="y")?'대여중':(row.rentchk=="n")?'회수':'대여중지',
                            "바코드": row.buybcode,
                            // "CMS상태": row.cmschk
                        };
                    });
                    
                    // 데이터 시트 생성
                    let worksheet = XLSX.utils.json_to_sheet(filteredData);
                    
                    // 열 너비 설정
                    const wscols = [
                        {wch: 15}, // orderdate
                        {wch: 12}, // name
                        {wch: 15}, // number
                        {wch: 15}, // regident
                        {wch: 12}, // target
                        {wch: 10}, // ranker
                        {wch: 10}, // sale
                        {wch: 15}, // productname
                        {wch: 15}, // rentstart
                        {wch: 15}, // rentend
                        {wch: 20}, // addres
                        {wch: 12}, // guardname
                        {wch: 12}, // guardtarget
                        {wch: 15}, // phone
                        {wch: 15}, // center
                        {wch: 12}, // manager
                        {wch: 15}, // deliverymanager
                        {wch: 10}, // status
                        {wch: 10}, // chk
                        {wch: 10}, // rentchk
                        {wch: 15}, // buybcode
                        {wch: 10}  // cmschk
                    ];
                    
                    worksheet['!cols'] = wscols;
                    
                    // 워크북에 시트 추가
                    XLSX.utils.book_append_sheet(workbook, worksheet, "대여관리");
                    
                    // 파일명 생성 (현재 날짜 포함)
                    const today = new Date();
                    const fileName = `대여관리_${today.getFullYear()}${(today.getMonth()+1).toString().padStart(2, '0')}${today.getDate().toString().padStart(2, '0')}.xlsx`;
                    
                    // 엑셀 파일 다운로드
                    XLSX.writeFile(workbook, fileName);
                    
                    // 다운로드 완료 알림
                    Swal.fire({
                        icon: 'success',
                        title: '엑셀 다운로드 완료',
                        text: '엑셀 파일이 다운로드 되었습니다.',
                        timer: 2000,
                        showConfirmButton: false
                    });
                }
            }
        });
    }

</script>

<body>
 
    <!-- <div class="topline mobile"></div> -->
    <div class="pc" style="display:none;">
        <%- include('mobilemenu') %>
    </div>
    <a style="display:none;" class="btn" data-popup-open="popup-1" href="#">Open Popup #1</a>
    <a style="display:none;" class="btn" data-popup-open2="popup-2" href="#">Open Popup #1</a>
    <div class="maincontainer">
        <div class="guide_show mobile" onclick="guide_show()">화면 학습 하기</div>
        <h1 class="title"><span class="material-icons">accessible_forward</span>&nbsp;&nbsp;&nbsp;&nbsp;<%= title %></h1>

        <div>
            <div class="search-form">
                <input type="text" class="search-bar" name="query" placeholder=" 검색어를 입력하세요." onkeyup="enterkey(this)">
                <input type="submit" class="search-button material-icons" value="search" onclick="rentlookup(1,uid,'1999-01-01','2029-01-01',$(this).prev().val(),rentstatus,cmsstatus,contract,delivery,product,centername,manager,phone,bcode);">
                <input type="button" class="search-button material-icons search-detail-button" value="manage_search" onclick="detailsearch()">
            </div>
            <div class="filterarr"></div>
            <div style="display:none;" class="searchdetail">
                <div>
                    <table>
                        <tr>
                            <td class="flexbetween"><span class="material-icons">watch_later</span>검색일자</td><td><input type="date"></td><td>~</td><td><input type="date"></td>
                        </tr>
                        <tr>
                            <td class="flexbetween"><span class="material-icons">people_alt</span>수급자</td><td><input type="text"></td>
                        </tr>
                        <tr>
                            <td class="flexbetween"><span class="material-icons">category</span>품목</td><td><input type="text"></td>
                        </tr>
                        <tr>
                            <td class="flexbetween"><span class="material-icons">phone_in_talk</span>담당자</td><td><input type="text"></td>
                        </tr>
                        <tr>
                            <td class="flexbetween"><span class="material-icons">elderly_woman</span>센터명</td><td><input type="text"></td>
                        </tr>
                    </table>
                    <div class="flex">
                        <span>상세 검색하기</span>
                    </div>
                </div>
            </div>
        </div>

        <table class="topmenu">
            <tr>
                <td class="clientup">
                    <input class="date1 datepickerall" type="text" id="datepicker" autocomplete='off' value="2022-01-01">
                    ~
                    <input class="date2 datepickerall" type="text" id="datepicker2" autocomplete='off'>
                    <span onclick="datesearch();">날짜조회</span>&nbsp;&nbsp;&nbsp;
                    <span class="mobile" onclick="sendmsg()">문자발송</span>
                    <span class="mobile" onclick="sendmsg_history2()">발송내역</span>
                    <span class="mobile" onclick="clean_history()">소독관리</span>
                    <span class="mobile" onclick="rent_durability()">내구연한관리</span>
                    <!--span class="" onclick="contract_alert()">자격변동수급자</span-->
                    <span class="mobile" style="background: rgb(48, 110, 72); border:none;" onclick="excel_download(1,uid,$('#datepicker').val(),$('#datepicker2').val(),'',rentstatus,cmsstatus,contract,delivery,product,centername,manager,phone,bcode)"><img src="/img/excelico.png">엑셀변환</span>
                </td>
                <td style="display:none;" class="clientup"><span>대여 등록하기</span></td>
                <td class="mobile"><span class="material-icons" style="color:#00923d">change_history</span>:<span>취소계약완료</span>&nbsp;<span class="material-icons" style="color:#00923d">done</span>:<span>공단계약완료</span>&nbsp;<span class="material-icons" style="color:#ff0000">clear</span>:<span>공단미계약</span></td>
            </tr>
        </table>

        <table class="table table-bordered renttable">
            <tr class="tablemenu orderpagingtr">
                
            </tr>
            <tr class="center tablemenu borderblack">
                <td style="display:none;" class="mobile"><!--input type="checkbox" class="listcheckbox allchk" onclick="allchk(this)"--></td>
                <td>등록일자</td>
                <td>수급자성함</td>
                <td>인정번호</td>
                <!--td class="mobile">생년월일</td-->
                <td class="mobile">대상</td>
                <!--td class="mobile">등급</td-->
                <!--td class="mobile">본인부담율</td-->
                <td>품목명</td>
                <td>대여시작일</td>
                <td>대여종료일</td>
                <td class="mobile" style="width:150px;">배송/설치주소</td>
                <td class="mobile">보호자성함</td>
                <!--td class="mobile">관계</td-->
                <!--td class="mobile">연락처</td-->
                <td class="mobile">센터명</td>
                <td class="mobile">담당자</td>
                <td class="mobile">CMS</td>
                <td class="mobile">대대여</td>
                <td class="">대여상태</td>
                <td class="mobile">배송상태</td>
                <td class="">공단계약</td>
            </tr>
            
            
        </table>
    </div>
    <div class="footer">
        <div style="display:none;" class="footerbutton1 flex"><span onclick="">계약서 출력</span><span class="material-icons">print</span></div>
    </div>

    <div class="popup" data-popup="popup-1">
        <div class="popup-inner">
            <iframe name="clientup" src="//localhost:802/rentup/1/<%=username%>" frameborder="0"></iframe>
            <a class="popup-close" data-popup-close="popup-1" href="#">x</a>
        </div>
    </div>

    <div class="popup2" data-popup="popup-2">
        <div class="popup2-inner">
            <iframe class='clientmodify' name="clientmodify" src="" frameborder="0"></iframe>
            <a class="popup2-close" data-popup-close="popup-2">x</a>
        </div>
    </div>

    <div class="popbill_dom">

    </div>

    <script>
        $('.popup2-close').click(function(){
        });

        $(document).ready(function(){
            (function($){
                $.fn.scannerDetection=function(options){

                    // If string given, call onComplete callback
                    if(typeof options==="string"){
                        this.each(function(){
                            this.scannerDetectionTest(options);
                        });
                        return this;
                    }
                    
                    // If false (boolean) given, deinitialize plugin
                    if(options === false){
                        this.each(function(){
                            this.scannerDetectionOff();
                        });
                        return this;
                    }

                    var defaults={
                        onComplete:false, // Callback after detection of a successfull scanning (scanned string in parameter)
                        onError:false, // Callback after detection of a unsuccessfull scanning (scanned string in parameter)
                        onReceive:false, // Callback after receiving and processing a char (scanned char in parameter)
                        onKeyDetect:false, // Callback after detecting a keyDown (key char in parameter) - in contrast to onReceive, this fires for non-character keys like tab, arrows, etc. too!
                        timeBeforeScanTest:100, // Wait duration (ms) after keypress event to check if scanning is finished
                        avgTimeByChar:30, // Average time (ms) between 2 chars. Used to do difference between keyboard typing and scanning
                        minLength:6, // Minimum length for a scanning
                        endChar:[9,13], // Chars to remove and means end of scanning
                        startChar:[], // Chars to remove and means start of scanning
                        ignoreIfFocusOn:false, // do not handle scans if the currently focused element matches this selector
                        scanButtonKeyCode:false, // Key code of the scanner hardware button (if the scanner button a acts as a key itself) 
                        scanButtonLongPressThreshold:3, // How many times the hardware button should issue a pressed event before a barcode is read to detect a longpress
                        onScanButtonLongPressed:false, // Callback after detection of a successfull scan while the scan button was pressed and held down
                        stopPropagation:false, // Stop immediate propagation on keypress event
                        preventDefault:false // Prevent default action on keypress event
                    };
                    if(typeof options==="function"){
                        options={onComplete:options}
                    }
                    if(typeof options!=="object"){
                        options=$.extend({},defaults);
                    }else{
                        options=$.extend({},defaults,options);
                    }
                    
                    this.each(function(){
                        var self=this, $self=$(self), firstCharTime=0, lastCharTime=0, stringWriting='', callIsScanner=false, testTimer=false, scanButtonCounter=0;
                        var initScannerDetection=function(){
                            firstCharTime=0;
                            stringWriting='';
                            scanButtonCounter=0;
                        };
                        self.scannerDetectionOff=function(){
                        $self.unbind('keydown.scannerDetection');
                        $self.unbind('keypress.scannerDetection');
                    }
                    self.isFocusOnIgnoredElement=function(){
                        if(!options.ignoreIfFocusOn) return false;
                        if(typeof options.ignoreIfFocusOn === 'string') return $(':focus').is(options.ignoreIfFocusOn);
                        if(typeof options.ignoreIfFocusOn === 'object' && options.ignoreIfFocusOn.length){
                            var focused=$(':focus');
                            for(var i=0; i<options.ignoreIfFocusOn.length; i++){
                                if(focused.is(options.ignoreIfFocusOn[i])){
                                    return true;
                                }
                            }
                        }
                        return false;
                    }
                    self.scannerDetectionTest=function(s){
                        // If string is given, test it
                        if(s){
                            firstCharTime=lastCharTime=0;
                            stringWriting=s;
                        }

                        if (!scanButtonCounter){
                            scanButtonCounter = 1;
                        }

                        // If all condition are good (length, time...), call the callback and re-initialize the plugin for next scanning
                        // Else, just re-initialize
                        if(stringWriting.length>=options.minLength && lastCharTime-firstCharTime<stringWriting.length*options.avgTimeByChar){
                            if(options.onScanButtonLongPressed && scanButtonCounter > options.scanButtonLongPressThreshold) options.onScanButtonLongPressed.call(self,stringWriting,scanButtonCounter);
                                else if(options.onComplete) options.onComplete.call(self,stringWriting,scanButtonCounter);
                                $self.trigger('scannerDetectionComplete',{string:stringWriting});
                                initScannerDetection();
                                return true;
                            }else{
                                if(options.onError) options.onError.call(self,stringWriting);
                                $self.trigger('scannerDetectionError',{string:stringWriting});
                                initScannerDetection();
                                return false;
                            }
                        }
                        $self.data('scannerDetection',{options:options}).unbind('.scannerDetection').bind('keydown.scannerDetection',function(e){
                            // If it's just the button of the scanner, ignore it and wait for the real input
                            if(options.scanButtonKeyCode !== false && e.which==options.scanButtonKeyCode) {
                                scanButtonCounter++;
                                // Cancel default
                                e.preventDefault();
                                e.stopImmediatePropagation();
                            }
                            // Add event on keydown because keypress is not triggered for non character keys (tab, up, down...)
                            // So need that to check endChar and startChar (that is often tab or enter) and call keypress if necessary
                            else if((firstCharTime && options.endChar.indexOf(e.which)!==-1) 
                            || (!firstCharTime && options.startChar.indexOf(e.which)!==-1)){
                                // Clone event, set type and trigger it
                                var e2=jQuery.Event('keypress',e);
                                e2.type='keypress.scannerDetection';
                                $self.triggerHandler(e2);
                                // Cancel default
                                e.preventDefault();
                                e.stopImmediatePropagation();
                            }
                            // Fire keyDetect event in any case!
                            if(options.onKeyDetect) options.onKeyDetect.call(self,e);
                            $self.trigger('scannerDetectionKeyDetect',{evt:e});
                            
                        }).bind('keypress.scannerDetection',function(e){
                            if (this.isFocusOnIgnoredElement()) return;
                            if(options.stopPropagation) e.stopImmediatePropagation();
                            if(options.preventDefault) e.preventDefault();

                            if(firstCharTime && options.endChar.indexOf(e.which)!==-1){
                                e.preventDefault();
                                e.stopImmediatePropagation();
                                callIsScanner=true;
                            }else if(!firstCharTime && options.startChar.indexOf(e.which)!==-1){
                                e.preventDefault();
                                e.stopImmediatePropagation();
                                callIsScanner=false;
                            }else{
                                if (typeof(e.which) != 'undefined'){
                                    stringWriting+=String.fromCharCode(e.which);
                                }
                                callIsScanner=false;
                            }

                            if(!firstCharTime){
                                firstCharTime=Date.now();
                            }
                            lastCharTime=Date.now();

                            if(testTimer) clearTimeout(testTimer);
                            if(callIsScanner){
                                self.scannerDetectionTest();
                                testTimer=false;
                            }else{
                                testTimer=setTimeout(self.scannerDetectionTest,options.timeBeforeScanTest);
                            }

                            if(options.onReceive) options.onReceive.call(self,e);
                            $self.trigger('scannerDetectionReceive',{evt:e});
                        });
                    });
                    return this;
                }
            })(jQuery);

            var bcodeopen = 'n';
            var pcodechk = '';
            var scanmode = 0;
            $(document).scannerDetection({ 
                timeBeforeScanTest: 200, // wait for the next character for upto 200ms 
                startChar: [120], // Prefix character for the cabled scanner (OPL6845R) 
                endChar: [13], // be sure the scan is complete if key 13 (enter) is detected 
                avgTimeByChar: 40, // it's not a barcode if a character takes longer than 40ms 
                onComplete: function(barcode2, qty){
                    var chk = 0;
                    var chk2 = 0;
                    var barcode = barcode2;
                    var hlist = ['ㅃ','ㅉ','ㄸ','ㄲ','ㅆ','ㅁ','ㄴ','ㅇ','ㄹ','ㅎ','ㅗ','ㅔ'];
                    var elist = ['Q','W','E','R','T','A','S','D','F','G','H','P'];
                    $.each(hlist,function(i){
                        barcode = barcode.replace(hlist[i],elist[i]);
                    });
                    rentlookup(1,uid,'19990101','20990101','','','','','','','','','',barcode.substr(12, 23),"");
                }
            }); 
        });
    </script>
    <div class="mobile">
        <%- include('channeltalk') %>
    </div>
    <div class="pc">
        <%- include('mobilefoot') %>
    </div>
</body>
</html>